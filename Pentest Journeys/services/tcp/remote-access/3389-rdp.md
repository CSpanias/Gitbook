# 3389 - RDP

Remote Desktop Protocol (RDP) is a network communication protocol developed by Microsoft that allows us to connect to and control a computer from another location over a network or the internet. It provides a graphical interface so we can view the remote system’s desktop and use its applications as if we were physically present. RDP is commonly used to support remote working, technical support, and the management of servers and workstations without requiring physical access.

By default, RDP access is typically restricted to members of the local [**Administrators**](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#administrators) group and users who are added to the [**Remote Desktop Users**](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#remote-desktop-users) group on the system.

## Connect

We can check for RDP access over a network from a Linux host with  [`nxc`](https://github.com/Pennyw0rth/NetExec):

```bash
# Access check
nxc rdp 10.120.220.0/24 -u x7331 -p 'P@ssword123!' -d batman.local
```

Once we have a target host, we can directly connect using tools like [`xfreerdp`](https://linux.die.net/man/1/xfreerdp) and [`remmina`](https://github.com/FreeRDP/Remmina).

{% hint style="info" %}
`CTRL+ALT+ENTER` toggles the fulll screen with `xfreerdp`.
{% endhint %}

{% code overflow="wrap" %}
```bash
# Connect
xfreerdp /u:x7331 /p:'P@assword123!' /d:batman.local /v:10.120.220.10 +drives /clipboard < /dynamic-resolution /f | /smart-sizing >

# Share the local_dir file (must exist in pwd) as a share in RDP
xfreerdp /u:x7331 /p:'P@assword123!' /v:10.120.220.10 /drive:local_dir,share

# For slow connections
xfreerdp /u:x7331 /p:'P@assword123!' /v:10.120.220.10 /dynamic-resolution /drive:.,linux /bpp:8 /compression -themes -wallpaper /clipboard /audio-mode:0 /auto-reconnect -glyph-cache

# Clear cert cache
rm ~/.config/freerdp/known_hosts

# Launch remmina
remmina
```
{% endcode %}

From a Windows host we can use [`mstsc`](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/mstsc) (Microsoft Terminal Services Client):

```shell
# Launch RDP client
mstsc.exe
```

## Attacks

### Connection Files

Check for connection details within `.rdp` files.

### Password Spraying

We can perform a password spray attack with `nxc` or [`hydra`](https://github.com/vanhauser-thc/thc-hydra).

```bash
nxc rdp 192.168.221.202 -u rdp_users -p 'SuperS3cure1337#' -d batman.local

hydra -L rdp_users -p 'SuperS3cure1337#' rdp://192.168.221.202:3389
```

## Lateral Movement

### Restricted Admin Mode

Restricted Admin Mode is a security feature introduced by Microsoft to reduce the risk of credential theft during Remote Desktop Protocol (RDP) sessions. Under normal circumstances, when we connect to a remote system using RDP, the logon is treated as an interactive session. This means reusable authentication material such as NTLM hashes or Kerberos tickets may be stored in memory on the target system. If that system is compromised, attackers can extract these credentials and use them to move laterally within the network.

Restricted Admin Mode changes this behaviour by performing a network logon instead of an interactive logon. As a result, full credentials are not cached on the remote host. This helps protect administrative accounts from credential harvesting techniques such as memory scraping. The feature is therefore designed primarily as a defensive control to protect privileged users who frequently access multiple systems.

However, this protection introduces an important trade-off. Because the remote system does not need to obtain reusable credentials, authentication can occur using only NTLM hashes or Kerberos tickets. This means that attackers who already possess a stolen hash or ticket can authenticate to remote systems without knowing the user’s password. As a result, techniques such as Pass-the-Hash and Pass-the-Ticket can be used for lateral movement over RDP when Restricted Admin Mode is enabled.

This mode is typically limited to accounts with administrative privileges, such as local administrators or domain administrators, because the remote system uses the existing security context rather than creating a full credential session. In domain environments, members of the Domain Admins group often inherit local administrator rights on domain-joined systems, allowing them to use this feature unless it has been restricted through policy.

Tools such as SharpRDP demonstrate how attackers can leverage RDP authentication for stealthy remote command execution. Rather than opening a visible desktop session, these tools establish an authenticated RDP connection in the background and execute commands remotely. This approach enables lateral movement while reducing the likelihood of detection compared to traditional graphical RDP usage.

Overall, the key takeaway is that Restricted Admin Mode reduces credential exposure but does not prevent lateral movement. Instead, it shifts the risk by making stolen hashes and Kerberos tickets more valuable to attackers, particularly in environments where privileged accounts are widely used.

***

#### Interactive vs Network Logon Differences

| Feature                    | Interactive Logon                                        | Network Logon (Restricted Admin)                                  |
| -------------------------- | -------------------------------------------------------- | ----------------------------------------------------------------- |
| Credential handling        | Full credentials are provided to the remote system       | No reusable credentials are stored                                |
| Credential caching         | NTLM hashes and Kerberos tickets may be cached in memory | Credentials are not cached on the remote host                     |
| Risk of credential theft   | Higher if the system is compromised                      | Reduced risk of credential exposure                               |
| Authentication requirement | Requires password or full credentials                    | Can authenticate using NTLM hashes or Kerberos tickets            |
| Typical use case           | Standard RDP, console logon                              | Restricted Admin Mode and certain remote authentication scenarios |
| Security trade-off         | Greater usability but higher credential exposure         | Improved protection but enables hash-based authentication         |

#### Detection Considerations (Offensive Perspective)

From an offensive security perspective, Restricted Admin Mode and RDP lateral movement still generate useful artefacts that defenders can monitor. Successful RDP authentication is typically logged in Windows Security logs as **Event ID 4624**. A key indicator is the **logon type**: normal RDP sessions appear as **Type 10 (RemoteInteractive)**, whereas Restricted Admin Mode sessions appear as **Type 3 (Network)**. This difference can alert defenders to potential hash- or ticket-based authentication over RDP.

Authentication activity is also visible through **NTLM and Kerberos events**. NTLM usage (for example during Pass-the-Hash) can generate **Event ID 4776**, while Kerberos ticket activity (relevant to Pass-the-Ticket) appears in events such as **4769**. Unusual administrative authentication patterns, especially across multiple hosts, are often used to detect lateral movement.

Command-line monitoring can reveal suspicious use of RDP clients, such as `mstsc.exe /restrictedadmin`. Even non-graphical tools such as SharpRDP still create authentication and session logs, and may leave traces in artefacts like the **RunMRU registry key**. Cleaning or minimising these traces is therefore important during operations.

Network monitoring is another detection layer. Internal RDP traffic over TCP 3389, particularly between workstations or from lower-trust systems to privileged servers, is commonly analysed for lateral movement behaviour. Rapid or repeated connections from a single account are also strong indicators.

Overall, while Restricted Admin Mode reduces credential exposure, it does not reduce visibility. Authentication logs, endpoint telemetry, and network patterns remain the primary detection surface for RDP-based lateral movement.
