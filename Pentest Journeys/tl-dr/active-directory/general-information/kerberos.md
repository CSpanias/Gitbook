---
layout:
  width: default
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
  metadata:
    visible: true
  tags:
    visible: true
---

# Kerberos

## Overview

{% hint style="warning" %}
If a service is accessed using an IP address instead of a hostname, Kerberos cannot be used and NTLM is forced, often causing authentication to fail if NTLM is not supported or allowed.
{% endhint %}

Kerberos is the default authentication protocol (TCP port 88) in modern Active Directory (AD) environments, replacing NTLM since Windows Server 2000. It operates on a ticket-based model and uses a centralized authority, the Key Distribution Center (KDC). The Domain Controller (DC) acts as the KDC within an AD environment.

The core security-related strengths of Kerberos are:

* Users only need to prove their identity once. Thus, sensitive information, such as passwords, is not continually transmitted across the network, which significantly lowers the risk of interception.&#x20;
* Uses time-limited, service-specific, and highly-protected tickets. As a result, even if a ticket is compromised, its limited validity window and scope helps minimise potential impact.

## Simplified Process

The Kerberos authentication process conists of three entities: client, service, and KDC. It also has three main phases: Authentication Service (AS), Ticket Granting Service (TGS), and Application Request (AP). The Kerberos process can be imagined as the process of checking into a hotel and subsequently accessing its various services.

1. AS phase → When a guest (domain account) arrives at a hotel, they first report to reception (KDC) and present some form of official ID, for example, a passport (password). The reception (KDC) verify the guest’s ID and confirm their reservation details. Once this verification is successfully completed, the hotel issues a room key (TGT) which serves as proof that the hotel has authenticated the guest.

```
         Guest Arrives at Hotel (Domain account wants to access AD)
             |
             | Shows official ID (types their password)
             v
      +--------------------+
      | Reception (KDC)    |
      +--------------------+
             |
             | Verifies ID & confirms reservation (Matches the user's hash to its db)
             v
      +--------------------+
      | Room Key (TGT)     |
      +--------------------+
```

2. TGS phase → Let's say that the guest (domain account) wants to access the spa area (MSSQL service). This time, the guest only has to show their room key (TGT) to the reception (KDC), and not their official ID (password). Their room key (TGT) servers as a proof that they have already been verified. The reception (KDC) verify its validity and, if it is confirmed, issue a temporary spa pass (TGS).

```
          Guest (Account) wants spa access (MSSQL service)
              |
              | Shows Room Key (TGT) (instead of password (password))
              v
      +--------------------+
      | Reception (KDC)    |
      +--------------------+
              |
              | Reception (KDC) verifies Room Key (TGT)'s
              | validity & issues temporary Spa Pass (TGS)
              v
      +--------------------------+
      | Temporary Spa Pass (TGS) |
      +--------------------------+
              |
              | Shows temporary Spa Pass (TGS) 
              | at the spa entrance (MSSQL server)
              | & gets access to the spa area (MSSQL service)
```

3. AP phase → The guest (domain account) presents the temporary spa pass (TGS) at the spa entrance (MSSQL service). The latter verifies the authenticity and validity of the pass and, if the pass is valid, grants the guest spa access.

```
          Guest (User) presents Temporary Spa Pass (TGS)
              |
              v
      +---------------------+
      | Spa (MSSQL Service) |
      +---------------------+
              |
              | Spa staff (MSSQL service) verify the validity & 
              | authenticity of the Temporary Spa Pass (TGS)
              v
      +------------------------------------+
      | Spa Access Granted (MSSQL service) |
      +------------------------------------+
```

One key point is that the reception (KDC) treats any guest (domain account) presenting a valid temporary pass (TGS) as already having verified their identity.

## The Finer Details

The Kerberos authentication process works as follows:

1. **User Login (AS-REQ)**\
   When a user logs in, their machine sends an Authentication Service Request (AS-REQ) to the DC (KDC). This request includes a timestamp encrypted using a key derived from the user's password.
2. **KDC Response (AS-REP)**\
   The KDC retrieves the user’s password hash from `ntds.dit` and attempts to decrypt the timestamp. If successful and the timestamp is valid (a duplicate timestamp may indicate a replay attack), the KDC replies with an Authentication Service Reply (AS-REP). This contains a session key (encrypted with the user’s password hash) and a Ticket Granting Ticket (TGT), which is encrypted with the `krbtgt` account’s hash (this is known only to the KDC). The client can decrypt the session key and stores the TGT, which is typically valid for 10 hours and renewable.
3. **Service Request (TGS-REQ)**\
   When the user tries to access a service, the client sends a Ticket Granting Service Request (TGS-REQ) to the KDC. It includes the username, the encrypted TGT, a timestamp encrypted with the session key, and the name of the requested service.
4. **KDC Issues Service Ticket (TGS-REP)**\
   The KDC validates the TGT, checks the timestamp, and ensures the username and IP address match. If everything checks out, it sends a Ticket Granting Service Reply (TGS-REP), which includes a new session key (shared between client and service) and a service ticket encrypted with the service account’s password hash.
5. **Client to Service (AP-REQ)**\
   The client sends an Application Request (AP-REQ) to the service, containing the service ticket, the client’s username, and a timestamp encrypted with the new session key.
6. **Service Validates and Grants Access**\
   The service decrypts the ticket using its own password hash, extracts the session key and username, and verifies the timestamp. If valid, it checks group membership information from the ticket and grants access accordingly.

<div align="left"><figure><img src="../../../.gitbook/assets/kerberos_process.png" alt="" width="563"><figcaption><p>The Kerberos authentication process (image taken from <a href="https://www.optiv.com/insights/source-zero/blog/kerberos-domains-achilles-heel">here</a>).</p></figcaption></figure></div>

## Kerberos Attacks

### Ticket Request (Roasting) Attacks

{% hint style="info" %}
Practical implementation of [AS-REPRoasting](../attacks/as-reproasting.md) and [Kerberoasting](../attacks/kerberoasting.md).
{% endhint %}

Both TGTs and TGSs in Kerberos can be targeted by attackers:

* AS-REP Roasting occurs when an attacker requests a TGT for a user account that has pre-authentication disabled. In this case, the KDC responds with an AS-REP containing data derived from the user’s password, which can then be subjected to offline brute-force or dictionary attacks to recover the credential.
* Kerberoasting involves an attacker who already possesses a valid TGT requesting a TGS for a specific service. The KDC returns a TGS-REP encrypted with the service account’s password hash, allowing the attacker to perform offline cracking to obtain the service account credentials.

### Ticket Forging Attacks

{% hint style="info" %}
Practical implementation of the [Golden](../persistence/golden-ticket.md) and [Silver](../persistence/silver-ticket.md) ticket attack.
{% endhint %}

Ticket forging attacks occur when the encryption keys protecting Kerberos tickets are compromised:

* TGTs are encrypted using the KDC's secret key. If this key is compromised, an attacker can forge TGTs (Golden Tickets) which allow them to impersonate any user and obtain unrestricted access across the domain.
* TGSs are encrypted with the target service account’s key. If this key is exposed, an attacker can generate forged service tickets (Silver Tickets), which grant unauthorised access to the specific service associated with that account.

### Delegation Attacks

{% hint style="info" %}
Practical implementation of [delegation](../attacks/delegations.md) attacks.
{% endhint %}

Delegation attacks exploit Kerberos delegation, a feature that allows a service to impersonate a user when accessing other resources on their behalf. When delegation is misconfigured or overly permissive, attackers can abuse it to escalate privileges and move laterally across multiple services within the domain.

### Password Spray Attacks

Password spraying attacks are based on the KDC’s responses to authentication requests in Kerberos. By requesting a TGT for specific usernames, an attacker can sometimes determine whether an account exists. They can then try a small number of common passwords across many users, rather than multiple attempts against a single account which avoids account lockouts while increasing the chances of identifying weak or reused credentials.
