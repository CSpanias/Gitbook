# aws

[`aws-cli`](https://github.com/aws/aws-cli) is Amazonâ€™s official command-line tool for interacting with AWS services. Unlike most automation tools, it can resolve both S3 API and website endpoints, allowing object enumeration in scenarios where API listing is blocked but website listings are exposed.

## Usage

{% tabs %}
{% tab title="Creds" %}
```bash
$ aws configure --profile cloudgoat
AWS Access Key ID [None]: AKIAVUZR3DVG2LOEV4S2
AWS Secret Access Key [None]: Ew...<REDACTED>...zn
Default region name [None]: us-east-1
Default output format [None]: json

# If output opens within a pager, add this to the ~/.zhrc
$ export AWS_PAGER=""
```
{% endtab %}

{% tab title="Users" %}
```bash
# Whoami of AWS
aws sts get-caller-identity --profile cloudgoat

# A more detailed whoami
aws iam get-user --profile iam_enum

# List groups memberships
aws iam list-groups-for-user --user-name [user-name]

# List IAM users
aws iam list-users

# List attached managed policies
aws iam list-attached-user-policies --user-name [user-name]

# List inline policies
aws iam list-user-policies --user-name [user-name]

# List inline policy details
aws iam get-user-policy --user-name [user-name] --policy-name [policy-name]
```

Each AWS account can have two different access keys. If an account has only one, a backdoor can be created, via a second access key, in order to compromise it.

```bash
aws iam list-access-keys --profile iam_enum
```
{% endtab %}

{% tab title="Groups" %}
{% code overflow="wrap" %}
```bash
# List all groups
aws iam list-groups --profile iam_enum

# List group members
aws iam get-group --group-name introduction-to-aws-iam-enumeration-1757146849172-Developers --profile iam_enum

# List group policies
aws iam list-attached-group-policies --group-name [group-name]

# List inline group policy details
aws iam get-group-policy --group-name [group-name] --policy-name [policy-name]
```
{% endcode %}
{% endtab %}

{% tab title="Roles" %}
AWS roles are similar to users but have no long-term credential, i.e. they expire after a defined period of time. Instead, they have temporary ones via role assumption.

```bash
# List all roles
aws iam list-roles | grep -i "rolename"

# Details about a specific role
aws iam list-roles --query "Roles[?RoleName=='SupportRole']" --profile iam_enum

# List role details (trust policy)
aws iam get-role --role-name [role-name]

# List attached policies
aws iam list-attached-role-policies --role-name [role-name]

# List inline policies
aws iam list-role-policies --role-name [role-name]

# List inline role policy details
aws iam get-role-policy --role-name [role-name] --policy-name [policy-name]
```
{% endtab %}

{% tab title="Policies" %}
{% code overflow="wrap" %}
```bash
# Get a managed policy document (by ARN or name)
aws iam get-policy --policy-arn [policy-arn] aws iam get-policy-version --policy-arn [policy-arn] --version-id [version-id]

# Dump all IAM permissions (users, roles, groups, policies). This can be used to build a full IAM permissions map. --filter can be added to target roles/users/groups specifically
aws iam get-account-authorization-details
```
{% endcode %}
{% endtab %}

{% tab title="Other" %}
{% code overflow="wrap" %}
```bash
# Enable tab autocompletion
echo -e '\nexport PATH=/usr/local/bin/:$PATH\nautoload bashcompinit && bashcompinit\nautoload -Uz compinit && compinit\ncomplete -C "/usr/local/bin/aws_completer" aws' >> ~/.zshrc
```
{% endcode %}
{% endtab %}
{% endtabs %}

{% tabs %}
{% tab title="S3 Buckets" %}
```bash
# List bucket's content
aws --endpoint=http://s3.thetoppers.htb s3 ls
aws --endpoint=http://s3.thetoppers.htb s3 ls s3://thetoppers.htb

# Upload a file
aws --endpoint=http://s3.thetoppers.htb s3 cp shell.php s3://thetoppers.htb
```
{% endtab %}
{% endtabs %}

## Resources

{% tabs %}
{% tab title="awscli" %}
{% embed url="https://github.com/aws/aws-cli" %}
{% endtab %}
{% endtabs %}
